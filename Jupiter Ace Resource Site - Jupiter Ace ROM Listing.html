<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- saved from url=(0044)http://www.jupiter-ace.co.uk/romlisting.html -->
<html lang="en"><!-- Created on: 04/29/2005 --><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">


	<title>Jupiter Ace Resource Site - Jupiter Ace ROM Listing</title>



<meta name="description" content="Jupiter Ace Resource site. Jupiter Ace ROM Listing ">

	<link rel="stylesheet" title="Jupiter Ace default style" type="text/css" href="./Jupiter Ace Resource Site - Jupiter Ace ROM Listing_files/JADefult_2018.css">
</head>
<body data-new-gr-c-s-check-loaded="14.1073.0" data-gr-ext-installed="">


 <script type="text/javascript" src="./Jupiter Ace Resource Site - Jupiter Ace ROM Listing_files/milonic_src.js"></script>

 <script type="text/javascript">
 <!--
 if(ns4)_d.write("<scr"+"ipt type=text/javascript src=mmenuns4.js><\/scr"+"ipt>");
 else _d.write("<scr"+"ipt type=text/javascript src=mmenudom.js><\/scr"+"ipt>");
 // -->
 </script><script type="text/javascript" src="./Jupiter Ace Resource Site - Jupiter Ace ROM Listing_files/mmenudom.js"></script>




 <div id="wrapper">
     <a href="https://www.jupiter-ace.co.uk/">
         <div id="header">
     </div>
     </a>

     <div id="menu">
         <script type="text/javascript" src="./Jupiter Ace Resource Site - Jupiter Ace ROM Listing_files/jupiter_menu_data.js"></script><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(0)" onselectstart="return 0" id="menu0" style="padding: 0px; z-index: 999; visibility: visible; position: relative; left: 0px; width: 900px;"><table class="milonictable" border="0" cellpadding="0" cellspacing="0" style="line-height:normal;padding:0px;" id="tbl0"><tbody><tr><td width="100" id="el0" onmouseover="h$(0,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(0)" name="mM1" onfocus="_iF0C(0)" href="http://www.jupiter-ace.co.uk/index.html" id="lnk0" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Home</a></td><td width="100" id="el1" onmouseover="h$(1,0,1)" style="height: 26px; background-image: url(&quot;whitex100.gif&quot;);"><a onclick="return $K(1)" name="mM1" onfocus="_iF0C(1)" href="http://www.jupiter-ace.co.uk/index_what_is.html" id="lnk1" style="border: none; background: transparent; display: block; color: black; font-family: Arial; font-weight: bold; font-style: normal; text-decoration: none; text-align: center;">What is ...</a></td><td width="100" id="el2" onmouseover="h$(2,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(2)" name="mM1" onfocus="_iF0C(2)" href="http://www.jupiter-ace.co.uk/ace_hardware.html" id="lnk2" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Hardware</a></td><td width="100" id="el3" onmouseover="h$(3,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(3)" name="mM1" onfocus="_iF0C(3)" href="http://www.jupiter-ace.co.uk/software_index.html" id="lnk3" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Software</a></td><td width="100" id="el4" onmouseover="h$(4,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(4)" name="mM1" onfocus="_iF0C(4)" href="http://www.jupiter-ace.co.uk/documents_index.html" id="lnk4" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Documents</a></td><td width="100" id="el5" onmouseover="h$(5,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a name="mM1" onfocus="_iF0C(5)" href="javascript:void(0);" id="lnk5" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Programming</a></td><td width="100" id="el6" onmouseover="h$(6,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(6)" name="mM1" onfocus="_iF0C(6)" href="http://www.jupiter-ace.co.uk/index_emulators.html" id="lnk6" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Emulators</a></td><td width="100" id="el7" onmouseover="h$(7,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(7)" name="mM1" onfocus="_iF0C(7)" href="http://www.jupiter-ace.co.uk/index_faqs.html" id="lnk7" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">FAQs</a></td><td width="100" id="el8" onmouseover="h$(8,0,1)" style="height:26px;background-image:url(whitex100.gif);;"><a onclick="return $K(8)" name="mM1" onfocus="_iF0C(8)" href="http://www.jupiter-ace.co.uk/links.html" id="lnk8" style="border:none;background:transparent;display:block;color:black;font-Family:Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:center">Links</a></td></tr></tbody></table> <a name="mM1" id="mmlink0" href="http://www.jupiter-ace.co.uk/index_what_is.html" onclick="return $K(this._itemRef)" onmouseover="_p1(this);_mot=$P(_mot)" style="outline: none; line-height: normal; background: transparent; text-decoration: none; height: 26px; width: 100px; overflow: hidden; position: absolute; visibility: hidden; z-index: 1; top: 0px; left: 100px;" target="_self" title=""></a></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(1)" onselectstart="return 0" id="menu1" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(2)" onselectstart="return 0" id="menu2" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(3)" onselectstart="return 0" id="menu3" style="padding: 0px; z-index: 999; visibility: hidden; position: absolute; top: -9999px; left: -9999px;"><table class="milonictable" border="0" cellpadding="0" cellspacing="0" style="line-height:normal;padding:0px;" width="192" id="tbl3"><tbody><tr id="pTR32"><td width="192" id="el32" onmouseover="h$(32,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(32)" name="mM1" onfocus="_iF0C(32)" href="http://www.jupiter-ace.co.uk/whatisforth.html" id="lnk32" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Forth</a></td></tr><tr id="pTR33"><td width="192" id="el33" onmouseover="h$(33,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(33)" name="mM1" onfocus="_iF0C(33)" href="http://www.jupiter-ace.co.uk/whatisanace.html" id="lnk33" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..A Jupiter ACE</a></td></tr><tr id="pTR34"><td width="192" id="el34" onmouseover="h$(34,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(34)" name="mM1" onfocus="_iF0C(34)" href="http://www.jupiter-ace.co.uk/ace4000.html" id="lnk34" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Jupiter Ace4000</a></td></tr><tr id="pTR35"><td width="192" id="el35" onmouseover="h$(35,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(35)" name="mM1" onfocus="_iF0C(35)" href="http://www.jupiter-ace.co.uk/jupiterace16.html" id="lnk35" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Jupiter ACE16+</a></td></tr><tr id="pTR36"><td width="192" id="el36" onmouseover="h$(36,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(36)" name="mM1" onfocus="_iF0C(36)" href="http://www.jupiter-ace.co.uk/jupiterace-tks.html" id="lnk36" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Turnkey System (TKS)</a></td></tr><tr id="pTR37"><td width="192" id="el37" onmouseover="h$(37,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(37)" name="mM1" onfocus="_iF0C(37)" href="http://www.jupiter-ace.co.uk/what_is_jupiter_cantab.html" id="lnk37" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Jupiter Cantab</a></td></tr><tr id="pTR38"><td width="192" id="el38" onmouseover="h$(38,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(38)" name="mM1" onfocus="_iF0C(38)" href="http://www.jupiter-ace.co.uk/mia.html" id="lnk38" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Boldfield Computing</a></td></tr><tr id="pTR39"><td width="192" id="el39" onmouseover="h$(39,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(39)" name="mM1" onfocus="_iF0C(39)" href="http://www.jupiter-ace.co.uk/what_is_minstrel.html" id="lnk39" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Minstrel 4th</a></td></tr><tr id="pTR40"><td width="192" id="el40" onmouseover="h$(40,0,1)" align="left" style=";padding:4px;background-image:url(tab_subred_bk.gif);;"><a onclick="return $K(40)" name="mM1" onfocus="_iF0C(40)" href="http://www.jupiter-ace.co.uk/what_is_jesterACE.html" id="lnk40" style="border:none;background:transparent;display:block;color:#ffffff;font-Family:Verdana, Tahoma, Arial;font-Weight:bold;font-style:normal;text-Decoration:none;;text-align:left">..Jester ACE</a></td></tr></tbody></table> <a name="mM1" id="mmlink3" href="http://www.jupiter-ace.co.uk/romlisting.html#" onclick="return $K(this._itemRef)" onmouseover="_p1(this);_mot=$P(_mot)" style="outline: none; line-height: normal; background: transparent; text-decoration: none; height: 1px; width: 1px; overflow: hidden; position: absolute; visibility: hidden;"></a></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(4)" onselectstart="return 0" id="menu4" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(5)" onselectstart="return 0" id="menu5" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:180px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(6)" onselectstart="return 0" id="menu6" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:195px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(7)" onselectstart="return 0" id="menu7" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:225px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(8)" onselectstart="return 0" id="menu8" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:235px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(9)" onselectstart="return 0" id="menu9" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:265px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(10)" onselectstart="return 0" id="menu10" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:275px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(11)" onselectstart="return 0" id="menu11" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:295px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(12)" onselectstart="return 0" id="menu12" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:265px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(13)" onselectstart="return 0" id="menu13" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:300px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(14)" onselectstart="return 0" id="menu14" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:290px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(15)" onselectstart="return 0" id="menu15" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:290px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(16)" onselectstart="return 0" id="menu16" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:340px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(17)" onselectstart="return 0" id="menu17" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:350px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(18)" onselectstart="return 0" id="menu18" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:380px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(19)" onselectstart="return 0" id="menu19" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:380px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(20)" onselectstart="return 0" id="menu20" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:410px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(21)" onselectstart="return 0" id="menu21" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:420px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(22)" onselectstart="return 0" id="menu22" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:370px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(23)" onselectstart="return 0" id="menu23" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:350px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(24)" onselectstart="return 0" id="menu24" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:400px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(25)" onselectstart="return 0" id="menu25" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:420px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(26)" onselectstart="return 0" id="menu26" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:380px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(27)" onselectstart="return 0" id="menu27" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:360px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(28)" onselectstart="return 0" id="menu28" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(29)" onselectstart="return 0" id="menu29" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(30)" onselectstart="return 0" id="menu30" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div><div class="mmenucontainer" onmouseout="$I()" onmouseover="$jJ(31)" onselectstart="return 0" id="menu31" style="padding:0px;;z-index:999;visibility:hidden;position:absolute;top:171px;;"></div>
     </div>

    <div id="bar">
        <a class="bar" href="http://www.jupiter-ace.co.uk/index.html">Home</a> &gt;
        <a class="bar" href="http://www.jupiter-ace.co.uk/index.html" onclick="history.back();return false;">Previous Page</a>&nbsp;&gt;&nbsp;
        Disassembly of Jupiter ACE ROM

        <div style="float: right">
            <form action="http://www.jupiter-ace.co.uk/search/search.php" method="get">Archive Search
                <input type="text" name="query_t" size="24" value="" style="font-size: 10px;">
                <input type="submit" value="Go" name="input" style="font-size: 10px;">&nbsp;
                <input type="hidden" name="search" value="1">
            </form>
        </div>
    </div>


      <div class="main">
        <div id="acepic"></div>
        <div class="line"></div>

 <h3 style="text-align: left; padding-bottom: 10px;">Disassembly of Jupiter ACE ROM</h3>

<table class="mtable" cellpadding="4">

		<tbody><tr>
			<td>
				<!-- ROM listing -->
   <p style="text-align: left">	Click <a class="nlink" href="http://www.jupiter-ace.co.uk/romlisting_german.html">here</a> to go to a German text Version<br> </p>
	<br><br>

<pre style=" text-align: left">[ thanks to Geoff Wearmouth ]
; Disassembly of the file "C:\ACE\JupiterAce.rom"
;
; CPU Type: Z80
;
; Created with dZ80 1.50
;
; on Monday, 21 of January 2002 at 07:11 PM
;
; last updated 02-NOV-2002
;
; Cross-assembles to an 8K ROM file.
;
; <font color="#9900FF">Note.</font> A Low-level Assembly Listing only.

#define DEFB    .BYTE
#define DEFW    .WORD
#define DEFM    .TEXT
#define EQU     .EQU
#define ORG     .ORG

        ORG     $0000

; -------------------
; THE <b><font color="#333388">'START'</font></b> RESTART
; -------------------

<a name="L0000"></a>L0000:  DI                              ; disable interrupts.
        LD      HL,$3C00                ; start of 'User' RAM
        LD      A,$FC                   ; a test byte and 1K masking byte.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0028">L0028</a>                   ; forward to continue at Part 2.

; -------------------
; THE <b><font color="#333388">'PRINT'</font></b> RESTART
; -------------------

<a name="L0008"></a>L0008:  EXX                             ; preserve main registers.
        BIT     3,(IX+$3E)              ; test FLAGS for print destination.
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L03EE">L03EE</a>                   ; forward to

; ---------------------------
; THE <b><font color="#333388">'STACK WORD DE'</font></b> RESTART
; ---------------------------

<a name="L0010"></a>L0010:  LD      HL,($3C3B)              ; SPARE
        LD      (HL),E
        INC     HL
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L085F">L085F</a>                   ;

; -------------------------
; THE <b><font color="#333388">'POP WORD DE'</font></b> RESTART
; -------------------------


<a name="L0018"></a>L0018:  LD      HL,($3C3B)              ; SPARE
        DEC     HL
        LD      D,(HL)
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0859">L0859</a>                   ;

; -------------------
; THE <b><font color="#333388">'ERROR'</font></b> RESTART
; -------------------

<a name="L0020"></a>L0020:  POP     HL
        LD      A,(HL)
        LD      ($3C3D),A               ; ERR_NO
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L00AD">L00AD</a>                   ;

; ------------------------------------
; THE <b><font color="#333388">'INITIALIZATION ROUTINE'</font></b> Part 2.
; ------------------------------------

<a name="L0028"></a>L0028:  INC     H                       ; increase high byte
        LD      (HL),A                  ; insert A value
        CP      (HL)                    ; compare to expected
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0028">L0028</a>                 ; loop back while RAM is populated.

        AND     H                       ; limit to nearest 1K segment.
        LD      H,A                     ; place back in H.
        LD      ($3C18),HL              ; set system variable RAMTOP.
        LD      SP,HL                   ; initialize the stack pointer.

; the Z80 instructions CALL, PUSH and POP can now be used.

        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L010D">L010D</a>                ; prepare to copy the system variables
                                        ; initial state from ROM.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L003B">L003B</a>                   ; skip past the fixed-position restart.

; -----------------------
; THE <b><font color="#333388">'INTERRUPT'</font></b> RESTART
; -----------------------

<a name="L0038"></a>L0038:  JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L013A">L013A</a>                   ; jump to somewhere more convenient.

;------------------------------------------------------------------------------
;
; MEMORY MAP
;
; $0000 +======================================================+
;       |                                                      |
;       |                   ROM 8K                             |
;       |                                     v $2300          |
; $2000 +======================================================+ - - - - - -
;       |       copy of $2400                 |0|&lt;  cassette  &gt;|
; $2400 +-------------------------------------+-+--------------+
;       |       VIDEO MEMORY 768 bytes        |0| PAD 254 bytes| 1K RAM
; $2800 +-------------------------------------+-+--------------+
;       |       copy of $2c00                 ^ $2700          |
; $2C00 +------------------------------------------------------+
;       |       CHARACTER SET - Write-Only                     | 1K RAM
; $3000 +------------------------------------------------------+
;       |       copy of $3c00                                  |
; $3400 +------------------------------------------------------+
;       |       copy of $3c00                                  |
; $3800 +------------------------------------------------------+
;       |       copy of $3c00                                  |
; $3C00 +-------+----------------------------------------------+
;       |SYSVARS| DICT {12} DATA STACK -&gt;         &lt;- RET STACK | 1K RAM
; $4000 +=======+==============================================+ - - - - - -
;       |                                                      |
;                       48K AVAILABLE FOR EXPANSION.
;       |                                                      |
; $FFFF +======================================================+
;
; The Ace had an 8K ROM and was sold with 3K of RAM each byte of which had
; at least two addresses and sometimes four addresses so the mapping of the
; 3K of RAM was as above.
; The 768 bytes of video memory is accessed by the ROM using addresses
; $2400 - $26FF. This gives priority to the video circuitry which also needs
; this information to build the TV picture. The byte at $2700 is set to zero
; so that it is easy for the ROM to detect when it is at the end of the screen.
; The 254 bytes remaining are the PAD - the workspace used by FORTH.
; This same area is used by the tape recorder routines to assemble the tape
; header information but since, for accurate tape timing, the FORTH ROM needs
; priority over the video circuitry, then the ROM uses addresses $2301 - $23FF.
;
; Similarly the Character Set is written to by the ROM (and User) at the 1K
; section starting at $2C00. The video circuitry accesses this using addresses
; $2800 - $2BFF to build the TV picture. It is not possible for the ROM or User
; to read back the information from either address so this precludes the saving
; of character sets and writing a driver for a device like the ZX Printer.
;
; The final 1K or RAM has four addresses although it is normal to use addresses
; $3C00 - $3FFF. The first sixty three bytes are the System Variables which
; hold information like the number BASE and CONTEXT, and even the plotting
; coordinates should the user wish to develop a word like DRAW to draw lines.
;
; Then comes the User Dictionary, the first word of which is "FORTH" which links
; to the Dictionary in ROM. Next a gap of 12 bytes to allow for Data Stack
; underflow and then the Data Stack itself which grows upwards.
; At the opposite end of free memory is the Return Stack (machine stack) which
; grows downwards.

; ------------------------------------
; THE <b><font color="#333388">'INITIALIZATION ROUTINE'</font></b> Part 3.
; ------------------------------------

<a name="L003B"></a>L003B:  LD      DE,$3C24                ; destination system variable L_HALF
        LD      BC,$002D                ; number of bytes.
        LDIR                            ; copy initial state from ROM to RAM.

        LD      IX,$3C00                ; set IX to index the system variables.
        LD      IY,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04C8">L04C8</a>                ; set IY to the SLOW return address.

<a name="L004B"></a>L004B:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A24">L0A24</a>                   ; routine CLS.

        XOR     A                       ; clear accumulator.

        LD      ($2700),A               ; make location after screen zero.

; There are 128 bit-mapped 8x8 characters.
; Define the 8 Battenberg graphics ($10 to $17) from low byte of address.
; This routine also sets the other characters $00 to $0F and $18 to $1F
; to copies of this range. The inverse form of character $17 is used as the
; normal cursor - character $97.

<a name="L0052"></a>L0052:  LD      HL,$2C00                ; point to the start of the 1K write-
                                        ; only Character Set RAM.

<a name="L0055"></a>L0055:  LD      A,L                     ; set A to low byte of address
        AND     $BF                     ; AND %10111111
        RRCA                            ; rotate
        RRCA                            ; three times
        RRCA                            ; to test bit 2
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L005F">L005F</a>                ; forward if not set.

        RRCA                            ; else rotate
        RRCA                            ; twice more.

<a name="L005F"></a>L005F:  RRCA                            ; set carry from bit (3) or (6)

        LD      B,A

        SBC     A,A                     ; $00 or $FF
        RR      B
        LD      B,A
        SBC     A,A
        XOR     B
        AND     $F0
        XOR     B
        LD      (HL),A                  ; insert the byte.
        INC     L                       ; increment low byte of address
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0055">L0055</a>                ; loop back until the first 256 bytes
                                        ; have been filled with 32 repeating
                                        ; characters.

; Now copy the bit patterns at the end of this ROM to the last 768 bytes of
; the Character RAM, filling in some blank bytes omitted to save ROM space.
; This process starts at high memory and works downwards.

<a name="L006E"></a>L006E:  LD      DE,$2FFF                ; top of destination.
        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1FFB">L1FFB</a>                ; end of copyright character.
        LD      BC,$0008                ; 8 characters

        LDDR                            ; copy the  ©  character

        EX      DE,HL                   ; switch pointers.

        LD      A,$5F                   ; set character counter to ninety five.
                                        ; i.e. %0101 1111
                                        ; bit 5 shows which 32-character sector
                                        ; we are in.

; enter a loop for the remaining characters supplying zero bytes as required.

<a name="L007C"></a>L007C:  LD      C,$07                   ; set byte counter to seven.

        BIT     5,A                     ; test bit 5 of the counter.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0085">L0085</a>                 ; forward if not in middle section
                                        ; which includes "[A-Z]"

        LD      (HL),B                  ; else insert a zero byte.
        DEC     HL                      ; decrement the destination address.
        DEC     C                       ; and the byte counter.

<a name="L0085"></a>L0085:  EX      DE,HL                   ; switch pointers.

        LDDR                            ; copy the 5 or 6 characters.

        EX      DE,HL                   ; switch pointers.

        LD      (HL),B                  ; always insert the blank top byte.
        DEC     HL                      ; decrement the address.

        DEC     A                       ; decrement the character counter.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L007C">L007C</a>                ; back for all 95 characters.

        IM      1                       ; Select Interrupt Mode 1

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L009B">L009B</a>                   ; and then jump into the code for the
                                        ; QUIT word.


; ---------------
; THE <b><font color="#333388">'QUIT'</font></b> WORD
; ---------------
; <font color="#CC00FF">(  --  )</font>
; Clears return stack, empties input buffer and returns control to the
; keyboard.

<a name="L0092"></a>L0092:  DEFM    "QUI"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

<a name="L0096"></a>L0096:  DEFW    $0000                   ; <b><font color="#3030dd">'link field'</font></b> - end of linked list.

<a name="L0098"></a>L0098:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0099"></a>L0099:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L009B">L009B</a>                   ; <b><font color="#3030dd">'code field'</font></b>
                                        ; address of machine code for routine.

; ---

<a name="L009B"></a>L009B:  LD      SP,($3C18)              ; set stack-pointer to RAMTOP.

        EI                              ; Enable Interrupts.

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04F2">L04F2</a>                   ; jump forward to the main execution
                                        ; loop.

; ----------------
; THE <b><font color="#333388">'ABORT'</font></b> WORD
; ----------------
; Clears the data and return stacks, deletes any incomplete definition
; left in the dictionary, prints 'ERROR' and the byte from address $3C3D
; if the byte is non-negative, empties the input buffer, and returns
; control to the keyboard.


<a name="L00A3"></a>L00A3:  DEFM    "ABOR"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0098">L0098</a>                   ; <b><font color="#3030dd">'link field'</font></b> to previous word QUIT.

<a name="L00AA"></a>L00AA:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L00AB"></a>L00AB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L00AD">L00AD</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

; -&gt; also continuation of the error restart.

<a name="L00AD"></a>L00AD:  PUSH    IY                      ; preserve current IY value slow/fast.

        LD      IY,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                ; set IY to FAST
                                        ; now empty the data stack
        LD      HL,($3C37)              ; STKBOT
        LD      ($3C3B),HL              ; SPARE
        LD      HL,$3C3E                ; address FLAGS
        LD      A,(HL)                  ; fetch status from FLAGS.
        AND     $B3                     ; AND %10110011
                                        ; reset bit 2 - show definition complete
                                        ; reset bit 3 - output to screen.
                                        ; reset bit 6 - show in interpreter mode
        BIT     2,(HL)                  ; was there an incomplete definition ?
        LD      (HL),A                  ; update FLAGS
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L00DE">L00DE</a>                 ; forward if no incomplete word.

<a name="L00C4"></a>L00C4:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; do forth

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0490">L0490</a>                   ; dict          address of sv DICT
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @             value of sv DICT (d).
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data      d.         length field
        DEFB    $05                     ; five          d, 5.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DD2">L0DD2</a>                   ; +             d+5.       code field
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup           d+5, d+5.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1610">L1610</a>                   ; prvcur        d+5.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15B5">L15B5</a>                   ; namefield     n.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stackwrd      n.
        DEFW    $3C37                   ; (stkbot)      n, stkbot.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !             .
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.    .

; at this stage the system variable STKBOT holds the address of the
; obsolete name field and the system variable CURRENT points to the
; address of the previous complete word - obtained from the old link field.

<a name="L00DE"></a>L00DE:  BIT     7,(IX+$3D)              ; test ERR_NO for normal value 255.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L00FF">L00FF</a>                ; set-min then main-loop if OK.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1808">L1808</a>                   ; else pr-inline

; ---

<a name="L00E7"></a>L00E7:  DEFM    "ERRO"                  ; the message "ERROR" with the last
        DEFB    'R' + $80               ; character inverted.

; ---

<a name="L00EC"></a>L00EC:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    $3C3D                   ; -&gt; system variable ERR_NO
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@            - fetch content byte
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09B3">L09B3</a>                   ; .             - print it
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A95">L0A95</a>                   ; CR
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        LD      (IX+$3D),$FF            ; set ERR_NO to 'No Error'

<a name="L00FF"></a>L00FF:  LD      HL,($3C37)              ; fetch STKBOT
        LD      BC,$000C                ; allow twelve bytes for stack underflow
        ADD     HL,BC                   ; add the extra
        LD      ($3C3B),HL              ; set SPARE
        POP     IY                      ; restore previous state of IY

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L009B">L009B</a>                   ; rejoin main loop

; -------------------------
; THE <b><font color="#333388">'DEFAULT ENVIRONMENT'</font></b>
; -------------------------
; This is the default environment that is copied from ROM to RAM as part of
; the initialization process. This also contains the FORTH word FORTH definition

<a name="L010D"></a>L010D:  DEFW    $26E0                   ; L_HALF

        DEFB    $00                     ; KEYCOD
        DEFB    $00                     ; KEYCNT copy the 32 bytes.
        DEFB    $00                     ; STATIN
        DEFW    $0000                   ; EXWRCH
        DEFB    $00                     ; FRAMES
        DEFB    $00                     ; FRAMES
        DEFB    $00                     ; FRAMES
        DEFB    $00                     ; FRAMES
        DEFB    $00                     ; XCOORD
        DEFB    $00                     ; YCOORD
        DEFW    $3C4C                   ; CURRENT
        DEFW    $3C4C                   ; CONTEXT
        DEFW    $3C4F                   ; VOCLNK
        DEFW    $3C51                   ; STKBOT
        DEFW    $3C45                   ; DICT
        DEFW    $3C5D                   ; SPARE
        DEFB    $FF                     ; ERR_NO
        DEFB    $00                     ; FLAGS
        DEFB    $0A                     ; BASE

; FORTH

        DEFM    "FORT"                  ; The 'name field'
        DEFB    'H' + $80               ; FORTH


        DEFW    $0000                   ; length field - filled when next word
                                        ; is defined.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1FFF">L1FFF</a>                   ; link field copied to $3C49.
        DEFB    $05                     ; name length field
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11B5">L11B5</a>                   ; code field
        DEFW    $3C49                   ; address of parameters
        DEFB    $00                     ; VOCLNK                        [$3C4F]
        DEFB    $00                     ; - link to next vocabulary.
        DEFB    $00                     ; last byte to be copied.    to [$3C51]

; -----------------------------------------------
; THE <b><font color="#333388">'CONTINUATION OF THE Z80 INTERRUPT'</font></b> ROUTINE
; -----------------------------------------------
; The destination of the jump at $0038.
; Begin by saving both accumulators and the 3 main registers.

<a name="L013A"></a>L013A:  PUSH    AF                      ; preserve both accumulators
        EX      AF,AF'                  ;
        PUSH    AF                      ;

        PUSH    BC                      ; and main registers.
        PUSH    DE                      ;
        PUSH    HL                      ;

; Now wait for 62 * 12 clock cycles. ( To avoid flicker perhaps? ).

        LD      B,$3E                   ; delay counter.

<a name="L0142"></a>L0142:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0142">L0142</a>                   ; self loop for delay

; Increment the 4-byte frames counter for use as a system clock.

        LD      HL,$3C2B                ; FRAMES1

<a name="L0147"></a>L0147:  INC     (HL)                    ; increment timer.
        INC     HL                      ; next significant byte of four.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0147">L0147</a>                 ; loop back if the value wrapped back
                                        ; to zero.

; <font color="#9900FF">Note.</font> as manual points out, there is no actual check on this and if
; you leave your Ace switched on for 2.75 years it will advance to the
; following system variables although it takes several millennia to advance
; through the screen coordinates.

; Now read the keyboard and if no new key then exit after restoring the
; preserved registers.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0310">L0310</a>                   ; routine KEYBOARD.

        LD      HL,$3C28                ; address system variable STATIN

        BIT     0,(HL)                  ; new key?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0176">L0176</a>                 ; forward if not to RESTORE/EXIT

        AND     A                       ; zero key code ?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0176">L0176</a>                 ; forward if so to EXIT.

        CP      $20                     ; compare to SPACE
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0170">L0170</a>                 ; forward if less as an Editing Key.

        BIT     1,(HL)                  ; CAPS shift?
        CALL    NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0807">L0807</a>                ; routine TO_UPPER

        BIT     2,(HL)                  ; GRAPHICS mode?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0167">L0167</a>                 ; skip forward if not

        AND     $9F                     ; convert to one of 8 mosaic characters

<a name="L0167"></a>L0167:  BIT     3,(HL)                  ; INVERSE mode?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L016D">L016D</a>                 ; forward if not.

        OR      $80                     ; set bit 7 to make character inverse.

<a name="L016D"></a>L016D:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0196">L0196</a>                   ; routine pr_buffer

<a name="L0170"></a>L0170:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L01E6">L01E6</a>                   ; routine EDIT_KEY
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0282">L0282</a>                   ; routine pr_cursor

; Before exiting restore the preserved registers.

<a name="L0176"></a>L0176:  POP     HL                      ;
        POP     DE                      ;
        POP     BC                      ;
        POP     AF                      ;
        EX      AF,AF'                  ;
        POP     AF                      ;

        EI                              ; Enable Interrupts

        RET                             ; return.

; -----------------------------------
; THE <b><font color="#333388">'PRINT to LOWER SCREEN'</font></b> ROUTINE
; -----------------------------------

<a name="L017E"></a>L017E:  CP      $0D                     ; carriage return?
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0196">L0196</a>                ; forward if not

; a carriage return to input buffer i.e. lower screen memory.

        LD      HL,$2700                ; set pointer to location after the
                                        ; input buffer.

        LD      ($3C22),HL              ; set ENDBUF - end of logical line
        LD      ($3C20),HL              ; set the CURSOR

        XOR     A                       ; clear A

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0198">L0198</a>                   ; print character zero.

        LD      HL,$26E0                ; left hand position of bottom line.
        LD      ($3C1E),HL              ; set INSCRN to this position.
        RET                             ; return.

; ---------------------------------------
; THE <b><font color="#333388">'PRINT CHARACTER TO BUFFER'</font></b> ROUTINE
; ---------------------------------------

<a name="L0196"></a>L0196:  AND     A                       ; check for zero character
        RET     Z                       ; return if so.

; =&gt; also called from previous routine only to print a zero skipping above test.

<a name="L0198"></a>L0198:  EX      AF,AF'                  ; preserve the output character.

        LD      HL,($3C22)              ; fetch ENDBUF end of logical line
        LD      A,(HL)                  ; fetch character from position
        AND     A                       ; is it zero ?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L01A6">L01A6</a>                 ; skip forward if so.

; else lower screen scrolling is required.

        LD      DE,$D900                ; $0000 - $2700
        ADD     HL,DE                   ; test if position is within video RAM
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L01CE">L01CE</a>                ; forward if &lt; $26FF

; now check that the limit of 22 lines in lower screen is not exceeded.

<a name="L01A6"></a>L01A6:  LD      DE,($3C24)              ; fetch start of buffer from L_HALF
        LD      HL,$DBA0                ; $0000 - $2460
        ADD     HL,DE                   ;
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L01E4">L01E4</a>                ; forward to exit if buffer full.


        LD      HL,($3C1C)              ; fetch position SCRPOS for upper screen
        LD      BC,$0020                ; allow an extra 32 characters - 1 line.
        ADD     HL,BC                   ;
        SBC     HL,DE                   ; subtract the start of input buffer
        PUSH    DE                      ; and save the L_HALF value

        CALL    NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0421">L0421</a>                ; routine to scroll upper display.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02B0">L02B0</a>                   ; find zerobyte loc in HL

        POP     DE                      ; retrieve the L_HALF value

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L042F">L042F</a>                   ; routine scroll and blank

; The four system variables INSCRN, CURSOR, ENDBUF and L_HALF are each
; reduced by 32 bytes a screen line.

        LD      HL,$3C1E                ; address INSCRN the left-hand location
                                        ; of the current input line.

        LD      B,$04                   ; four system variables to update

<a name="L01C9"></a>L01C9:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0443">L0443</a>                   ; routine SCR-PTRS

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L01C9">L01C9</a>                   ; repeat for all four pointers.

; ok to print

<a name="L01CE"></a>L01CE:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0302">L0302</a>                   ; routine find characters to EOL.

        LD      D,H                     ; HL is end of line
        LD      E,L                     ; transfer to DE register.
        INC     HL                      ; increment
        LD      ($3C22),HL              ; update ENDBUF
        DEC     HL                      ; decrement
        DEC     HL                      ; so HL = DE -1

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L01DD">L01DD</a>                 ; skip if BC zero.

        LDDR                            ; else move the characters.

<a name="L01DD"></a>L01DD:  EX      AF,AF'                  ; restore the output character.
        LD      (DE),A                  ; insert at screen position.
                                        ; (a zero if CR lower)
        INC     DE                      ; next character position
        LD      ($3C20),DE              ; update CURSOR

<a name="L01E4"></a>L01E4:  XOR     A                       ; ?
        RET                             ; return.

; -------------------------
; THE <b><font color="#333388">'EDIT KEY'</font></b> SUBROUTINE
; -------------------------

<a name="L01E6"></a>L01E6:  LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L01F0">L01F0</a>                ; address the EDIT KEYS table.

        LD      D,$00                   ; prepare to index by one byte.
        LD      E,A                     ; character code to E.
        ADD     HL,DE                   ; index into the table.

        LD      E,(HL)                  ; pick up required offset to the
                                        ; handling routine.

        ADD     HL,DE                   ; add to the current address.
        JP      (HL)                    ; exit via the routine.

; ---------------------
; THE <b><font color="#333388">'EDIT KEYS'</font></b> TABLE
; ---------------------

<a name="L01F0"></a>L01F0:  DEFB    $20             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0210">L0210</a>         $00     - RET
<a name="L01F1"></a>L01F1:  DEFB    $13             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0204">L0204</a>         $01     - LEFT
<a name="L01F2"></a>L01F2:  DEFB    $0C             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L01FE">L01FE</a>         $02     - CAPS
<a name="L01F3"></a>L01F3:  DEFB    $1E             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0211">L0211</a>         $03     - RIGHT
<a name="L01F4"></a>L01F4:  DEFB    $0A             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L01FE">L01FE</a>         $04     - GRAPH
<a name="L01F5"></a>L01F5:  DEFB    $37             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L022C">L022C</a>         $05     - DEL
<a name="L01F6"></a>L01F6:  DEFB    $1A             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0210">L0210</a>         $06     - RET
<a name="L01F7"></a>L01F7:  DEFB    $50             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0247">L0247</a>         $07     - UP
<a name="L01F8"></a>L01F8:  DEFB    $06             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L01FE">L01FE</a>         $08     - INV
<a name="L01F9"></a>L01F9:  DEFB    $9C             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0295">L0295</a>         $09     - DOWN
<a name="L01FA"></a>L01FA:  DEFB    $C9             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02C3">L02C3</a>         $0A     - DEL LINE
<a name="L01FB"></a>L01FB:  DEFB    $15             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0210">L0210</a>         $0B     - RET
<a name="L01FC"></a>L01FC:  DEFB    $14             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0210">L0210</a>         $0C     - RET
<a name="L01FD"></a>L01FD:  DEFB    $D3             ; <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02D0">L02D0</a>         $0D     - KEY-ENTER

; -------------------------------
; THE <b><font color="#333388">'TOGGLE STATUS BIT'</font></b> ROUTINE
; -------------------------------
; The keycodes have been cleverly mapped to individual bits of the STATIN
; system variable so this simple routine maintains all three status bits.
; KEY '2' - CAPS SHIFT, '4' - GRAPHICS, '8' - INVERSE VIDEO.

<a name="L01FE"></a>L01FE:  LD      HL,$3C28                ; system variable STATIN
        XOR     (HL)                    ; toggle the single relevant bit.
        LD      (HL),A                  ; put back.
        RET                             ; return.

; ----------------------------
; THE <b><font color="#333388">'CURSOR LEFT'</font></b> SUBROUTINE
; ----------------------------
; this subroutine moves the cursor to the left unless the character at that
; position is zero.

<a name="L0204"></a>L0204:  LD      HL,($3C20)              ; fetch CURSOR.
        DEC     HL                      ; decrement value.
        LD      A,(HL)                  ; fetch character at new position.
        AND     A                       ; test for zero. (cr)
        RET     Z                       ; return if so.                  &gt;&gt;

        LD      ($3C20),HL              ; else update CURSOR
        INC     HL                      ; step back
        LD      (HL),A                  ; and put character that was at new
                                        ; cursor position where cursor is now.

<a name="L0210"></a>L0210:  RET                             ; return.

; <font color="#9900FF">Note.</font> various unallocated keys in the EDIT KEYS table point to the
; above RET instruction.

; -----------------------------
; THE <b><font color="#333388">'CURSOR RIGHT'</font></b> SUBROUTINE
; -----------------------------

<a name="L0211"></a>L0211:  LD      HL,($3C20)              ; fetch CURSOR position
        INC     HL                      ; and increment it.

        LD      DE,($3C22)              ; fetch ENDBUF - end of current line.
        AND     A                       ; prepare to subtract.
        SBC     HL,DE                   ; test
        RET     Z                       ; return if zero - CURSOR is at ENDBUF

        ADD     HL,DE                   ; else reform the pointers.
        LD      ($3C20),HL              ; update CURSOR
        LD      A,(HL)                  ; fetch character at new position.
        DEC     HL                      ; decrement
        LD      (HL),A                  ; and insert where cursor was.
        RET                             ; ret.

; ---------------------------
; THE <b><font color="#333388">'DELETE CURSOR'</font></b> ROUTINE
; ---------------------------
; Moves cursor position to right and then continues into DEL-CHAR

<a name="L0225"></a>L0225:  LD      HL,($3C20)              ; fetch CURSOR
        INC     HL                      ; increment position.
        LD      ($3C20),HL              ; update CURSOR


; ------------------------------
; THE <b><font color="#333388">'DELETE CHARACTER'</font></b> ROUTINE
; ------------------------------

<a name="L022C"></a>L022C:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0302">L0302</a>                   ; routine finds characters to EOL.

        LD      H,D                     ; transfer CURSOR position DE to HL.
        LD      L,E                     ;
        DEC     DE                      ; decrement DE
        LD      A,(DE)                  ; fetch character to left of original
                                        ; cursor.
        AND     A                       ; test for zero.
        RET     Z                       ; return if so.                 &gt;&gt;

        LD      ($3C20),DE              ; else update CURSOR
        LD      A,B                     ; check for count of characters
        OR      C                       ; being zero
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L023F">L023F</a>                 ; skip if so.

<a name="L023D"></a>L023D:  LDIR                            ; else shift characters to left.

<a name="L023F"></a>L023F:  DEC     HL                      ; decrement HL so that points to end -
                                        ; last position on the logical line.
        LD      (HL),$20                ; insert a space.
        LD      ($3C22),HL              ; set ENDBUF
        INC     C                       ; reset zero flag??
        RET                             ; return.

; -----------------------
; THE <b><font color="#333388">'CURSOR UP'</font></b> ROUTINE
; -----------------------
; When the cursor is moved up while editing a multi-line word definition,
; then the cursor is first moved to the left of the screen abutting the
; character zeros at the leftmost position.
; These zero characters appear as spaces but mark the beginning of each logical
; line. A logical line may, for instance if it contains a text item, extend over
; several physical screen lines.

<a name="L0247"></a>L0247:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0204">L0204</a>                   ; routine CURSOR-LEFT
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0254">L0254</a>                 ; skip forward if not possible.

; else move left by thirty two positions. This may achieve a vertical move if
; attempted when a word is first being entered. Alternatively if one of the
; calls to cursor left fails having encountered a zero, then all subsequent
; calls will fail. The routine will return with the cursor adjacent to the zero.

        LD      B,$1F                   ; count 31 decimal
<a name="L024E"></a>L024E:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0204">L0204</a>                   ; move cursor left thirty one times.
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L024E">L024E</a>                   ; makes thirty two moves counting first

        RET                             ; return.

; ---

<a name="L0254"></a>L0254:  LD      HL,($3C1E)              ; fetch INSCRN start of current line.
        LD      DE,($3C24)              ; fetch L_HALF start of buffer.
        AND     A                       ; reset carry for
        SBC     HL,DE                   ; true subtraction.
        RET     Z                       ; return if at beginning of input buffer

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0225">L0225</a>                   ; routine DEL-CURSOR

        LD      HL,($3C1E)              ; fetch INSCRN leftmost location of
                                        ; current line.
        LD      DE,$FFE0                ; make DE minus thirty two.
        XOR     A                       ; clear accumulator to zero.

<a name="L0269"></a>L0269:  ADD     HL,DE                   ; subtract 32
        CP      (HL)                    ; compare contents to zero
                                        ; ( i.e. prev (cr) or buffer start?)
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0269">L0269</a>                ; loop back until HL holds zero.

        LD      ($3C1E),HL              ; update INSCRN

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02F4">L02F4</a>                   ; find endbuf

        LD      ($3C20),HL              ; set CURSOR

; ----------
; PR_CURSOR
; ----------

<a name="L0276"></a>L0276:  LD      A,$A0                   ; inverse space - so solid square

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L017E">L017E</a>                   ; routine PR_LOWER

        LD      HL,($3C20)              ; CURSOR
        DEC     HL
        LD      ($3C20),HL              ; CURSOR

; -&gt; from interrupt
<a name="L0282"></a>L0282:  LD      HL,($3C20)              ; CURSOR

        LD      A,($3C28)               ; STATIN
        RRA                             ; ignore bit 0
        LD      (HL),$97                ; pixel cursor.
        RRA                             ; test bit 1 - CAPS
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0290">L0290</a>                ; forward if no CAPS SHIFT

        LD      (HL),$C3                ; inverse [C] cursor.

<a name="L0290"></a>L0290:  RRA                             ; test bit 2 - GRAPHICS.
        RET     NC                      ; return if not

<a name="L0292"></a>L0292:  LD      (HL),$C7                ; inverse [G] cursor.
        RET                             ; return

; -------------------------
; THE <b><font color="#333388">'CURSOR DOWN'</font></b> ROUTINE
; -------------------------


<a name="L0295"></a>L0295:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0211">L0211</a>                   ; routine CURSOR RIGHT
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L02A2">L02A2</a>                 ; forward if not possible.

        LD      B,$1F                   ; set counter to thirty one.

<a name="L029C"></a>L029C:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0211">L0211</a>                   ; routine CURSOR RIGHT
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L029C">L029C</a>                   ; thirty two moves altogether.
        RET                             ; return.

; ---

<a name="L02A2"></a>L02A2:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02B0">L02B0</a>                   ; find zerobyte
        RET     PO                      ; return if    found

        PUSH    HL                      ; save position
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0225">L0225</a>                   ; routine DEL-CURSOR
        POP     HL                      ; retrieve position.
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02ED">L02ED</a>                   ; set logical line
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0276">L0276</a>                   ; back to exit via pr_cursor.

; ---
; find zerobyte
; ---
; -&gt; called 5 times

<a name="L02B0"></a>L02B0:  LD      HL,$2700                ; this location is always zero.
                                        ; the byte following video RAM.
        LD      DE,($3C1E)              ; INSCRN        e.g. $26E0

        AND     A                       ; prepare for true subtraction

        SBC     HL,DE                   ; subtract to give number of chars

        LD      B,H                     ; transfer count to
        LD      C,L                     ; the BC register pair.

        EX      DE,HL                   ; transfer INSCR value to HL.

        INC     HL                      ; start next location
        XOR     A                       ; search for a zero character.

        CPIR                            ; at most BC locations.
                                        ; sets P/O flag if BC!=0

        DEC     HL                      ; step back to last non-zero
        RET                             ; return.

; -------------------------
; THE <b><font color="#333388">'DELETE LINE'</font></b> ROUTINE
; -------------------------
; CHR$ 10

<a name="L02C3"></a>L02C3:  LD      HL,($3C22)              ; ENDBUF
        DEC     HL                      ;
        LD      ($3C20),HL              ; CURSOR

<a name="L02CA"></a>L02CA:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L022C">L022C</a>                   ; KEY-DEL
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L02CA">L02CA</a>                ; repeat

        RET                             ; return.

; --------------------------
; THE <b><font color="#333388">'KEY-ENTER'</font></b> SUBROUTINE
; --------------------------

<a name="L02D0"></a>L02D0:  LD      HL,$3C28                ; STATIN
        SET     5,(HL)                  ; signal new key.
        RES     0,(HL)                  ; reset new key flag
        RET                             ; return.


; ------------------------
; THE <b><font color="#333388">'SET BUFFER'</font></b> ROUTINE
; ------------------------
; called by LIST, QUERY

<a name="L02D8"></a>L02D8:  LD      HL,$2700                ; one past end of screen.
        LD      DE,($3C24)              ; fetch start of buffer from L_HALF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FA">L07FA</a>                   ; routine SPACE_FILL

        LD      HL,$26E0                ; first location of bottom line.
        LD      ($3C24),HL              ; set L_HALF

        LD      (HL),$00                ; insert a ZERO.

; -&gt; called by retype
<a name="L02EA"></a>L02EA:  LD      HL,($3C24)              ; fetch L_HALF

; -&gt; from cursor down
<a name="L02ED"></a>L02ED:  LD      ($3C1E),HL              ; set INSCRN
        INC     HL                      ; step past the zero
        LD      ($3C20),HL              ; set CURSOR

; =&gt; from cursor up.
<a name="L02F4"></a>L02F4:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02B0">L02B0</a>                   ; find zerobyte

        LD      A,$20                   ; prepare a space

<a name="L02F9"></a>L02F9:  DEC     HL                      ; move to the left.
        CP      (HL)                    ; compare to space.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L02F9">L02F9</a>                 ; back while spaces exist.

        INC     HL                      ; point to last space encountered.
        LD      ($3C22),HL              ; set ENDBUF - end of logical line.
        RET                             ; return.

; ----------------------------------
; THE <b><font color="#333388">'COUNT TO END OF LINE'</font></b> ROUTINE
; ----------------------------------
; Find the number of characters to the end of the logical line.

<a name="L0302"></a>L0302:  LD      HL,($3C22)              ; system variable ENDBUF
        LD      DE,($3C20)              ; system variable CURSOR
        AND     A                       ; prepare to subtract.
        SBC     HL,DE                   ; subtract to give character places
        LD      B,H                     ; transfer result
        LD      C,L                     ; to the BC register pair.
        ADD     HL,DE                   ; reform the pointers.

        RET                             ; return with zero flag set if cursor
                                        ; at EOL.

; ----------------------
; THE <b><font color="#333388">'KEYBOARD'</font></b> ROUTINE
; ----------------------

<a name="L0310"></a>L0310:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0336">L0336</a>                   ; routine KEY_SCAN

        LD      B,A                     ; save key in B

        LD      HL,($3C26)              ; load L with KEYCOD - last key pressed
                                        ; load H with KEYCNT - debounce counter

        XOR     L                       ; compare to previous key.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0325">L0325</a>                 ; forward if a match.

        XOR     L                       ; reform original
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0320">L0320</a>                 ; forward if zero - no key.

        XOR     A                       ; else clear accumulator.

        CP      L                       ; compare with last.
        RET     NZ                      ; return if not zero.

<a name="L0320"></a>L0320:  LD      L,B                     ; set L to original keycode
        LD      H,$20                   ; set counter to thirty two.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0332">L0332</a>                   ; forward to store values and exit
                                        ; returning zero.

; ---

; Key is same as previously accepted key.
; It repeats after two interrupts

<a name="L0325"></a>L0325:  DEC     H                       ; decrement the counter.
        LD      A,H                     ; fetch counter to A.
        CP      $1E                     ; compare to thirty.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0331">L0331</a>                 ; forward if so to return key in A.

        XOR     A                       ; clear accumulator.
        CP      H                       ; is counter zero?
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0332">L0332</a>                ; forward if not to keep counting.

        LD      H,$04                   ; else set counter to four.

<a name="L0331"></a>L0331:  LD      A,L                     ; pick up previous key.

<a name="L0332"></a>L0332:  LD      ($3C26),HL              ;  update KEYCOD/KEYCNT

        RET                             ; return.

;----------------------------------------------------------------------------
;                          LOGICAL VIEW OF KEYBOARD
;
;         0     1     2     3     4 -Bits-  4     3     2     1     0
; PORT                                                                    PORT
;
; F7FE  [ 1 ] [ 2 ] [ 3 ] [ 4 ] [ 5 ]  |  [ 6 ] [ 7 ] [ 8 ] [ 9 ] [ 0 ]   EFFE
;  ^                                   |                                   v
; FBFE  [ Q ] [ W ] [ E ] [ R ] [ T ]  |  [ Y ] [ U ] [ I ] [ O ] [ P ]   DFFE
;  ^                                   |                                   v
; FDFE  [ A ] [ S ] [ D ] [ F ] [ G ]  |  [ H ] [ J ] [ K ] [ L ] [ ENT ] BFFE
;  ^                                   |                                   v
; FEFE  [SHI] [SYM] [ Z ] [ X ] [ C ]  |  [ V ] [ B ] [ N ] [ M ] [ SPC ] 7FFE
;  ^            v                                                ^         v
; Start         +------------&gt;---------------------&gt;-------------+        End
;
;
;----------------------------------------------------------------------------


; ----------------------------------
; THE <b><font color="#333388">'KEYBOARD SCANNING'</font></b> SUBROUTINE
; ----------------------------------
; This routine is called by the KEYBOARD routine 50 times a second and
; by the ACE FORTH 'INKEY' WORD.
; The above diagram shows the logical view of the Keyboard and PORTS.
; The physical view is similar except that the symbol shift key is to the
; left of the space key.


<a name="L0336"></a>L0336:  LD      BC,$FEFE                ; port address - B is also an 8 counter

        IN      D,(C)                   ; read from port to D.
                                        ; when a key is pressed, the
                                        ; corresponding bit is reset.

        LD      E,D                     ; save in E

        SRL     D                       ; read the outer SHIFT key.

        SBC     A,A                     ; $00 if SHIFT else $FF.
        AND     $D8                     ; $00 if SHIFT else $D8.

        SRL     D                       ; read the symbol shift bit
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0347">L0347</a>                 ; skip if not pressed.

        LD      A,$28                   ; load A with 40 decimal.

<a name="L0347"></a>L0347:  ADD     A,$57                   ; gives $7F SYM, $57 SHIFT, or $2F

; Since 8 will be subtracted from the initial key value there are three
; distinct ranges 0 - 39, 40 - 79, 80 - 119.

        LD      L,A                     ; save key range value in L
        LD      A,E                     ; fetch the original port reading.
        OR      $03                     ; cancel the two shift bits.

        LD      E,$FF                   ; set a flag to detect multiple keys.

; KEY_LINE the half-row loop.

<a name="L034F"></a>L034F:  CPL                             ; complement bits

        AND     $1F                     ; mask off the rightmost five key bits.
        LD      D,A                     ; save a copy in D.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0362">L0362</a>                 ; forward if no keys pressed to do the
                                        ; next row.

        LD      A,L                     ; else fetch the key value
        INC     E                       ; test E for $FF
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L036B">L036B</a>                ; forward if not now zero to quit

<a name="L0359"></a>L0359:  SUB     $08                     ; subtract 8 from key value

        SRL     D                       ; test next bit affecting zero and carry

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0359">L0359</a>                ; loop back until the set bit is found.

        LD      E,A                     ; transfer key value to E.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L036B">L036B</a>                ; forward to abort if more than one key
                                        ; is pressed in the row.

<a name="L0362"></a>L0362:  DEC     L                       ; decrement the key value for next row.

        RLC     B                       ; rotate the 8 counter and port address

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L036D">L036D</a>                ; skip forward when all 8 rows have
                                        ; been read.

        IN      A,(C)                   ; else read the next half-row.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L034F">L034F</a>                   ; and back to KEY_LINE.

; ---
; ABORTKEY

<a name="L036B"></a>L036B:  LD      E,$FF                   ; signal invalid key.

; the normal exit checks if E holds a key and not $FF.

<a name="L036D"></a>L036D:  LD      A,E                     ; fetch possible key value.
        INC     A                       ; increment
        RET     Z                       ; return if was $FF as original.

        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0376">L0376</a>                ; else address KEY TABLE
        ADD     HL,DE                   ; index into table.
                                        ; (D is zero)

        LD      A,(HL)                  ; pick up character.

        RET                             ; return with translated character.



; ---------------
; THE <b><font color="#333388">'KEY TABLE'</font></b>
; ---------------

; -----------------------
; THE <b><font color="#333388">'40 UNSHIFTED KEYS'</font></b>
; -----------------------

<a name="L0376"></a>L0376:  DEFB    $76                     ; V - v
        DEFB    $68                     ; H - h
        DEFB    $79                     ; Y - y
        DEFB    $36                     ; 6 - 6
        DEFB    $35                     ; 5 - 5
        DEFB    $74                     ; T - t
        DEFB    $67                     ; G - g
        DEFB    $63                     ; C - c
        DEFB    $62                     ; B - b
        DEFB    $6A                     ; J - j
        DEFB    $75                     ; U - u
        DEFB    $37                     ; 7 - 7
        DEFB    $34                     ; 4 - 4
        DEFB    $72                     ; R - r
        DEFB    $66                     ; F - f
        DEFB    $78                     ; X - x
        DEFB    $6E                     ; N - n
        DEFB    $6B                     ; K - k
        DEFB    $69                     ; I - i
        DEFB    $38                     ; 8 - 8
        DEFB    $33                     ; 3 - 3
        DEFB    $65                     ; E - e
        DEFB    $64                     ; D - d
        DEFB    $7A                     ; Z - z
        DEFB    $6D                     ; M - m
        DEFB    $6C                     ; L - l
        DEFB    $6F                     ; O - o
        DEFB    $39                     ; 9 - 9
        DEFB    $32                     ; 2 - 2
        DEFB    $77                     ; W - w
        DEFB    $73                     ; S - s
        DEFB    $00                     ; SYMBOL
        DEFB    $20                     ; SPACE
        DEFB    $0D                     ; ENTER
        DEFB    $70                     ; P - p
        DEFB    $30                     ; 0 - 0
        DEFB    $31                     ; 1 - 1
        DEFB    $71                     ; Q - q
        DEFB    $61                     ; A - a
        DEFB    $00                     ; SHIFT

; ---------------------
; THE <b><font color="#333388">'40 SHIFTED KEYS'</font></b>
; ---------------------

        DEFB    $56                     ; V - V
        DEFB    $48                     ; H - H
        DEFB    $59                     ; Y - Y
        DEFB    $07                     ; 6 - 7 KEY-UP
        DEFB    $01                     ; 5 - 1 KEY-LEFT
        DEFB    $54                     ;
        DEFB    $47
        DEFB    $43
        DEFB    $42
        DEFB    $4A
        DEFB    $55
        DEFB    $09                     ; 7 - 9 KEY-DOWN
        DEFB    $08                     ; 4 - 8 INV-VIDEO
        DEFB    $52
        DEFB    $46
        DEFB    $58
        DEFB    $4E
        DEFB    $4B
        DEFB    $49
        DEFB    $03                     ; 8 - 3 KEY-RIGHT
        DEFB    $33                     ; 3 - 3
        DEFB    $45
        DEFB    $44
        DEFB    $5A
        DEFB    $4D
        DEFB    $4C
        DEFB    $4F
        DEFB    $04                     ; 9 - 4 GRAPH
        DEFB    $02                     ; 2 - 2 CAPS LOCK
        DEFB    $57                     ; W - W
        DEFB    $53                     ; S - S
        DEFB    $00                     ; SYMB
        DEFB    $20                     ; SPACE
        DEFB    $0D                     ; ENTER
        DEFB    $50                     ; P - P
        DEFB    $05                     ; 0 - 5   DEL
        DEFB    $0A                     ; 1 - 0A  DEL_LINE
        DEFB    $51                     ; Q - Q
        DEFB    $41                     ; A - A
        DEFB    $00                     ; SHIFT

; --------------------------
; THE <b><font color="#333388">'40 SYMBOL SHIFT KEYS'</font></b>
; --------------------------

        DEFB    $2F                     ; V - /
        DEFB    $5E                     ; H - ^
        DEFB    $5B                     ; Y - [
        DEFB    $26                     ; 6 - &amp;
        DEFB    $25                     ; 5 - %
        DEFB    $3E                     ; T - &gt;
        DEFB    $7D                     ;
        DEFB    $3F
        DEFB    $2A
        DEFB    $2D
        DEFB    $5D
        DEFB    $27
        DEFB    $24
        DEFB    $3C
        DEFB    $7B
        DEFB    $60
        DEFB    $2C
        DEFB    $2B
        DEFB    $7F
        DEFB    $28
        DEFB    $23
        DEFB    $45
        DEFB    $5C
        DEFB    $3A
        DEFB    $2E
        DEFB    $3D
        DEFB    $3B
        DEFB    $29
        DEFB    $40                     ; 2 - @
        DEFB    $57                     ; W - W
        DEFB    $7C                     ; S
        DEFB    $00                     ; SYMB
        DEFB    $20                     ; SPACE
        DEFB    $0D                     ; ENTER
        DEFB    $22                     ; P - "
        DEFB    $5F                     ; 0 - _
        DEFB    $21                     ; 1 - !
        DEFB    $51                     ; Q - Q
        DEFB    $7E                     ; A - ~
        DEFB    $00                     ; SHIFT

; end of key tables


; ---------------------------
; THE <b><font color="#333388">'PRINT ROUTINE'</font></b> Part 2.
; ---------------------------
; If output is not directed into the input buffer then jump forward else
; call the routine to output to lower screen.

<a name="L03EE"></a>L03EE:  JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L03F5">L03F5</a>                 ; forward to main screen print.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L017E">L017E</a>                   ; PR_LOWER

        EXX                             ; restore main set
        RET                             ; return.                &gt;&gt;

; the print output is not directed to the input buffer but first check that
; the user has not set up a vector to their own routine to print characters
; for instance to a printer.

<a name="L03F5"></a>L03F5:  LD      B,A                     ; save the character in the B register.

        LD      HL,($3C29)              ; fetch possible vector from EXWRCH
                                        ; (normally 0)
        LD      A,H                     ; test for
        OR      L                       ; the value zero.
        LD      A,B                     ; fetch the character back to A.

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L03FF">L03FF</a>                 ; skip forward if no user-supplied
                                        ; routine.

<a name="L03FE"></a>L03FE:  JP      (HL)                    ; else jump to user-supplied routine
                                        ; which should finish with a JP (IY)**
                                        ; ** 2022 update This is an error in the
                                        ; listing **
                                        ; The character is provided in the A register
                                        ; of the Z80.
                                        ; The output routine should preserve the
                                        ; auxiliary registers, ix and iy, and
                                        ; finish off with exx and ret.
                                        ; see page  142 of manual.
; ---
; PRINTING TO UPPER SCREEN
; ---

<a name="L03FF"></a>L03FF:  LD      HL,($3C1C)              ; SCRPOS
        LD      DE,($3C24)              ; L_HALF

        EX      DE,HL                   ; ??

        SCF                             ; inclusive byte.
        SBC     HL,DE                   ; subtract screen position+1 from
                                        ; the start of input buffer.
        EX      DE,HL                   ; hl=scrpos

        CALL    C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0421">L0421</a>                 ; if no room then scroll upper display

        CP      $0D                     ; carriage return?

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0416">L0416</a>                 ; skip forward if so.

        LD      (HL),A                  ; else insert the character.

        INC     HL                      ; point to next position.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L041C">L041C</a>                   ; forward

; ---

; a carriage return

<a name="L0416"></a>L0416:  INC     HL                      ; increment screen address.
        LD      A,L                     ; fetch low byte of address and mask.
        AND     $1F                     ; a zero result indicates a line skip.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0416">L0416</a>                ; loop until a new line of 32 columns
                                        ; is started.

; both paths converge.

<a name="L041C"></a>L041C:  LD      ($3C1C),HL              ; update SCRPOS

        EXX                             ; back to main set.

        RET                             ; return.

; -------------------------------------
; The <b><font color="#333388">'UPPER DISPLAY SCROLLING'</font></b> ROUTINE
; -------------------------------------

<a name="L0421"></a>L0421:  PUSH    AF                      ; save character

        LD      HL,$3C1C                ; address the low order byte SCRPOS

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0443">L0443</a>                   ; routine cursor up
                                        ; i.e. SCRPOS = SCRPOS - 32

        POP     AF                      ; restore character

; now calculate the number of characters to scroll in the upper display.

        LD      HL,($3C24)              ; fetch L_HALF the start of input buffer
        LD      DE,$2420                ; second line in video display

;
; =&gt; scroll lower display enters here
<a name="L042F"></a>L042F:  AND     A                       ; prepare for true subtraction.
        SBC     HL,DE                   ; find number of characters to scroll.

        LD      B,H                     ; result to BC
        LD      C,L

        LD      HL,$FFE0                ; set HL to -32d
        ADD     HL,DE                   ; now HL = DE -32d
        EX      DE,HL                   ; switch so DE = HL - 32

        LDIR                            ; scroll the lines up.

        LD      B,$20                   ; blank a line of 32 characters

<a name="L043D"></a>L043D:  DEC     HL                      ; decrement screen address.
        LD      (HL),$20                ; insert a space character
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L043D">L043D</a>                   ; and loop for all 32 characters

        RET                             ; return.

; --------------------------------
; THE <b><font color="#333388">'SCREEN POINTERS'</font></b> SUBROUTINE
; --------------------------------
;

<a name="L0443"></a>L0443:  LD      A,(HL)                  ; fetch low byte of screen address
        SUB     $20                     ; subtract thirty two characters.
        LD      (HL),A                  ; and put back.

        INC     HL                      ; address high-order byte.
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L044B">L044B</a>                ; forward if low byte did not wrap

        DEC     (HL)                    ; else decrement the high byte as the
                                        ; position has moved across a third of
                                        ; the display.

<a name="L044B"></a>L044B:  INC     HL                      ; address following System Variable
        RET                             ; return.

; -----------------------------------
; THE <b><font color="#333388">'INDEX SYSTEM VARIABLE'</font></b> ROUTINE
; -----------------------------------
; This routine is used by words CONTEXT, CURRENT, BASE etc. to index and then
; stack a system variable associated with a FORTH word. See shortly.
;
; It is a bit overblown considering the eventual position of the System
; Variables and ld d,$3c; rst 10h; jp (iy) could have been used instead of
; the long-winded addition below.

<a name="L044D"></a>L044D:  EX      DE,HL                   ; HL addresses the offset byte.
        LD      E,(HL)                  ; fetch to E register
;
        LD      D,$00                   ; prepare to add.
        LD      HL,$3C00                ; the address of start of SYSVARS
        ADD     HL,DE                   ; add the 8-bit offset
        EX      DE,HL                   ; location to DE.
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'HERE'</font></b> WORD
; ---------------
; <font color="#CC00FF">( -- address)</font>
; Leaves the address of one past the end of the dictionary.

<a name="L0459"></a>L0459:  DEFM    "HER"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L00AA">L00AA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L045F"></a>L045F:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0460"></a>L0460:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0462">L0462</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0462"></a>L0462:  LD      DE,($3C37)              ; system variable STKBOT.
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------------
; THE <b><font color="#333388">'CONTEXT'</font></b> WORD
; ------------------
; <font color="#CC00FF">(  -- 15411 )</font>
; A system variable pointing to the context vocabulary.
; $3C33 CONTEXT

<a name="L0469"></a>L0469:  DEFM    "CONTEX"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L045F">L045F</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0472"></a>L0472:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0473"></a>L0473:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L044D">L044D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0475"></a>L0475:  DEFB    $33                     ; low byte of system variable.

; ------------------
; THE <b><font color="#333388">'CURRENT'</font></b> WORD
; ------------------
; <font color="#CC00FF">(  -- 15409 )</font>
; A system variable pointing to the current vocabulary.
; $3C31 CURRENT

<a name="L0476"></a>L0476:  DEFM    "CURREN"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0472">L0472</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L047F"></a>L047F:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0480"></a>L0480:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L044D">L044D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0482"></a>L0482:  DEFB    $31                     ; a single parameter low-byte of $3C31.

; ---------------
; THE <b><font color="#333388">'BASE'</font></b> WORD
; ---------------
; <font color="#CC00FF">( -- 15423)</font>
; A one-byte variable containing the system number base.
; $3C3F BASE

<a name="L0483"></a>L0483:  DEFM    "BAS"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L047F">L047F</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0489"></a>L0489:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L048A"></a>L048A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L044D">L044D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L048C"></a>L048C:  DEFB    $3F                     ; low-byte of system variable BASE

; ---

; These two Internal Words are used to stack the value of FLAGS and DICT.

; -------------------------
; The <b><font color="#333388">'flags'</font></b> Internal Word
; -------------------------

<a name="L048D"></a>L048D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L044D">L044D</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L048F"></a>L048F:  DEFB    $3E                     ; low-order byte of FLAGS $3C3E

; -------------------------
; The <b><font color="#333388">'dict'</font></b> Internal Word
; -------------------------

<a name="L0490"></a>L0490:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L044D">L044D</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L0492"></a>L0492:  DEFB    $39                     ; low-order byte of DICT $3C39


; --------------
; THE <b><font color="#333388">'PAD'</font></b> WORD
; --------------
; <font color="#CC00FF">(  -- 9985 )</font>
; Stacks the address of the 254-byte workpad.
; On most FORTH systems the PAD floats about in memory but on the Ace it is
; fixed in location and size. Its definition is simply a constant.

l0493   DEFM    "PA"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0489">L0489</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0498"></a>L0498:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0499"></a>L0499:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF5">L0FF5</a>                   ; <b><font color="#3030dd">'code field'</font></b> - stack word

; ---

<a name="L049B"></a>L049B:  DEFW    $2701                   ; parameter is 9985 decimal -
                                        ; work pad address

; ------------
; THE <b><font color="#333388">';'</font></b> WORD
; ------------
; Terminates colon, DEFINER and COMPILER definitions.

<a name="L049D"></a>L049D:  DEFB    ';' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0498">L0498</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L04A0"></a>L04A0:  DEFB    $41                     ; length 1 + $40 (immediate word)

<a name="L04A1"></a>L04A1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L04A3"></a>L04A3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

<a name="L04A5"></a>L04A5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $0A                     ; ten                   marker byte?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

; code gels

<a name="L04AA"></a>L04AA:  LD      HL,$3C3E                ; address FLAGS
        LD      A,(HL)                  ; fetch FLAGS value.

        AND     $BB                     ; AND %10111011
                                        ; reset bit 2 - show definition complete
                                        ; reset bit 6 - show in interpreter mode

        LD      (HL),A                  ; update FLAGS value.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ----
; <font color="#9900FF">Note.</font> these backward links to the beginning of words will probably be less
; of a mystery when the syntax checking and listing modules are more fully
; explored. A value of $FFFF sometimes occurs.

x04b3   DEFB    $00                     ;;

x04b4   DEFB    $E8                     ;;
x04b5   DEFB    $FF                     ;; 04b5 + ffe8 = 049d  = ';'

; ----------------------------------
; THE <b><font color="#333388">'ADDRESS'</font></b> INTERPRETER ROUTINES
; ----------------------------------

; ------------------------
; The <b><font color="#333388">'Exit'</font></b> Internal Word
; ------------------------
; Drops the 'Next Word' pointer from the Return Stack thereby ending a
; subroutine and returning to next word in calling thread.

<a name="L04B6"></a>L04B6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B8">L04B8</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L04B8"></a>L04B8:  POP     HL                      ; discard the next word pointer.

; ------------------------------
; THE <b><font color="#333388">'ADDRESS INTERPRETER'</font></b> LOOP
; ------------------------------
; Sometimes known as the Sequencer.
;
; iy_fast

<a name="L04B9"></a>L04B9:  POP     HL                      ; word pointer.

; =====&gt; from DOCOLON and BRANCH

<a name="L04BA"></a>L04BA:  LD      E,(HL)
        INC     HL
        LD      D,(HL)
        INC     HL

        PUSH    HL                      ; word pointer.

; ==&gt;
;
<a name="L04BF"></a>L04BF:  EX      DE,HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)
        INC     HL
        EX      DE,HL

        JP      (HL)                    ; jump to machine code (4 clock cycles)
                                        ; which will terminate with a JP (IY)
                                        ; instruction (8 clock cycles).



; --------------------------------
; The <b><font color="#333388">'Memory Check'</font></b> Internal Word
; --------------------------------
; This internal word which also checks the BREAK key is only used from the
; start of the LINE definition. However the machine code entry point is the
; normal value of the IY register and so this code is executed at the end of
; every word.

<a name="L04C6"></a>L04C6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04C8">L04C8</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; iy_slow

<a name="L04C8"></a>L04C8:  LD      BC,$000B                ; allow overhead of eleven bytes
        LD      DE,($3C3B)              ; SPARE
        LD      HL,($3C37)              ; STKBOT
        ADD     HL,BC                   ; add the overhead
        SBC     HL,DE                   ; subtract the SPARE value
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04D9">L04D9</a>                 ; forward if the original 12 byte gap
                                        ; remains.

; else stack underflow has occurred.

<a name="L04D7"></a>L04D7:  RST     20H                     ; <b><font color="#FF0000">Error 2</font></b>
        DEFB    $02                     ; Data stack underflow.

; ---

<a name="L04D9"></a>L04D9:  LD      BC,$0000                ; allow no overhead.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F8C">L0F8C</a>                   ; check free memory
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04E4">L04E4</a>                   ; check BREAK key.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; back to iy_fast

; ------------------------------------
; THE <b><font color="#333388">'CHECK FOR BREAK KEY'</font></b> SUBROUTINE
; ------------------------------------
; Check for the key combination SHIFT/SPACE.

<a name="L04E4"></a>L04E4:  LD      A,$FE                   ; read port $FEFE -
        IN      A,($FE)                 ; keys SPACE, SYMSHIFT, M, N, B.

        RRA                             ; test bit for outermost key
        RET     C                       ; return if not pressed.

        LD      A,$7F                   ; read port $7FFE -
        IN      A,($FE)                 ; keys SHIFT, Z, X, C, V.

        RRA                             ; test bit for outermost key
        RET     C                       ; return if not pressed.

<a name="L04F0"></a>L04F0:  RST     20H                     ; <b><font color="#FF0000">Error 3.</font></b>
        DEFB    $03                     ; BREAK pressed.

; -------------------------
; THE <b><font color="#333388">'MAIN EXECUTION'</font></b> LOOP
; -------------------------
; The final part of the QUIT definition, as in all FORTH implementations,
; just loops through two FORTH words.

; The first call - to the Address Interpreter - does not return.
; The return address is the next word QUERY which the interpreter pops off
; the Return Stack and then before executing puts the address of the next word
; on Return Stack. The default action of the Address Interpreter is to execute
; words in turn until some word, such as branch, alters this default behaviour.

<a name="L04F2"></a>L04F2:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth.

<a name="L04F5"></a>L04F5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L058C">L058C</a>                   ; QUERY         - input buffer
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0506">L0506</a>                   ; LINE          - interpret buffer
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0536">L0536</a>                   ; prOK          - print OK
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch        - relative jump

<a name="L04FD"></a>L04FD:  DEFW    $FFF7                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04F5">L04F5</a>

; ---
; the first high-level interpreted word.
; ---

; ---------------
; THE <b><font color="#333388">'LINE'</font></b> WORD
; ---------------
; Interprets input buffer as a normal FORTH line.

<a name="L04FF"></a>L04FF:  DEFM    "LIN"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04A0">L04A0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0505"></a>L0505:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0506"></a>L0506:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0508"></a>L0508:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04C6">L04C6</a>                   ; check mem each time through loop
                                        ; as dictionary could be expanding.

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L063D">L063D</a>                   ; FIND          - search the dictionary
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08EE">L08EE</a>                   ; ?DUP          - duplicate if found
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch       - forward if not a
<a name="L0510"></a>L0510:  DEFW    $0007                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0518">L0518</a>      - word.

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L054F">L054F</a>                   ; test and stack??
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L0516"></a>L0516:  DEFW    $FFF1                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0508">L0508</a>

<a name="L0518"></a>L0518:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L06A9">L06A9</a>                   ; NUMBER
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08EE">L08EE</a>                   ; ?DUP
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch       - forward if not a
<a name="L051E"></a>L051E:  DEFW    $0007                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0526">L0526</a>      - number.

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0564">L0564</a>                   ; pop de with test
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L0524"></a>L0524:  DEFW    $FFE3                   ; loop back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0508">L0508</a>

<a name="L0526"></a>L0526:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L061B">L061B</a>                   ; stack-length
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C1A">L0C1A</a>                   ; 0=
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch       - forward with anything
<a name="L052C"></a>L052C:  DEFW    $0003                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0530">L0530</a>      - else

<a name="L052E"></a>L052E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; EXIT                          &gt;&gt;&gt;

; ---

<a name="L0530"></a>L0530:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0578">L0578</a>                   ; RETYPE        - [?] at relevant place
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch        - once corrected back
<a name="L0534"></a>L0534:  DEFW    $FFD3                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0508">L0508</a>      - to the loop.

; ----------------------------
; The <b><font color="#333388">'Print OK'</font></b> Internal Word
; ----------------------------
; prints the OK message after successful execution.

<a name="L0536"></a>L0536:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0538">L0538</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

<a name="L0538"></a>L0538:  LD      A,($3C3E)               ; fetch system variable FLAGS

        BIT     6,A                     ; test for 'COMPILER' mode.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L054D">L054D</a>                ; forward if so.

        BIT     4,A                     ; test for 'INVIS' mode.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L054D">L054D</a>                ; forward if so.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1808">L1808</a>                   ; else print the inline string.

; ---

        DEFM    " OK"                   ; the OK message between two spaces.
        DEFB    ' ' + $80               ; last one inverted.

; ---

<a name="L054A"></a>L054A:  LD      A,$0D                   ; prepare a carriage return.
        RST     08H                     ; and PRINT also.

<a name="L054D"></a>L054D:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------------------------
; The <b><font color="#333388">'XXXXXXXXXX'</font></b> Internal Word
; ------------------------------
; to handle a Word from LINE

<a name="L054F"></a>L054F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0551">L0551</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L0551"></a>L0551:  RST     18H                     ; pop address from Data Stack to DE

        DEC     DE                      ; point to the 'name length field'

        LD      A,(DE)                  ; fetch contents of the address.

        CPL                             ; complement.

        AND     (IX+$3E)                ; FLAGS

        AND     $40                     ; isolate BIT 6 of FLAGS, set if in
                                        ; compiler mode.

        INC     DE                      ; increment address to 'code field'

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0561">L0561</a>                 ; forward if not in compiling mode

        RST     10H                     ; push word DE          - add to dict
        LD      DE,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                ; ','                   - enclose

<a name="L0561"></a>L0561:  JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BF">L04BF</a>                   ; next word.

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------
; after handling a number from LINE

<a name="L0564"></a>L0564:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0566">L0566</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L0566"></a>L0566:  RST     18H                     ; pop word DE

        BIT     6,(IX+$3E)              ; test FLAGS - compiler mode ?

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0561">L0561</a>                ; loop back while in compiler mode.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -----------------
; THE <b><font color="#333388">'RETYPE'</font></b> WORD
; -----------------
; Allows user to edit the input line. Turns cursor to [?].

<a name="L056F"></a>L056F:  DEFM    "RETYP"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L058B">L058B</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0577"></a>L0577:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0578"></a>L0578:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L057A">L057A</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L057A"></a>L057A:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02EA">L02EA</a>                   ; routine sets logical line.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0276">L0276</a>                   ; routine pr_cursor

        LD      (HL),$BF                ; the inverse [?] character

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0594">L0594</a>                   ; forward to join the QUERY routine.

; ----------------
; THE <b><font color="#333388">'QUERY'</font></b> WORD
; ----------------
; Clears input buffer, then accepts characters until ENTER pressed.
; Buffer can be edited as usual and is limited to 22 lines.

<a name="L0584"></a>L0584:  DEFM    "QUER"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'Y' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0505">L0505</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L058B"></a>L058B:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L058C"></a>L058C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L058E">L058E</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L058E"></a>L058E:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02D8">L02D8</a>                   ; routine SETBUF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0276">L0276</a>                   ; routine pr_cursor

; -&gt;
<a name="L0594"></a>L0594:  LD      HL,$3C28                ; fetch STATIN
        SET     0,(HL)                  ;
        RES     5,(HL)                  ; (bit 5 set by interrupt when the user
                                        ; presses the ENTER key)

<a name="L059B"></a>L059B:  BIT     5,(HL)                  ; wait for interrupt to set the bit.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L059B">L059B</a>                 ; loop until.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0225">L0225</a>                   ; routine DEL-CURSOR
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'WORD'</font></b> WORD
; ---------------
; WORD text
; <font color="#CC00FF">( delimiter -- address )</font>
; Takes text out of the input buffer up as far as a delimiter, and copies it
; to pad, starting at the second byte there. Puts the length (not including
; the delimiter) in the first byte of the pad, and stacks the address of the
; first byte of the pad.
; At most 253 characters are taken from the input buffer. If there are more
; left before the delimiter, then the first byte of the pad shows 254.
; Initial delimiters are ignored.

<a name="L05A4"></a>L05A4:  DEFM    "WOR"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0577">L0577</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L05AA"></a>L05AA:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L05AB"></a>L05AB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05AD">L05AD</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L05AD"></a>L05AD:  RST     18H                     ; pop word DE
        LD      HL,$27FE                ; set HL to penultimate byte of 'pad'.
        LD      B,$FD                   ; the count is 253.

<a name="L05B3"></a>L05B3:  LD      (HL),$20                ; insert a space in pad.
        DEC     HL                      ; decrement the address.
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05B3">L05B3</a>                   ; repeat for the 253 locations.

        PUSH    DE                      ; save the delimiter.
        EX      DE,HL                   ; save in HL also, DE is start of pad.

        RST     10H                     ; stack data word DE
        POP     DE                      ; retrieve the delimiter.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05E1">L05E1</a>                   ;

        INC     B
        DEC     B
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L05C6">L05C6</a>                 ;

        LD      BC,$00FF

<a name="L05C6"></a>L05C6:  LD      HL,$2701
        LD      (HL),C
        INC     HL
        LD      A,$FC
        CP      C
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L05D1">L05D1</a>                ;

        LD      C,A

<a name="L05D1"></a>L05D1:  INC     C
        PUSH    DE
        PUSH    BC
        EX      DE,HL
        LDIR
        POP     BC
        POP     DE
        DEC     C
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07DA">L07DA</a>                   ;
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------------------------
; THE <b><font color="#333388">'GET BUFFER TEXT'</font></b> SUBROUTINE
; --------------------------------
; Called from FIND, NUMBER and XXXXX. Word may have leading spaces and is
; terminated by a space or newline (zero).
; It is also used to find the end of a comment delimited by ')'.
;
; =&gt;
<a name="L05DF"></a>L05DF:  LD      E,$20                   ; set a space as the skip character.

; =&gt;called with E holding delimiter.
;
<a name="L05E1"></a>L05E1:  LD      HL,($3C24)              ; fetch L_HALF - start of screen buffer.
        LD      ($3C1E),HL              ; make INSCRN start of logical line the
                                        ; same.

        LD      BC,$0000                ; initialize letter count to zero.

; -&gt; loop
<a name="L05EA"></a>L05EA:  INC     HL                      ; increment screen address.
        LD      A,(HL)                  ; fetch character to A.
        CP      E                       ; compare to character in E.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L05EA">L05EA</a>                 ; loop while character matches.

        AND     A                       ; test for zero (at $2700?)
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0600">L0600</a>                 ; forward if so.

; a word has been found on the screen line.

        PUSH    HL                      ; save pointer to start of word.

<a name="L05F3"></a>L05F3:  INC     BC                      ; increment the letter count.
        INC     HL                      ; increment the screen pointer.

        LD      A,(HL)                  ; fetch new character
        AND     A                       ; test for zero.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L05FC">L05FC</a>                 ; skip forward as at end of word.

        CP      E                       ; compare to the skip character.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L05F3">L05F3</a>                ; loop back if still within a word.

<a name="L05FC"></a>L05FC:  POP     DE                      ; retrieve pointer to start of word.

        XOR     A                       ;; clear A
        CP      B                       ;; compare to B zero

        RET                             ; return. with carry reset for success.

; ---

<a name="L0600"></a>L0600:  PUSH    DE                      ; save delimiter

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02B0">L02B0</a>                   ; routine find zerobyte
        JP      PO,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0614">L0614</a>                ; jump if found to exit failure

        LD      DE,($3C24)              ; else set DE from L_HALF
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FA">L07FA</a>                   ; routine SPACE_FILL (DE-HL)
        LD      ($3C24),HL              ; set L_HALF to next line

        POP     DE                      ; restore delimiter

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05E1">L05E1</a>                   ; loop back using new line.

; ---

; branch here if a word not found.

<a name="L0614"></a>L0614:  EX      DE,HL                   ; DE addresses cursor.
        POP     BC                      ; discard saved delimiter
        LD      BC,$0000                ; set BC, to zero
        SCF                             ; signal not found
        RET                             ; return.

; --------------------------------
; The <b><font color="#333388">'stack length'</font></b> Internal Word
; --------------------------------
; used once only from LINE to check for any extraneous text that is not a Word
; or a Number.

<a name="L061B"></a>L061B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L061D">L061D</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L061D"></a>L061D:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05DF">L05DF</a>                   ; get buffer

        LD      D,B                     ; transfer length of word
        LD      E,C                     ; from BC to DE
        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; ----------------
; THE <b><font color="#333388">'VLIST'</font></b> WORD
; ----------------
; List dictionary to screen, including words in ROM.
; (no pause after 18 lines)

<a name="L0625"></a>L0625:  DEFM    "VLIS"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05AA">L05AA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L062C"></a>L062C:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L062D"></a>L062D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L062F">L062F</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L062F"></a>L062F:  LD      A,$0D                   ; prepare a newline

        RST     08H                     ; print it.

        LD      C,$00                   ; set a flag for 'do all names'.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0644">L0644</a>                   ; forward to FIND.


; ---------------
; THE <b><font color="#333388">'FIND'</font></b> WORD
; ---------------
; <font color="#CC00FF">( -- compilation address )</font>
; Leaves compilation address of first word in input buffer, if defined in
; context vocabulary; else 0.

<a name="L0636"></a>L0636:  DEFM    "FIN"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L062C">L062C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L063C"></a>L063C:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L063D"></a>L063D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L063F">L063F</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L063F"></a>L063F:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05DF">L05DF</a>                   ; get buffer word, gets length in C.

        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L068A">L068A</a>                 ; back if null to stack word zero

; -&gt;

<a name="L0644"></a>L0644:  LD      HL,($3C33)              ; fetch value of system variable CONTEXT
        LD      A,(HL)                  ; extract low byte of address.
        INC     HL                      ; increment pointer.
        LD      H,(HL)                  ; extract high byte of address.
        LD      L,A                     ; address now in HL.

; The address points to the <b><font color="#333388">'name length field'</font></b> of the most recent word in the
; Dictionary.


<a name="L064B"></a>L064B:  LD      A,(HL)                  ; fetch addressed byte.
        AND     $3F                     ; discount bit 6, the immediate word
                                        ; indicator, to give length 1-31

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L067F">L067F</a>                 ; a 'zero' length indicates this is a
                                        ; link like the example at the end of
                                        ; this ROM.

        XOR     C                       ; match against C.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0657">L0657</a>                 ; skip forward if lengths match.

        LD      A,C                     ; test flag C
        AND     A                       ; for value zero.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L067F">L067F</a>                ; forward if C not zero.

; else a name that matches the search length or all names are required - VLIST.


<a name="L0657"></a>L0657:  PUSH    DE                      ; preserve DE
        PUSH    HL                      ; preserve 'name length field' pointer.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15E8">L15E8</a>                   ; routine WORDSTART finds start of name.
                                        ; A is returned as zero.

        OR      C                       ; test C for zero
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0676">L0676</a>                 ; branch forward to print if in VLIST.

; else the search is for a specific word and a word with same length, at least,
; has been found.

        LD      B,C                     ; copy the length to counter B.

<a name="L0660"></a>L0660:  LD      A,(DE)                  ; fetch first letter of match word.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0807">L0807</a>                   ; routine UPPERCASE

        INC     DE                      ; update pointer (in lower screen)
        XOR     (HL)                    ; match against letter (in dictionary).
        AND     $7F                     ; disregard any inverted bit.
        INC     HL                      ; increment dictionary pointer.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L067D">L067D</a>                ; exit loop to try next link if no match

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0660">L0660</a>                   ; else loop back for all letters.

; Oh Frabjous day - a match.

        POP     DE                      ; pop 'name length field' pointer.
        INC     DE                      ; increment to point to compilation
                                        ; address.
        RST     10H                     ; stack date word DE.

; the remaining task is to clean up the input buffer in the lower screen.

        POP     DE                      ; pop the DE - screen pointer.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07DA">L07DA</a>                   ; clean up - backfill with spaces.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -----------------------
; THE <b><font color="#333388">'PRINT NAME'</font></b> BRANCH
; -----------------------
; This branch is taken from the above loop when all found words are to be
; printed by VLIST. It takes its time as if the user has expanded the
; dictionary then the list will scroll off the top of the screen. By waiting
; for an interrupt each time, it ensures that a standard listing takes about
; three seconds and there is ample opportunity to press BREAK to stop at a
; certain point.

<a name="L0676"></a>L0676:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17FB">L17FB</a>                   ; routine print string and space

        HALT                            ; wait for an interrupt.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04E4">L04E4</a>                   ; routine checks BREAK key.

<a name="L067D"></a>L067D:  POP     HL                      ; restore 'name length field' pointer
        POP     DE                      ; restore DE

<a name="L067F"></a>L067F:  DEC     HL                      ; point to high byte of 'link field'
        LD      A,(HL)                  ; hold it in A.
        DEC     HL                      ; point to low byte of 'link field'
        LD      L,(HL)                  ; transfer address of the new
        LD      H,A                     ; <b><font color="#3030dd">'name length field'</font></b> to HL pointer.

        OR      L                       ; test if address is zero - for the
                                        ; last entry in the linked list.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L064B">L064B</a>                ; loop back while this is not the
                                        ; last entry in the vocabulary.

<a name="L0687"></a>L0687:  DEFB    $C3                     ; A JP instruction i.e. JP <a href="http://www.jupiter-ace.co.uk/romlisting.html#L068A">L068A</a>

; <font color="#9900FF">Note.</font> The intention is to jump past the headerless code word for the internal
; word stk_zero. Since the word that would follow the first byte of the jump
; instruction would be identical to the word it is jumping over then the word
; can be omitted. Only saves one byte but this is back in 1983.

; ----------------------------
; The <b><font color="#333388">'stk-zero'</font></b> Internal Word
; ----------------------------
; <font color="#CC00FF">(  -- 0 )</font>

<a name="L0688"></a>L0688:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L068A">L068A</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L068A"></a>L068A:  LD      DE,$0000                ; load DE with the value zero.
        RST     10H                     ; stack Data Word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------------
; THE <b><font color="#333388">'EXECUTE'</font></b> WORD
; ------------------
; <font color="#CC00FF">( compilation address --  )</font>
; Executes the word with the given compilation address.

<a name="L0690"></a>L0690:  DEFM    "EXECUT"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L063C">L063C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0699"></a>L0699:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L069A"></a>L069A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L069C">L069C</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L069C"></a>L069C:  RST     18H

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BF">L04BF</a>                   ;

; -----------------
; THE <b><font color="#333388">'NUMBER'</font></b> WORD
; -----------------
; Takes a number from the start of the input buffer. Leaves the number and
; a non-zero address on the stack. (The address is the compilation address
; of a literal compiler, so that if you then say EXECUTE, the literal compiler
; compiles the number into the dictionary as a literal - for an integer it
; is 4102, for a floating point number it is 4181).
; If no valid number then leaves just 0 on the stack.

<a name="L06A0"></a>L06A0:  DEFM    "NUMBE"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0699">L0699</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L06A8"></a>L06A8:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L06A9"></a>L06A9:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L06AB">L06AB</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L06AB"></a>L06AB:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05DF">L05DF</a>                   ; get buffer

        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L068A">L068A</a>                 ; if empty stack word zero.

        PUSH    BC
        PUSH    DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L074C">L074C</a>                   ;

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L06BC">L06BC</a>                ;

        LD      DE,$1006                ; addr literal?
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0714">L0714</a>                   ;

; ---

<a name="L06BC"></a>L06BC:  RST     18H                     ; pop word DE
        LD      DE,$0000
        RST     10H                     ; push word DE
        LD      DE,$4500
        POP     BC
        PUSH    BC
        LD      A,(BC)
        CP      $2D                     ; is it '-' ?
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L06CE">L06CE</a>                ;

        LD      D,$C5
        INC     BC
<a name="L06CE"></a>L06CE:  RST     10H                     ; push word DE
        LD      D,B
        LD      E,C
        DEC     HL
        DEC     HL

<a name="L06D3"></a>L06D3:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0723">L0723</a>                   ; routine GET_DECIMAL

        INC     HL
        INC     (HL)
        DEC     HL
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L06D3">L06D3</a>                ;

        CP      $FE
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L071C">L071C</a>                ;

<a name="L06DF"></a>L06DF:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0723">L0723</a>                   ; routine GET_DECIMAL

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L06DF">L06DF</a>                ;

        ADD     A,$30                   ; add '0' converting to letter.
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L077B">L077B</a>                   ;
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L06EF">L06EF</a>                ;

        LD      E,$00
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L06FD">L06FD</a>                   ;

<a name="L06EF"></a>L06EF:  AND     $DF                     ;

        CP      $45                     ; is it 'E' - extended format?
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L071C">L071C</a>                ;

        PUSH    HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L074C">L074C</a>                   ;

        RST     18H                     ; pop word DE
        POP     HL
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L071C">L071C</a>                ;

<a name="L06FD"></a>L06FD:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0740">L0740</a>                   ;
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0711">L0711</a>                 ;

        INC     HL
        LD      A,(HL)
        AND     $7F
        ADD     A,E

        JP      M,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L071C">L071C</a>                 ; forward +-&gt;

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L071C">L071C</a>                 ; forward +-&gt;

        XOR     (HL)
        AND     $7F
        XOR     (HL)
        LD      (HL),A
<a name="L0711"></a>L0711:  LD      DE,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1055">L1055</a>                ; stk_fp
<a name="L0714"></a>L0714:  RST     10H                     ; push word DE
        POP     DE
        POP     BC
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07DA">L07DA</a>                   ;
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

; +-&gt;
<a name="L071C"></a>L071C:  POP     HL
        POP     HL
        RST     18H                     ; pop word DE
        RST     18H                     ; pop word DE
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L068A">L068A</a>                   ;

; ----------------------------
; THE <b><font color="#333388">'GET DECIMAL'</font></b> SUBROUTINE
; ----------------------------
; Fetch character and return with carry set if after conversion is not in
; range 0 to 9.

<a name="L0723"></a>L0723:  LD      A,(DE)
        INC     DE
        SUB     $30                     ; subtract '0'
        RET     C                       ; return if was less than '0'

        CP      $0A                     ; compare to ten.
        CCF                             ; complement
        RET     C                       ; return - with carry set if over 9.

; ---------
; normalize?
; ---------
; =&gt; from below only.
<a name="L072C"></a>L072C:  LD      C,A
        LD      A,(HL)
        AND     $F0
        RET     NZ

        LD      A,C

; =&gt; (int/print_fp)
<a name="L0732"></a>L0732:  DEC     HL
        DEC     HL
        LD      C,$03

<a name="L0736"></a>L0736:  RLD                             ;  A = xxxx3210  &lt;--   7654&lt;-3210 (HL)

        INC     HL                      ;
        DEC     C
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0736">L0736</a>                ;

        DEC     (HL)                    ; decrement exponent
        DEC     HL                      ; point to start of BCD nibbles
        CP      A
        RET

; ---

; from ufloat to normalize 6-nibble mantissa

<a name="L0740"></a>L0740:  LD      B,$06                   ; six nibbles

<a name="L0742"></a>L0742:  XOR     A

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L072C">L072C</a>                   ;

        RET     NZ

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0742">L0742</a>                   ;

        INC     HL
        LD      (HL),B

        RET

; ---------------------------
; THE <b><font color="#333388">'GET NUMBER'</font></b> SUBROUTINE
; ---------------------------
; can be called twice by the above code for the word 'NUMBER'.
; Once to get the first number encountered and sometimes, if in extended
; format, the exponent as well.

<a name="L074C"></a>L074C:  RST     10H                     ; push word DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

<a name="L0750"></a>L0750:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data
        DEFB    $2D                     ;  chr '-'
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C4A">L0C4A</a>                   ; =
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DA9">L0DA9</a>                   ; negate
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DD2">L0DD2</a>                   ; +
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
<a name="L0769"></a>L0769:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L078A">L078A</a>                   ; convert
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; R&gt;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D94">L0D94</a>                   ; pos
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

<a name="L0779"></a>L0779:  RST     18H                     ; pop word DE
        LD      A,(DE)

<a name="L077B"></a>L077B:  CP      $20
        RET     Z

        AND     A
        RET

; ------------------
; THE <b><font color="#333388">'CONVERT'</font></b> WORD
; ------------------
; <font color="#CC00FF">(  ud1, addr1 -- ud2, addr2  )</font>
: Accumulates digits from text into an unsigned double length
; number ud1: for each digit, the double length accumulator is
; multiplied by the system number base and the digit (converted
; from ASCII) is added on. The text starts at addr1 + 1. addr2 is
; the address of the first unconvertible character, ud2 is the
; final value of the accumulator.

<a name="L0780"></a>L0780:  DEFM    "CONVER"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L06A8">L06A8</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0789"></a>L0789:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L078A"></a>L078A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L078C"></a>L078C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E09">L0E09</a>                   ; 1+
<a name="L078E"></a>L078E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
<a name="L0790"></a>L0790:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
<a name="L0792"></a>L0792:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
<a name="L0794"></a>L0794:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07B8">L07B8</a>                   ; stk_digit
<a name="L0796"></a>L0796:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch
<a name="L0798"></a>L0798:  DEFW    $001B                   ; to 0799 + 1B = $07B4

<a name="L079A"></a>L079A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
<a name="L079C"></a>L079C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L048A">L048A</a>                   ; get base
<a name="L079E"></a>L079E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
<a name="L07A0"></a>L07A0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA8">L0CA8</a>                   ; u*
<a name="L07A2"></a>L07A2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
<a name="L07A4"></a>L07A4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
<a name="L07A6"></a>L07A6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L048A">L048A</a>                   ; get base
<a name="L07A8"></a>L07A8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
<a name="L07AA"></a>L07AA:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA8">L0CA8</a>                   ; U*
<a name="L07AC"></a>L07AC:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DEE">L0DEE</a>                   ; D+
<a name="L07AE"></a>L07AE:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; R&gt;
<a name="L07B0"></a>L07B0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L07B2"></a>L07B2:  DEFW    $FFD9                   ; loop back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L078C">L078C</a>

<a name="L07B4"></a>L07B4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; R&gt;
<a name="L07B6"></a>L07B6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------------------
; The <b><font color="#333388">'stk_digit'</font></b> Internal Word
; -----------------------------

<a name="L07B8"></a>L07B8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07BA">L07BA</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L07BA"></a>L07BA:  RST     18H                     ; pop word DE

        LD      A,E                     ; character to A

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0807">L0807</a>                   ; to_upper

        ADD     A,$D0                   ; add to give carry with '0' and more.

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07D7">L07D7</a>                ; if less than '0' push byte 0 false.

        CP      $0A                     ; compare to ten.
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07CD">L07CD</a>                 ; forward to stack bytes 0 - 9.

        ADD     A,$EF                   ;
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07D7">L07D7</a>                ; push word false 0.

        ADD     A,$0A

<a name="L07CD"></a>L07CD:  CP      (IX+$3F)                ; compare to BASE
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07D7">L07D7</a>                ; push word false 0.

; else digit is within range of number base

        LD      D,$00
        LD      E,A
        RST     10H                     ; push word DE
        SCF                             ; set carry to signal true

<a name="L07D7"></a>L07D7:  JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; push word 1 or 0

; ---
;       ??
; ---

<a name="L07DA"></a>L07DA:  LD      H,D
        LD      L,E
        INC     BC
        ADD     HL,BC
        PUSH    HL
        BIT     4,(IX+$3E)              ; FLAGS
        CALL    Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L097F">L097F</a>                 ; pr_string

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02B0">L02B0</a>                   ; curs?

        POP     DE
        AND     A
        SBC     HL,DE
        LD      B,H
        LD      C,L
        LD      HL,($3C1E)              ; INSCRN
        INC     HL
        EX      DE,HL
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FB">L07FB</a>                 ;

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FA">L07FA</a>                 ; forward to SPACE_FILL.

        LDIR

; ------------------------
; The <b><font color="#333388">'SPACE FILL'</font></b> routine
; ------------------------
; -&gt; from cls

<a name="L07FA"></a>L07FA:  AND     A                       ; prepare to subtract two screen
                                        ; pointers.

<a name="L07FB"></a>L07FB:  SBC     HL,DE                   ; number of bytes in HL.
        EX      DE,HL                   ; now in DE, HL = start of area.

<a name="L07FE"></a>L07FE:  LD      A,D                     ; check if the
        OR      E                       ; counter is zero.
        RET     Z                       ; return if so.                 &gt;&gt;

        LD      (HL),$20                ; insert a space character.
        INC     HL                      ; next address.
        DEC     DE                      ; decrement byte counter.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FE">L07FE</a>                   ; loop back to exit on zero.

; --------------------------
; THE <b><font color="#333388">'UPPERCASE'</font></b> SUBROUTINE
; --------------------------
; converts characters to uppercase.

<a name="L0807"></a>L0807:  AND     $7F                     ; ignore inverse bit 7
        CP      $61                     ; compare to 'a'
        RET     C                       ; return if lower

        CP      $7B                     ; compare to 'z' + 1
        RET     NC                      ; return if higher than 'z'

        AND     $5F                     ; make uppercase
        RET                             ; return.

; --------------
; THE <b><font color="#333388">'VIS'</font></b> WORD
; --------------
; Allows copy-up mechanism and 'OK'.

<a name="L0812"></a>L0812:  DEFM    "VI"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0789">L0789</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0817"></a>L0817:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0818"></a>L0818:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L081A">L081A</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L081A"></a>L081A:  RES     4,(IX+$3E)              ; update FLAGS signal visible mode.
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ----------------
; THE <b><font color="#333388">'INVIS'</font></b> WORD
; ----------------
; Suppresses copy-up mechanism and 'OK'.

<a name="L0820"></a>L0820:  DEFM    "INVI"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0817">L0817</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0827"></a>L0827:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0828"></a>L0828:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L082A">L082A</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L082A"></a>L082A:  SET     4,(IX+$3E)              ; update FLAGS signal invisible mode.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; ---------------
; THE <b><font color="#333388">'FAST'</font></b> WORD
; ---------------
; Fast mode - runs without error checks.
; Debugged programs run 25% faster.

<a name="L0830"></a>L0830:  DEFM    "FAS"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0827">L0827</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0836"></a>L0836:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0837"></a>L0837:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0839">L0839</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0839"></a>L0839:  LD      IY,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                ; miss memory checks on return

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'SLOW'</font></b> WORD
; ---------------
; <font color="#CC00FF">( -- )</font>
; Slow mode with error checking.
; Make IY point to a return routine that performs housekeeping.


<a name="L083F"></a>L083F:  DEFM    "SLO"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'W' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0836">L0836</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0845"></a>L0845:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>


<a name="L0846"></a>L0846:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0848">L0848</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0848"></a>L0848:  LD      IY,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04C8">L04C8</a>                ; set vector to memory checks each pass

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------------------------
; THE <b><font color="#333388">'DATA STACK TO BC'</font></b> SUBROUTINE
; ---------------------------------
; Called on twenty occasions to fetch a word from the Data Stack into the
; BC register pair. Very similar to RST 18H which does the same thing with the
; DE register pair as the destination on 73 occasions.
; In fact, as two Z80 restarts are unused, then 40 bytes of ROM code could have
; been saved by making this a restart also.

<a name="L084E"></a>L084E:  LD      HL,($3C3B)              ; fetch SPARE - start of Spare Memory.
        DEC     HL                      ; decrement to point to last stack item
        LD      B,(HL)                  ; load high byte to B.
        DEC     HL                      ; address low byte of word.
        LD      C,(HL)                  ; and load to C.
        LD      ($3C3B),HL              ; update the system variable SPARE to
                                        ; a location two bytes less than it was.
        RET                             ; return.

; -----------------------------------------
; THE <b><font color="#333388">'CONTINUATION OF THE RST 18H'</font></b> RESTART
; -----------------------------------------
; complete the operation of popping a word to DE from the data stack.

<a name="L0859"></a>L0859:  DEC     HL                      ;
        LD      E,(HL)                  ;
        LD      ($3C3B),HL              ; update SPARE
        RET                             ; return.

; -----------------------------------------
; THE <b><font color="#333388">'CONTINUATION OF THE RST 10H'</font></b> RESTART
; -----------------------------------------
; complete the operation of pushing a word in DE to the data stack.

<a name="L085F"></a>L085F:  LD      (HL),D                  ;
        INC     HL                      ;
        LD      ($3C3B),HL              ; update SPARE
        RET                             ; return.

; --------------
; THE <b><font color="#333388">'DUP'</font></b> WORD
; --------------
; <font color="#CC00FF">( n -- n, n )</font>
; Duplicates the top of the stack.

<a name="L0865"></a>L0865:  DEFM    "DU"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0845">L0845</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L086A"></a>L086A:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L086B"></a>L086B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086D">L086D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L086D"></a>L086D:  RST     18H                     ; unstack Data Word DE
        RST     10H                     ; stack Data Word DE
        RST     10H                     ; stack Data Word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'DROP'</font></b> WORD
; ---------------
; <font color="#CC00FF">( n -- )</font>
; Throws away the top of the stack.

<a name="L0872"></a>L0872:  DEFM    "DRO"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086A">L086A</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0878"></a>L0878:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0879"></a>L0879:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L087B">L087B</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L087B"></a>L087B:  RST     18H                     ; unstack Data Word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'SWAP'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n1, n2 -- n2, n1)</font>

<a name="L087E"></a>L087E:  DEFM    "SWA"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0878">L0878</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0884"></a>L0884:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0885"></a>L0885:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0887">L0887</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0887"></a>L0887:  RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        RST     10H                     ; push word DE
        LD      D,B                     ;
        LD      E,C                     ;
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'C@'</font></b> WORD
; -------------
; <font color="#CC00FF">(address -- byte)</font>
; Fetches the contents of a given address.

<a name="L0891"></a>L0891:  DEFB    'C'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '@' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0884">L0884</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0895"></a>L0895:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0896"></a>L0896:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0898">L0898</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0898"></a>L0898:  RST     18H                     ; pop word DE
        LD      A,(DE)
        LD      E,A
        LD      D,$00

        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'C!'</font></b> WORD
; -------------
; <font color="#CC00FF">(n, address -- )</font>
; Stores the less significant byte on n at a given address.

<a name="L08A0"></a>L08A0:  DEFB    'C'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '!' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0895">L0895</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08A4"></a>L08A4:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08A5"></a>L08A5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08A7">L08A7</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L08A7"></a>L08A7:  RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        LD      A,C
        LD      (DE),A

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'@'</font></b> WORD
; ------------
; <font color="#CC00FF">(address -- n)</font>
; Leaves on stack the single length integer at the given address.

<a name="L08AF"></a>L08AF:  DEFB    '@' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08A4">L08A4</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08B2"></a>L08B2:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08B3"></a>L08B3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B5">L08B5</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L08B5"></a>L08B5:  RST     18H                     ; pop word DE

        EX      DE,HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)

        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'!'</font></b> WORD
; ------------
; <font color="#CC00FF">(n,address --)</font>
; Stores the single-length integer n at the given address in memory.

<a name="L08BD"></a>L08BD:  DEFB    '!' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B2">L08B2</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08C0"></a>L08C0:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08C1"></a>L08C1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C3">L08C3</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L08C3"></a>L08C3:  RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        EX      DE,HL
        LD      (HL),C
        INC     HL
        LD      (HL),B

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'&gt;R'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- )</font>
; Transfers top entry on data stack to return stack.
; It can be copied back using 'I'.

<a name="L08CD"></a>L08CD:  DEFB    '&gt;'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C0">L08C0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08D1"></a>L08D1:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08D2"></a>L08D2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D4">L08D4</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L08D4"></a>L08D4:  RST     18H
        POP     BC
        PUSH    DE
        PUSH    BC
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'R&gt;'</font></b> WORD
; -------------
; <font color="#CC00FF">( -- entry from return stack)</font>
; Transfers top entry on return stack to data stack.

<a name="L08DA"></a>L08DA:  DEFB    'R'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&gt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D1">L08D1</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08DE"></a>L08DE:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08DF"></a>L08DF:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08E1">L08E1</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L08E1"></a>L08E1:  POP     BC
        POP     DE
        PUSH    BC
        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'?DUP'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n -- n, n)</font>    if n!=0.
; <font color="#CC00FF">(n -- n)</font>       if n=0.

<a name="L08E7"></a>L08E7:  DEFM    "?DU"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DE">L08DE</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08ED"></a>L08ED:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08EE"></a>L08EE:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08F0">L08F0</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---


<a name="L08F0"></a>L08F0:  RST     18H                     ; fetch word DE
        RST     10H                     ; push it back
        LD      A,D                     ; test if fetched
        OR      E                       ; word is zero
        CALL    NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0010">L0010</a>                ; push word DE if non-zero
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'ROT'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2, n3 -- n2, n3, n1)</font>

<a name="L08F9"></a>L08F9:  DEFM    "RO"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08ED">L08ED</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L08FE"></a>L08FE:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L08FF"></a>L08FF:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0901"></a>L0901:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
<a name="L0903"></a>L0903:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
<a name="L0905"></a>L0905:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; R&gt;
<a name="L0907"></a>L0907:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
<a name="L0909"></a>L0909:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'OVER'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n1, n2 -- n1, n2, n1)</font>

<a name="L090B"></a>L090B:  DEFM    "OVE"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FE">L08FE</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0911"></a>L0911:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0912"></a>L0912:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0914"></a>L0914:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
<a name="L0916"></a>L0916:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
<a name="L0918"></a>L0918:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; R&gt;
<a name="L091A"></a>L091A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
<a name="L091C"></a>L091C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'PICK'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n1 -- n2)</font>
; Copies the n1-th stack entry (after dropping n1 itself) to the top.
; Error 7 if n1 &lt;= 0.

<a name="L091E"></a>L091E:  DEFM    "PIC"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'K' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0911">L0911</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0924"></a>L0924:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0927">L0927</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0927"></a>L0927:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L094D">L094D</a>                   ;
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'ROLL'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n -- )</font>
; Extracts the nth stack value to the top of the stack, after dropping n
; itself, and moves the remaining values down to fill the vacated position.
; Error 7 if n &lt;= 0.

<a name="L092C"></a>L092C:  DEFM    "ROL"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'L' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0924">L0924</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0932"></a>L0932:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0933"></a>L0933:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0935">L0935</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0935"></a>L0935:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L094D">L094D</a>                   ;
        EX      DE,HL
        LD      HL,($3C37)              ; STKBOT
        SBC     HL,DE
        JP      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04D7">L04D7</a>                ; jump back to Error 2

        LD      H,D
        LD      L,E
        INC     HL
        INC     HL
        LDIR
        LD      ($3C3B),DE              ; SPARE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L094D"></a>L094D:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        DEC     BC
        SLA     C
        RL      B
        INC     BC
        INC     BC
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L095B">L095B</a>                ; skip the error routine

        RST     20H                     ; <b><font color="#FF0000">Error 7</font></b>
        DEFB    $07                     ; PICK or ROLL used with operand 0
                                        ; or negative

; ---

<a name="L095B"></a>L095B:  LD      HL,($3C3B)              ; SPARE
        SBC     HL,BC
        PUSH    HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)
        RST     10H                     ; push word DE
        POP     HL
        RET

; ---------------
; THE <b><font color="#333388">'TYPE'</font></b> WORD
; ---------------
; <font color="#CC00FF">(address, n -- )</font>
; EMITs n characters from memory starting at the address.


<a name="L0967"></a>L0967:  DEFM    "TYP"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0932">L0932</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L096D"></a>L096D:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L096E"></a>L096E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0970">L0970</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0970"></a>L0970:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L097F">L097F</a>                   ; routine pr_string (below)

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------------------
; THE <b><font color="#333388">'PRINT STRING'</font></b> ROUTINE
; --------------------------
; The first entry point prints strings embedded in the Dictionary with the
; DE pointing to the preceding length word.
;
; The second entry point prints a string with length in BC and start in DE.
; It is called by TYPE above and to print comment fields.

; -&gt;

<a name="L0979"></a>L0979:  LD      A,(DE)
        LD      C,A
        INC     DE
        LD      A,(DE)
        LD      B,A
        INC     DE

; --&gt;
<a name="L097F"></a>L097F:  LD      A,B
        OR      C
        RET     Z

        LD      A,(DE)
        INC     DE
        DEC     BC
        RST     08H                     ; print_ch

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L097F">L097F</a>                   ;

; -------------
; THE <b><font color="#333388">'&lt;#'</font></b> WORD
; -------------
; <font color="#CC00FF">(  --  )</font>
; Initiates formatted output.

<a name="L0988"></a>L0988:  DEFB    '&lt;'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '#' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L096D">L096D</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L098C"></a>L098C:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L098D"></a>L098D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L098F">L098F</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L098F"></a>L098F:  LD      HL,$27FF                ; end of pad
        LD      ($3C1A),HL              ; update system variable HLD
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'#&gt;'</font></b> WORD
; -------------
; <font color="#CC00FF">(ud -- address, n)</font>
; Finishes formatted output, leaving the address and length (n) of the
; resultant string.

<a name="L0997"></a>L0997:  DEFB    '#'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&gt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L098C">L098C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L099B"></a>L099B:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L099C"></a>L099C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L099E">L099E</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L099E"></a>L099E:  RST     18H                     ; pop word DE
        RST     18H                     ; pop word DE
        LD      DE,($3C1A)              ; HLD
        RST     10H                     ; push word DE (address)
        LD      HL,$27FF                ; end of pad.
        AND     A                       ; prepare to subtract.
        SBC     HL,DE                   ; find length of string.
        EX      DE,HL                   ; transfer to DE
        RST     10H                     ; push word DE (n)

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'.'</font></b> WORD
; ------------
;

<a name="L09AF"></a>L09AF:  DEFB    '.' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A49">L0A49</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L09B2"></a>L09B2:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L09B3"></a>L09B3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L09B5"></a>L09B5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L098D">L098D</a>                   ; &lt;#
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0D">L0C0D</a>                   ; abs
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09E1">L09E1</a>                   ; #s
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A4A">L0A4A</a>                   ; sign

<a name="L09C3"></a>L09C3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L099C">L099C</a>                   ; #&gt;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L096E">L096E</a>                   ; type
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A73">L0A73</a>                   ; space
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -------------
; THE <b><font color="#333388">'U.'</font></b> WORD
; -------------
; <font color="#CC00FF">(un -- )</font>
; Prints the unsigned single length integer 'un' to the television screen,
; followed by a space.

<a name="L09CB"></a>L09CB:  DEFB    'U'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '.' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09B2">L09B2</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L09CF"></a>L09CF:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L09D0"></a>L09D0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L09D2"></a>L09D2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero
<a name="L09D4"></a>L09D4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L098D">L098D</a>                   ; &lt;#
<a name="L09D6"></a>L09D6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09E1">L09E1</a>                   ; #S
<a name="L09D8"></a>L09D8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L09DA"></a>L09DA:  DEFW    $FFE8                   ; -&gt; 09C3


; -------------
; THE <b><font color="#333388">'#S'</font></b> WORD
; -------------
; <font color="#CC00FF">(ud -- 0,0)</font>
; Applies # repeatedly (at least once) until the double length number left
; on the stack is 0.

<a name="L09DC"></a>L09DC:  DEFB    '#'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09CF">L09CF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L09E0"></a>L09E0:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L09E1"></a>L09E1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L09E3"></a>L09E3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09F7">L09F7</a>                   ; #
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E36">L0E36</a>                   ; or
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C1A">L0C1A</a>                   ; 0=
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128D">L128D</a>                   ; ?branch

<a name="L09EF"></a>L09EF:  DEFW    $FFF3                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09E3">L09E3</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ------------
; THE <b><font color="#333388">'#'</font></b> WORD
; ------------
; <font color="#CC00FF">(ud1 -- ud2)</font>
; used in formatted output. Generates one digit from the unsigned double
; length integer ud1 and holds it in the pad. The unsigned double length
; integer ud2 is the quotient when ud1 is divided by the number base.

<a name="L09F3"></a>L09F3:  DEFB    '#' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09E0">L09E0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L09F6"></a>L09F6:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L09F7"></a>L09F7:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L09F9"></a>L09F9:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L048A">L048A</a>                   ; get base
<a name="L09FB"></a>L09FB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
<a name="L09FD"></a>L09FD:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CC4">L0CC4</a>                   ; div?
<a name="L09FF"></a>L09FF:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
<a name="L0A01"></a>L0A01:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A07">L0A07</a>                   ; stk-char
<a name="L0A03"></a>L0A03:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A5C">L0A5C</a>                   ; hold
<a name="L0A05"></a>L0A05:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------------------
; The <b><font color="#333388">'stk-char'</font></b> Internal Word
; ----------------------------
; used from above thread.

<a name="L0A07"></a>L0A07:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A09">L0A09</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L0A09"></a>L0A09:  RST     18H                     ; data stack to DE
        LD      A,E                     ; character to A
        ADD     A,$30                   ; convert digit to ASCII
        CP      $3A                     ; compare to '9'
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A13">L0A13</a>                 ; forward if digit
        ADD     A,$07                   ; else add for hex

<a name="L0A13"></a>L0A13:  LD      E,A                     ; back to E
        RST     10H                     ; push ASCII on data stack.
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'CLS'</font></b> WORD
; --------------
; <font color="#CC00FF">( -- )</font>
; Clears the screen and sets the print position to the top left of
; the screen.

<a name="L0A17"></a>L0A17:  DEFM    "CL"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09F6">L09F6</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A1C"></a>L0A1C:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A1F">L0A1F</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A1F"></a>L0A1F:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A24">L0A24</a>                   ; routine CLS below.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; --------------------
; THE <b><font color="#333388">'CLS'</font></b> SUBROUTINE
; --------------------
; Called from the 'CLS' word definition above and also from the initialization
; routine.

<a name="L0A24"></a>L0A24:  LD      DE,$26FF                ; point destination to end of video
                                        ; memory.
        LD      HL,($3C24)              ; set HL to first byte of input buffer
                                        ; from system variable L_HALF.
                                        ; (at initialization $26E0).

        LD      BC,$0020                ; set count to thirty two.

        ADD     HL,BC                   ; add to the low address.
        DEC     HL                      ; step back and
        LDDR                            ; copy the 32 bytes.

; while BC is zero, set the plotting coordinates.

        LD      ($3C2F),BC              ; set XCOORD and YCOORD to zero.

; set the screen position to the start of video memory.

        LD      HL,$2400                ; start of the 768 bytes of video RAM.
        LD      ($3C1C),HL              ; set system variable SCRPOS.

        INC     DE                      ; the byte before logical line.
        EX      DE,HL                   ; transfer to HL.
        LD      ($3C24),HL              ; set L_HALF.
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FA">L07FA</a>                   ; jump back to fill the locations
                                        ; from DE to HL -1 with spaces.

; ---------------
; THE <b><font color="#333388">'SIGN'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n -- )</font>
; In formatted output, holds a minus sign in the pad if n is negative.


<a name="L0A43"></a>L0A43:  DEFM    "SIG"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'N' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L099B">L099B</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A49"></a>L0A49:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0A4A"></a>L0A4A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A4C">L0A4C</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A4C"></a>L0A4C:  RST     18H                     ; pop word DE
        RL      D                       ; test sign bit
        LD      E,$2D                   ; prepare a '-'
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A5F">L0A5F</a>                 ; forward if minus
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'HOLD'</font></b> WORD
; ---------------
; <font color="#CC00FF">(character -- )</font>
; Used in formatted output to hold the character in the pad.

<a name="L0A55"></a>L0A55:  DEFM    "HOL"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

<a name="L0A59"></a>L0A59:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A1C">L0A1C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A5B"></a>L0A5B:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0A5C"></a>L0A5C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A5E">L0A5E</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A5E"></a>L0A5E:  RST     18H                     ; data stack to DE

<a name="L0A5F"></a>L0A5F:  LD      HL,($3C1A)              ; HLD
        DEC     L
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A69">L0A69</a>                 ; forward when full

        LD      ($3C1A),HL              ; update HLD
        LD      (HL),E                  ; and place character in buffer

<a name="L0A69"></a>L0A69:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ----------------
; THE <b><font color="#333388">'SPACE'</font></b> WORD
; ----------------
; <font color="#CC00FF">(  --  )</font>
; EMITs a space.

<a name="L0A6B"></a>L0A6B:  DEFM    "SPAC"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A5B">L0A5B</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A72"></a>L0A72:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0A73"></a>L0A73:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A75">L0A75</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A75"></a>L0A75:  LD      A,$20                   ; load accumulator with the ASCII
                                        ; code for space.
        RST     08H                     ; print_ch

<a name="L0A78"></a>L0A78:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -----------------
; THE <b><font color="#333388">'SPACES'</font></b> WORD
; -----------------
; <font color="#CC00FF">(n -- )</font>
; EMITs n spaces if n &gt;= 1.

<a name="L0A7A"></a>L0A7A:  DEFM    "SPACE"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A72">L0A72</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A82"></a>L0A82:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A85">L0A85</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A85"></a>L0A85:  RST     18H                     ; fetch stack data to DE

<a name="L0A86"></a>L0A86:  DEC     DE                      ; decrement the counter.
        BIT     7,D                     ; test for a negative value
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A78">L0A78</a>                ; back to a jp iy  when done    &gt;&gt;

        LD      A,$20                   ; prepare a space
        RST     08H                     ; print it
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A86">L0A86</a>                   ; loop back for more.

; -------------
; THE <b><font color="#333388">'CR'</font></b> WORD
; -------------
; Outputs a carriage return character to the television.

<a name="L0A90"></a>L0A90:  DEFB    'C'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A82">L0A82</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0A94"></a>L0A94:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0A95"></a>L0A95:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A97">L0A97</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0A97"></a>L0A97:  LD      A,$0D                   ; prepare a CR
        RST     08H                     ; print it.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'EMIT'</font></b> WORD
; ---------------
; <font color="#CC00FF">(character -- )</font>
; writes the character to the television screen.

<a name="L0A9C"></a>L0A9C:  DEFM    "EMI"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0A94">L0A94</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0AA2"></a>L0AA2:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0AA3"></a>L0AA3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0AA5">L0AA5</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0AA5"></a>L0AA5:  RST     18H                     ; pop de off data stack
        LD      A,E                     ; character to A
        RST     08H                     ; print it.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; -------------
; THE <b><font color="#333388">'F.'</font></b> WORD
; -------------
; <font color="#CC00FF">(f -- )</font>
; print a floating point number.
; If 1.0E-4 &lt;= f &lt; 1.0E9, then f is printed without an exponent and with a
; decimal point in the appropriate place. If f is outside this range, then
; it is printed in standard form f'En where 0 &lt;= f' &lt; 10 and -64 &lt;= n &lt;= 62.
; Input may be either form, but only six significant digits are accepted -
; further digits are ignored.
; Floating point numbers are stored as 3 bytes of binary coded decimal
; mantissa and 1 byte for sign and decimal exponents.
;
; e.g. the number 123.456 on Data Stack would be two words, four bytes.
;
;       ^       43              01000011   bits 5 - 0 are exponent
;       |       12      BCD     ||
;       |       34      BCD     |sign of exponent 1=positive (bit 6)
;       |       56      BCD     sign of number 0=positive (bit 7)
;
; Zero 0. is a special case floating point number with all four bytes set
; to zero.


<a name="L0AAA"></a>L0AAA:  DEFB    'F'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '.' + $80

        DEFW    $0AA2                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0AAE"></a>L0AAE:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0AAF"></a>L0AAF:  DEFW    $0AB1                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0AB1"></a>L0AB1:  LD      HL,($3C3B)              ; set pointer from system variable SPARE
        DEC     HL                      ; now points to last byte of data stack.
        BIT     7,(HL)                  ; test sign of number.
        RES     7,(HL)                  ; reset the sign bit.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ABE">L0ABE</a>                 ; forward if initially positive.

        LD      A,$2D                   ; prepare  the '-' character.
        RST     08H                     ; print the minus sign.

; The E register is initialized to zero to denote not E-FORMAT

<a name="L0ABE"></a>L0ABE:  LD      E,$00                   ; signal not scientific notation.

        LD      A,(HL)                  ; fetch exponent byte
        DEC     A                       ; adjust to make zero $FF

        CP      $49                     ; compare to +9   e.g.  123456000.
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ACA">L0ACA</a>                ; skip forward if out of range.

        CP      $3C                     ; compare to -4   e.g  .000123456
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ACE">L0ACE</a>                ; skip forward if in range.

; else E format printing will be used with decimal point after first digit.

<a name="L0ACA"></a>L0ACA:  LD      (HL),$41                ; make Data Stack exponent +1
        INC     A                       ; restore true exponent byte
        LD      E,A                     ; transfer to E.

; the branch was here when within range for normal printing.

<a name="L0ACE"></a>L0ACE:  LD      A,$40                   ; test value is plus zero.
        SUB     (HL)                    ; subtract signed exponent.
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ADC">L0ADC</a>                 ; forward if positive

; exponent is negative so decimal point comes first. e.g. .001

        LD      B,A                     ; result of subtraction to B.
        INC     B                       ; B is now one less than count of
                                        ; leading zeros.

        LD      A,$2E                   ; prepare '.'

<a name="L0AD7"></a>L0AD7:  RST     08H                     ; print decimal point or zero.

        LD      A,$30                   ; prepare a zero - '0'

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0AD7">L0AD7</a>                   ; loop back to print leading zeros
                                        ; unless the counter was 1.

; the branch was here with positive exponent (and zero)
; now enter a loop to print each of the leading BCD digits
; the loop will end when the exponent is &lt;= +0 and all 6 nibbles contain zero.

<a name="L0ADC"></a>L0ADC:  LD      A,$40                   ; set accumulator to plus 0
        CP      (HL)                    ; compare to exponent on data stack.
        SBC     A,A                     ; $FF if more leading digits else $00.
        DEC     HL                      ; address first two nibbles.
        OR      (HL)                    ; combine.
        DEC     HL                      ; address next two nibbles.
        OR      (HL)                    ; combine.
        DEC     HL                      ; address last two nibbles.
        OR      (HL)                    ; combine.

        INC     HL                      ; adjust the pointer to
        INC     HL                      ; the start of the mantissa.

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0AFC">L0AFC</a>                 ; forward if all digits have been
                                        ; printed.

; else print each binary coded decimal in turn.

        XOR     A                       ; prepare to feed a zero nibble in.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0732">L0732</a>                   ; routine shift_fp extracts the most
                                        ; significant nibble from the 3 bytes
                                        ; also decrementing the exponent.

        ADD     A,$30                   ; convert to ASCII
        RST     08H                     ; print digit

        INC     HL                      ; point to reduced exponent.
        LD      A,(HL)                  ; fetch to accumulator and
        CP      $40                     ; compare to zero.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ADC">L0ADC</a>                ; loop back while more digits.

; else this is the place to print the mid or trailing decimal point.

        LD      A,$2E                   ; prepare '.'
        RST     08H                     ; print it.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ADC">L0ADC</a>                   ; loop back for end test and any digits
                                        ; following the decimal point.

; ---

; the branch was to here when all digits of the mantissa have been printed.

<a name="L0AFC"></a>L0AFC:  LD      A,E                     ; fetch the exponent format flag - from
                                        ; the E register appropriately.
        AND     A                       ; test for zero - normal format.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B05">L0B05</a>                ; forward to E_FORMAT if not.

        LD      A,$20                   ; else prepare a space
        RST     08H                     ; print it

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B10">L0B10</a>                   ; forward to delete the two words from
                                        ; the data stack and exit.

; ---

; this branch deals with scientific notation. The accumulator holds the
; original exponent. $01-$3C (negative) $49-$7F (positive).

<a name="L0B05"></a>L0B05:  SUB     $41                     ; convert to signed 8-bit.
        LD      L,A                     ; low order byte to L.
        SBC     A,A                     ; $FF negative or $00 positive
        LD      H,A                     ; set the high order byte.

        LD      A,$45                   ; prepare a 'E'
        RST     08H                     ; print it

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L180E">L180E</a>                   ; routine pr_int_hl prints the signed
                                        ; integer followed by a space.

; finally delete the floating point number from the Data Stack.


<a name="L0B10"></a>L0B10:  RST     18H                     ; unstack word DE
        RST     18H                     ; unstack word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'AT'</font></b> WORD
; -------------
; <font color="#CC00FF">(line, column -- )</font>
; Sets print position to line and column numbers on the stack.
; There are 23 lines (0 to 22) and 32 columns (0 to 31). The
; column number is taken modulo 32, and ERROR 9 if trying to print
; in the input buffer at the bottom.

<a name="L0B14"></a>L0B14:  DEFB    'A'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0AAE">L0AAE</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0B18"></a>L0B18:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B1B">L0B1B</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0B1B"></a>L0B1B:  RST     18H                     ; pop word DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      A,C

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B28">L0B28</a>                   ;

        LD      ($3C1C),HL              ; update system variable SCRPOS

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

; plotsub

<a name="L0B28"></a>L0B28:  ADD     A,$20
        LD      L,A
        LD      H,$01
        ADD     HL,HL
        ADD     HL,HL
        ADD     HL,HL
        ADD     HL,HL
        ADD     HL,HL
        LD      D,$00
        LD      A,E
        AND     $1F
        LD      E,A
        ADD     HL,DE
        LD      DE,($3C24)              ; fetch start of lower half from L_HALF
        SBC     HL,DE
        ADD     HL,DE
        RET     C

;

        RST     20H                     ; <b><font color="#FF0000">Error 9</font></b>
        DEFB    $09                     ; Erroneous 'AT' Command.

; ---------------
; THE <b><font color="#333388">'PLOT'</font></b> WORD
; ---------------
; <font color="#CC00FF">(x, y, n -- )</font>
; Plots pixel (x, y) with plot mode n.
; n =   0       unplot
;       1       plot
;       2       move
;       3       change
; If n&gt;3, takes value modulo 4.

<a name="L0B43"></a>L0B43:  DEFM    "PLO"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B18">L0B18</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0B49"></a>L0B49:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B4C">L0B4C</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0B4C"></a>L0B4C:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        RST     18H                     ; pop word DE
        LD      (IX+$30),E              ; YCOORD
        SRL     E
        RL      C
        LD      A,$16                   ; 24
        SUB     E

        RST     18H                     ; pop word DE
        LD      (IX+$2F),E              ; XCOORD
        SRL     E
        RL      C

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B28">L0B28</a>                   ;

        LD      A,(HL)
        AND     $78                     ; 01111000
        CP      $10
        LD      A,(HL)
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B6F">L0B6F</a>                 ;

        LD      A,$10

<a name="L0B6F"></a>L0B6F:  LD      E,A
        LD      D,$87
        LD      A,C
        AND     $03
        LD      B,A
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B7F">L0B7F</a>                 ;

        CPL

        ADD     A,$02
        ADC     A,$03
        LD      D,A
        LD      B,E
<a name="L0B7F"></a>L0B7F:  LD      A,C
        RRCA
        RRCA
        RRCA
        SBC     A,A
        BIT     3,C
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B8C">L0B8C</a>                ;
        XOR     E
        RLCA
        SBC     A,A
        XOR     B

<a name="L0B8C"></a>L0B8C:  AND     D
        XOR     E
        LD      (HL),A
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'BEEP'</font></b> WORD
; ---------------
; <font color="#CC00FF">( m, n --  )</font>
; Plays a note on the loudspeaker. 8 * m = period in microseconds,
; n = time in milliseconds.

<a name="L0B91"></a>L0B91:  DEFM    "BEE"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B49">L0B49</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0B97"></a>L0B97:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b>  m, n.

; ---

<a name="L0B9A"></a>L0B9A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; OVER          m, n, m.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data      m, n, m, 125.
        DEFB    $7D                     ;  (125)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; SWAP          m, n, 125, m.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D7A">L0D7A</a>                   ; */            m, (n*125)/m
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end

; ---

<a name="L0BA5"></a>L0BA5:  RST     18H                     ; pop word DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      HL,$00F9                ;
        ADD     HL,BC                   ;
        INC     L                       ;

        DI                              ; Disable Interrupts.

<a name="L0BAF"></a>L0BAF:  LD      A,$7F                   ; place $7FFE on address bus and read
        IN      A,($FE)                 ; from port, pushing the loudspeaker
                                        ; diaphragm in.

        RRCA                            ; test the read 'SPACE' key bit.

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BC7">L0BC7</a>                ; forward if BREAK pressed.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BC9">L0BC9</a>                   ; routine delay_HL

        DEC     DE                      ; decrement counter.

        LD      A,D                     ; all even addresses are reserved for
                                        ; Jupiter Ace so any value does for the
                                        ; high order byte. $FE is low value.

        OUT     ($FE),A                 ; push the loudspeaker diaphragm out.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BC9">L0BC9</a>                   ; routine delay_HL

        OR      E                       ; test for counter DE reaching zero.
        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BAF">L0BAF</a>                ; loop back if not.

        EI                              ; Enable Interrupts.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L0BC7"></a>L0BC7:  RST     20H                     ; <b><font color="#FF0000">Error 3</font></b>
        DEFB    $03                     ; BREAK pressed.

; ---------------------------
; THE <b><font color="#333388">'BEEP DELAY'</font></b> SUBROUTINE
; ---------------------------
; called twice from the above BEEP routine.

<a name="L0BC9"></a>L0BC9:  LD      B,L                     ; transfer the value of
        LD      C,H                     ; the HL register to BC.

<a name="L0BCB"></a>L0BCB:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BCB">L0BCB</a>                   ; self-loop for B times

        DEC     B                       ; set B to $FF for future loops
        DEC     C                       ; decrement outer loop counter C
        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BCB">L0BCB</a>                ; JUMP back if not zero           (10)

        RET                             ; return

; ----------------
; THE <b><font color="#333388">'INKEY'</font></b> WORD
; ----------------
; <font color="#CC00FF">( -- ASCII code)</font>
; Reads the keyboard. Puts ASCII value on the stack if a key is pressed, 0
; otherwise.


<a name="L0BD3"></a>L0BD3:  DEFM    "INKE"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'Y' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0B97">L0B97</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0BDA"></a>L0BDA:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0BDB"></a>L0BDB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BDD">L0BDD</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0BDD"></a>L0BDD:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0336">L0336</a>                   ; routine KEY-SCAN

        LD      E,A                     ; transfer the key code to E.
        LD      D,$00                   ; make high order byte zero.

        RST     10H                     ; stack Data Word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'IN'</font></b> WORD
; -------------
; <font color="#CC00FF">(port address -- data byte)</font>
; Inputs a data byte from an I/O port.

<a name="L0BE6"></a>L0BE6:  DEFB    'I'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'N' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BDA">L0BDA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0BEA"></a>L0BEA:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BED">L0BED</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0BED"></a>L0BED:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        LD      D,$00                   ; make high order byte zero.

        IN      E,(C)                   ; read the port to E.

        RST     10H                     ; stack Data Word DE.

<a name="L0BF5"></a>L0BF5:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'OUT'</font></b> WORD
; --------------
; <font color="#CC00FF">(data byte, port address -- )</font>
; Outputs a data byte to an I/O port.

<a name="L0BF7"></a>L0BF7:  DEFM    "OU"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BEA">L0BEA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0BFC"></a>L0BFC:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BFF">L0BFF</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0BFF"></a>L0BFF:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
                                        ; all 16 bits are placed on the
                                        ; Z80A address bus.
        RST     18H                     ; pop word DE

        OUT     (C),E                   ; output byte to port address.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'ABS'</font></b> WORD
; --------------
; <font color="#CC00FF">(n -- absolute value of n)</font>

<a name="L0C07"></a>L0C07:  DEFM    "AB"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0BFC">L0BFC</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C0C"></a>L0C0C:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C0D"></a>L0C0D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; DUP
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D94">L0D94</a>                   ; pos
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; EXIT

; -------------
; THE <b><font color="#333388">'0='</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- flag)</font>
; flag is 1 in n = 0.

<a name="L0C15"></a>L0C15:  DEFB    '0'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '=' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0C">L0C0C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C19"></a>L0C19:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C1A"></a>L0C1A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C1C">L0C1C</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C1C"></a>L0C1C:  RST     18H                     ; pop word DE
        LD      A,D                     ; test for
        OR      E                       ; zero
        CP      $01                     ; sets carry if word is zero

; -&gt; zero_or_one

<a name="L0C21"></a>L0C21:  LD      A,$00                   ; make accumulator zero.
        LD      D,A                     ; set D to zero
        RLA                             ; pick up carry (1/0)
        LD      E,A                     ; set DE to one or zero
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'0&lt;'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- flag)</font>
; flag is 1 if n is negative

<a name="L0C29"></a>L0C29:  DEFB    '0'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&lt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C19">L0C19</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C2D"></a>L0C2D:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C2E"></a>L0C2E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C30">L0C30</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C30"></a>L0C30:  RST     18H                     ; pop word DE
        RL      D                       ; test the sign bit.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; back to above routine to stack the
                                        ; carry as one (true) or zero (false).

; -------------
; THE <b><font color="#333388">'0&gt;'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- flag)</font>
; flag is 1 if n is positive.


<a name="L0C35"></a>L0C35:  DEFB    '0'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&gt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C2D">L0C2D</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C39"></a>L0C39:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C3A"></a>L0C3A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C3C">L0C3C</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C3C"></a>L0C3C:  RST     18H                     ; pop word DE
        LD      A,D
        OR      E
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                 ; to stack word one or zero

        RL      D
        CCF
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; to stack word one or zero

; ------------
; THE <b><font color="#333388">'='</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- flag)</font>
; flag is 1 if n1=n2.

<a name="L0C46"></a>L0C46:  DEFB    '=' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C39">L0C39</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C49"></a>L0C49:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C4A"></a>L0C4A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0C4C"></a>L0C4C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DE1">L0DE1</a>                   ; -
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C1A">L0C1A</a>                   ; 0=
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ------------
; THE <b><font color="#333388">'&gt;'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- flag)</font>
; flag is 1 if n1&gt;n2.

<a name="L0C52"></a>L0C52:  DEFB    '&gt;' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C49">L0C49</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C55"></a>L0C55:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C56"></a>L0C56:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C58">L0C58</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C58"></a>L0C58:  RST     18H                     ; pop word DE
        PUSH    DE                      ;
        RST     18H                     ; pop word DE
        POP     HL                      ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C99">L0C99</a>                   ;

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; to stack word one or zero

; ------------
; THE <b><font color="#333388">'&lt;'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- flag)</font>
; flag is 1 if n1 &lt; n2.

<a name="L0C61"></a>L0C61:  DEFB    '&lt;' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C55">L0C55</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C64"></a>L0C64:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C65"></a>L0C65:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C56">L0C56</a>                   ; &gt;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; -------------
; THE <b><font color="#333388">'U&lt;'</font></b> WORD
; -------------
; <font color="#CC00FF">(un1, un2 -- flag)</font>
; The flag is 1 if, of the two unsigned single length integers, un1 is less
; than un2.

<a name="L0C6D"></a>L0C6D:  DEFB    'U'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&lt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C64">L0C64</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C71"></a>L0C71:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C72"></a>L0C72:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C74">L0C74</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C74"></a>L0C74:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

<a name="L0C77"></a>L0C77:  RST     18H                     ; pop word DE
        EX      DE,HL
        AND     A
        SBC     HL,BC
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; to stack word one or zero

; -------------
; THE <b><font color="#333388">'D&lt;'</font></b> WORD
; -------------
; <font color="#CC00FF">(d1, d2 -- flag)</font>
; flag is 1 if the signed double integer, d1 &lt; d2.

<a name="L0C7E"></a>L0C7E:  DEFB    'D'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&lt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C71">L0C71</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0C82"></a>L0C82:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0C83"></a>L0C83:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C85">L0C85</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0C85"></a>L0C85:  RST     18H                     ; pop word DE
        PUSH    DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        RST     18H                     ; pop word DE
        POP     HL
        AND     A
        SBC     HL,DE
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C77">L0C77</a>                 ;

        ADD     HL,DE
        EX      DE,HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C99">L0C99</a>                   ;

        RST     18H                     ; pop word DE
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C21">L0C21</a>                   ; to stack word one or zero

; ---
; THE <b><font color="#333388">'sign?'</font></b> SUBROUTINE
; ---

<a name="L0C99"></a>L0C99:  LD      A,H
        XOR     D
        JP      M,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA0">L0CA0</a>                 ;

        SBC     HL,DE

<a name="L0CA0"></a>L0CA0:  RL      H
        RET

; -------------
; THE <b><font color="#333388">'U*'</font></b> WORD
; -------------
; <font color="#CC00FF">(un1, un2 -- double length(un1 * un2)</font>)
; Multiplies two unsigned single length integers to give an unsigned
; double length product.

<a name="L0CA3"></a>L0CA3:  DEFB    'U'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '*' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C82">L0C82</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0CA7"></a>L0CA7:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0CA8"></a>L0CA8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CAA">L0CAA</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; =&gt; mult

<a name="L0CAA"></a>L0CAA:  RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        LD      HL,$0000
        LD      A,$10
<a name="L0CB3"></a>L0CB3:  ADD     HL,HL
        EX      DE,HL
        ADC     HL,HL
        EX      DE,HL
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CBE">L0CBE</a>                ;

        ADD     HL,BC
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CBE">L0CBE</a>                ;

        INC     DE

<a name="L0CBE"></a>L0CBE:  DEC     A
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CB3">L0CB3</a>                ;

        EX      DE,HL
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CF3">L0CF3</a>                   ;

; ---
; The <b><font color="#333388">'div?'</font></b> Internal Word
; ---

<a name="L0CC4"></a>L0CC4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CC6">L0CC6</a>

<a name="L0CC6"></a>L0CC6:  RST     18H                     ; pop word DE
        EXX
        RST     18H                     ; pop word DE
        PUSH    DE
        RST     18H                     ; pop word DE
        POP     HL
        LD      A,H
        OR      L
        LD      A,$21                   ; 33
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CD5">L0CD5</a>                ;

        EX      DE,HL
        LD      A,$11                   ; 17

<a name="L0CD5"></a>L0CD5:  EXX
        LD      B,A
        XOR     A
        LD      H,A
        LD      L,A
        LD      C,A

<a name="L0CDB"></a>L0CDB:  ADC     HL,HL
        SBC     A,A
        AND     A
        SBC     HL,DE
        SBC     A,C
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CE5">L0CE5</a>                ;
        ADD     HL,DE

<a name="L0CE5"></a>L0CE5:  CCF
        EXX
        EX      DE,HL
        ADC     HL,HL
        EX      DE,HL
        ADC     HL,HL
        EXX
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CDB">L0CDB</a>                   ;

        EX      DE,HL
        RST     10H                     ; push word DE
        EXX

<a name="L0CF3"></a>L0CF3:  PUSH    HL
        RST     10H                     ; push word DE
        POP     DE
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------
; THE <b><font color="#333388">'/MOD'</font></b> WORD
; ---------------
; <font color="#CC00FF">(n1, n2 -- remainder, quotient of n1/n2)</font>
; The remainder has the same sign as the dividend n1.

<a name="L0CF9"></a>L0CF9:  DEFM    "/MO"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA7">L0CA7</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0CFF"></a>L0CFF:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D00"></a>L0D00:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0D02"></a>L0D02:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12E9">L12E9</a>                   ; I
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0D">L0C0D</a>                   ; abs
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $00                     ; zero
; -&gt;
<a name="L0D0D"></a>L0D0D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12E9">L12E9</a>                   ; I
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E60">L0E60</a>                   ; xor
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0D">L0C0D</a>                   ; abs
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D8C">L0D8C</a>                   ; U/MOD
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D94">L0D94</a>                   ; pos
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D94">L0D94</a>                   ; pos
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'*/MOD'</font></b> WORD
; ----------------
; <font color="#CC00FF">(n1, n2, n3 -- remainder, quotient of (n1 * n2)</font>/n3)
; As in */, n1 * n2 is held to double length.

<a name="L0D29"></a>L0D29:  DEFM    "*/MO"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CFF">L0CFF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D30"></a>L0D30:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D31"></a>L0D31:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12E9">L12E9</a>                   ; I
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0D">L0C0D</a>                   ; abs
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08FF">L08FF</a>                   ; rot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08DF">L08DF</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E60">L0E60</a>                   ; xor
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08D2">L08D2</a>                   ; &gt;R
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C0D">L0C0D</a>                   ; abs
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA8">L0CA8</a>                   ; u*
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch

<a name="L0D4B"></a>L0D4B:  DEFW    $FFC1                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D0D">L0D0D</a>  (in /MOD)




; ------------
; THE <b><font color="#333388">'/'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- n1/n2)</font>
; Single length signed integer division.

<a name="L0D4D"></a>L0D4D:  DEFB    '/' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D30">L0D30</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D50"></a>L0D50:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D51"></a>L0D51:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0D53"></a>L0D53:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D00">L0D00</a>                   ; /MOD
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; --------------
; THE <b><font color="#333388">'MOD'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2 -- remainder n1/n2)</font>
; The remainder has the same sign as the dividend.

<a name="L0D5B"></a>L0D5B:  DEFM    "MO"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D50">L0D50</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D60"></a>L0D60:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D61"></a>L0D61:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D00">L0D00</a>                   ; /MOD
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; ------------
; THE <b><font color="#333388">'*'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- n1*n2)</font>

<a name="L0D69"></a>L0D69:  DEFB    '*' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D60">L0D60</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D6C"></a>L0D6C:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CA8">L0CA8</a>                   ; u*
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; -------------
; THE <b><font color="#333388">'*/'</font></b> WORD
; -------------
; <font color="#CC00FF">(n1, n2, n3 -- (n1*n2)</font>/n3)
; The intermediate product n1*n2 is held to double length.

<a name="L0D75"></a>L0D75:  DEFB    '*'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '/' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D6C">L0D6C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D79"></a>L0D79:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D7A"></a>L0D7A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D31">L0D31</a>                   ; */MOD
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; --------------
; THE <b><font color="#333388">'U/MOD'</font></b> WORD
; --------------
; <font color="#CC00FF">(ud1, un2 -- un3, un4)</font>
; In unsigned arithmetic throughout, divides the double length integer ud1
; by the single length integer un2 to give a single length remainder un3
; and a single length quotient un4.

<a name="L0D84"></a>L0D84:  DEFM    "U/MO"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D79">L0D79</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0D8B"></a>L0D8B:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0D8C"></a>L0D8C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0D8E"></a>L0D8E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0CC4">L0CC4</a>                   ; div?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

; make positive

<a name="L0D94"></a>L0D94:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0D96"></a>L0D96:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C2E">L0C2E</a>                   ; 0&lt;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch               (if false)
<a name="L0D9A"></a>L0D9A:  DEFW    $0003                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D9E">L0D9E</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DA9">L0DA9</a>                   ; negate

<a name="L0D9E"></a>L0D9E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------
; THE <b><font color="#333388">'NEGATE'</font></b> WORD
; -----------------
; <font color="#CC00FF">(n -- -n)</font>


<a name="L0DA0"></a>L0DA0:  DEFM    "NEGAT"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' +$80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D8B">L0D8B</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0DA8"></a>L0DA8:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0DA9"></a>L0DA9:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DAB">L0DAB</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0DAB"></a>L0DAB:  LD      BC,$0002                ;
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DBF">L0DBF</a>                   ;

; ------------------
; THE <b><font color="#333388">'DNEGATE'</font></b> WORD
; ------------------
; <font color="#CC00FF">(d -- -d)</font>
; Double length integer negation.

<a name="L0DB0"></a>L0DB0:  DEFM    "DNEGAT"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' +$80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DA8">L0DA8</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0DB9"></a>L0DB9:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0DBA"></a>L0DBA:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DBC">L0DBC</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0DBC"></a>L0DBC:  LD      BC,$0004

; NEGATE joins here with bc=2

<a name="L0DBF"></a>L0DBF:  LD      HL,($3C3B)              ; SPARE
        AND     A
        SBC     HL,BC

<a name="L0DC5"></a>L0DC5:  LD      A,B
        SBC     A,(HL)
        LD      (HL),A
        INC     HL
        DEC     C
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DC5">L0DC5</a>                ;

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'+'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- n1 + n2)</font>

<a name="L0DCE"></a>L0DCE:  DEFB    '+' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DB9">L0DB9</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0DD1"></a>L0DD1:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0DD2"></a>L0DD2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DD4">L0DD4</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0DD4"></a>L0DD4:  RST     18H                     ; pop word DE
        PUSH    DE                      ; save on machine stack
        RST     18H                     ; pop word DE
        POP     HL                      ; first number to HL

        ADD     HL,DE                   ; the actual addition

        EX      DE,HL                   ; result to DE
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'-'</font></b> WORD
; ------------
; <font color="#CC00FF">(n1, n2 -- n1-n2)</font>
; flip the sign and do a plus.

<a name="L0DDD"></a>L0DDD:  DEFB    '-' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DD1">L0DD1</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0DE0"></a>L0DE0:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0DE1"></a>L0DE1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0DE3"></a>L0DE3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DA9">L0DA9</a>                   ; negate
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DD2">L0DD2</a>                   ; +
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -------------
; THE <b><font color="#333388">'D+'</font></b> WORD
; -------------
; <font color="#CC00FF">(d1, d2 -- d1 + d2)</font>
; double length integer addition.

<a name="L0DE9"></a>L0DE9:  DEFB    'D'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '+' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DE0">L0DE0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0DED"></a>L0DED:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0DEE"></a>L0DEE:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DF0">L0DF0</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0DF0"></a>L0DF0:  RST     18H                     ; pop word DE

        PUSH    DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        RST     18H                     ; pop word DE
        PUSH    DE
        RST     18H                     ; pop word DE
        EX      DE,HL
        ADD     HL,BC
        EX      DE,HL
        RST     10H                     ; push word DE
        POP     BC
        POP     HL
        ADC     HL,BC
        EX      DE,HL
        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'1+'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- n+1)</font>

<a name="L0E04"></a>L0E04:  DEFB    '1'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '+' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DED">L0DED</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E08"></a>L0E08:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E09"></a>L0E09:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E0B">L0E0B</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E0B"></a>L0E0B:  RST     18H                     ; get word 'n' in DE
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E17">L0E17</a>                   ; forward to increment and stack

; -------------
; THE <b><font color="#333388">'2+'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- n+2)</font>

<a name="L0E0E"></a>L0E0E:  DEFB    '2'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '+' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E08">L0E08</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E12"></a>L0E12:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E13"></a>L0E13:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E15">L0E15</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E15"></a>L0E15:  RST     18H                     ; get word 'n' in DE.
        INC     DE                      ; increment n                   (4)
; -&gt;
<a name="L0E17"></a>L0E17:  INC     DE                      ; increment n                   (4)
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E2E">L0E2E</a>                   ; forward to push word DE and exit

; -------------
; THE <b><font color="#333388">'1-'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- n-1)</font>


<a name="L0E1A"></a>L0E1A:  DEFB    '1'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '-' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E12">L0E12</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E1E"></a>L0E1E:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E1F"></a>L0E1F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E21">L0E21</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E21"></a>L0E21:  RST     18H                     ;
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E2D">L0E2D</a>                   ;

; -------------
; THE <b><font color="#333388">'2-'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- n-2)</font>


<a name="L0E24"></a>L0E24:  DEFB    '2'                     ; <b><font color="#3030dd">'name field'</font></b>
<a name="L0E25"></a>L0E25:  DEFB    '-' + $80

<a name="L0E26"></a>L0E26:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1E">L0E1E</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E28"></a>L0E28:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E29"></a>L0E29:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E2B">L0E2B</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

;
<a name="L0E2B"></a>L0E2B:  RST     18H
        DEC     DE

; -&gt;
<a name="L0E2D"></a>L0E2D:  DEC     DE

; -&gt;
<a name="L0E2E"></a>L0E2E:  RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'OR'</font></b> WORD
; -------------
; <font color="#CC00FF">(n1, n2 -- n1 OR n2)</font>
; Bitwise Boolean operation.


<a name="L0E31"></a>L0E31:  DEFB    'O'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E28">L0E28</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E35"></a>L0E35:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E36"></a>L0E36:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E38">L0E38</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E38"></a>L0E38:  RST     18H                     ; pop word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      A,E                     ;
        OR      C                       ; OR low order bytes
        LD      E,A                     ;

        LD      A,D                     ;
        OR      B                       ; OR high order bytes
        LD      D,A                     ;

        RST     10H                     ; push word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'AND'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2 -- n1 AND n2)</font>
; Bitwise Boolean operation.


<a name="L0E45"></a>L0E45:  DEFM    "AN"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E35">L0E35</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E4A"></a>L0E4A:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E4D">L0E4D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E4D"></a>L0E4D:  RST     18H
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      A,E                     ;
        AND     C                       ;
        LD      E,A                     ;

        LD      A,D                     ;
        AND     B                       ;
        LD      D,A                     ;

        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'XOR'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2 -- n1 XOR n2)</font>
; Bitwise Boolean XOR (exclusive or)

<a name="L0E5A"></a>L0E5A:  DEFM    "XO"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E4A">L0E4A</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E5F"></a>L0E5F:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E60"></a>L0E60:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E62">L0E62</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0E62"></a>L0E62:  RST     18H
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      A,E                     ;
        XOR     C                       ;
        LD      E,A                     ;

        LD      A,D                     ;
        XOR     B                       ;
        LD      D,A                     ;

        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'MAX'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2 -- max (n1, n2)</font>)
; Calculates the larger of two numbers.

<a name="L0E72"></a>L0E72:  DEFM    "MA"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'X' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E5F">L0E5F</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E74"></a>L0E74:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0E75"></a>L0E75:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0E77"></a>L0E77:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C65">L0C65</a>                   ; &lt;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1271">L1271</a>                   ; branch
<a name="L0E7F"></a>L0E7F:  DEFW    $000F                   ; forward to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E8F">L0E8F</a>

; --------------
; THE <b><font color="#333388">'MIN'</font></b> WORD
; --------------
; <font color="#CC00FF">(n1, n2 -- min (n1, n2)</font>)
; Calculates the smaller of two numbers.

<a name="L0E81"></a>L0E81:  DEFM    "MI"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'N' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E74">L0E74</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0E86"></a>L0E86:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0E89"></a>L0E89:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0912">L0912</a>                   ; over
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C56">L0C56</a>                   ; &gt;
; -&gt;
<a name="L0E8F"></a>L0E8F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch
<a name="L0E91"></a>L0E91:  DEFW    $0003                   ; forward to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0995">L0995</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap

<a name="L0995"></a>L0995:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0879">L0879</a>                   ; drop
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ------------------
; THE <b><font color="#333388">'DECIMAL'</font></b> WORD
; ------------------
; <font color="#CC00FF">(  --  )</font>
; Sets the system number base to ten.

<a name="L0E99"></a>L0E99:  DEFM    "DECIMA"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'L' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E86">L0E86</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0EA2"></a>L0EA2:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EA5">L0EA5</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0EA5"></a>L0EA5:  LD      (IX+$3F),$0A            ; update system variable BASE to 10

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">':'</font></b> WORD
; ------------
; Introduces colon definitions.

<a name="L0EAB"></a>L0EAB:  DEFB    ':' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EA2">L0EA2</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0EAE"></a>L0EAE:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0EAF"></a>L0EAF:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

<a name="L0EB1"></a>L0EB1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; do_colon

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $0A                     ; ten                   marker byte?
; -&gt;
<a name="L0EB6"></a>L0EB6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end_forth

<a name="L0EB8"></a>L0EB8:  LD      HL,$3C3E                ; FLAGS

        LD      A,(HL)                  ; update bits 6 and 2.
        OR      $44                     ; signal in compile mode, definition
                                        ; incomplete.
        LD      (HL),A                  ; update FLAGS.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

x0EC1   DEFB    $E9                     ;;
x0Ec2   DEFB    $FF                     ;; 0ec2 + ffe9 =  0eab = ':'

; -------------------------------
; THE <b><font color="#333388">'ENTER'</font></b> or 'DOCOLON' action
; -------------------------------
;

<a name="L0EC3"></a>L0EC3:  EX      DE,HL                   ;
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BA">L04BA</a>                   ;


; -----------------
; THE <b><font color="#333388">'CREATE'</font></b> WORD
; -----------------
; CREATE name
; <font color="#CC00FF">(  --  )</font>
; Defines a new word with a header and an empty parameter field.
; When executed, the new word stacks its parameter field address.

<a name="L0EC7"></a>L0EC7:  DEFM    "CREAT"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EAE">L0EAE</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0ECF"></a>L0ECF:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0ED0"></a>L0ED0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0ED2"></a>L0ED2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $20                     ; a space               delimiter
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05AB">L05AB</a>                   ; word to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EFB">L0EFB</a>                   ; get-name              in dict
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero              link
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0480">L0480</a>                   ; current
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0499">L0499</a>                   ; pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@            fetch 1 byte
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5F">L0F5F</a>                   ; C,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    $0FEC                   ; ???
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
<a name="L0EF9"></a>L0EF9:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------------------
; The <b><font color="#333388">'get_name'</font></b> Internal Word
; ----------------------------
; Used only by the above CREATE thread.

<a name="L0EFB"></a>L0EFB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EFD">L0EFD</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L0EFD"></a>L0EFD:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F2E">L0F2E</a>                   ; blank stack

        RST     18H                     ; pop word DE

        LD      A,(DE)
        DEC     A                       ; zero becomes $FF
        CP      $3F                     ; max length is 64
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F09">L0F09</a>                 ; forward if n range 1 - 64.

        RST     20H                     ; <b><font color="#FF0000">Error 6</font></b>
        DEFB    $06                     ; Name of new word too short or long.

; ---

<a name="L0F09"></a>L0F09:  ADD     A,$08                   ; allow for prev/len/addr 3 missing

        LD      C,A                     ;
        LD      B,$00                   ; length to BC

<a name="L0F0E"></a>L0F0E:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F8C">L0F8C</a>                   ; check free memory.

x0f11   LD      A,(DE)                  ; true length to A
        LD      C,A                     ; and BC again

        LD      HL,($3C37)              ; STKBOT

        PUSH    DE                      ;
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F9E">L0F9E</a>                   ; routine MAKE ROOM
        POP     DE                      ;

        LD      A,(DE)                  ; length of word in pad
        LD      B,A                     ; transfer to counter.

<a name="L0F1D"></a>L0F1D:  INC     DE                      ; increase source
        LD      A,(DE)                  ; fetch character

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0807">L0807</a>                   ; to_upper makes uppercase.

        LD      (HL),A                  ; store in dictionary
        INC     HL                      ; increase destination
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F1D">L0F1D</a>                   ; loop back for all letters.

        LD      ($3C39),HL              ; store this location in SPARE
        DEC     HL                      ; step back to last letter of word.
        SET     7,(HL)                  ; and 'invert' it.
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---


<a name="L0F2E"></a>L0F2E:  BIT     2,(IX+$3E)              ; test FLAGS incomplete definition ?
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F36">L0F36</a>                 ; forward if not.

        RST     20H                     ; <b><font color="#FF0000">Error 12</font></b>
        DEFB    $0C                     ; Incomplete definition in dictionary.

; ---

<a name="L0F36"></a>L0F36:  LD      HL,($3C37)              ; fetch STKBOT
        LD      DE,($3C39)              ; fetch SPARE

        XOR     A                       ; clear accumulator and carry flag

        SBC     HL,DE                   ; subtract

        EX      DE,HL                   ;
        LD      (HL),E                  ; place low byte at next STACK slot.
        INC     HL                      ;
        LD      (HL),D                  ; place high byte
        LD      H,A                     ; make HL zero
        LD      L,A                     ;
        LD      ($3C39),HL              ; update system variable SPARE to zero

        RET                             ; return

; ---------------------

; ------------
; THE <b><font color="#333388">','</font></b> WORD
; ------------
; <font color="#CC00FF">( n --   )</font>
; Encloses the single length integer in the dictionary.

<a name="L0F4A"></a>L0F4A:  DEFB    ',' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ECF">L0ECF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0F4D"></a>L0F4D:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0F4E"></a>L0F4E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0F50"></a>L0F50:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E29">L0E29</a>                   ; 2-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; -------------
; THE <b><font color="#333388">'C,'</font></b> WORD
; -------------
; <font color="#CC00FF">( n --   )</font>
; Encloses the less significant byte of n in the dictionary.

<a name="L0F5A"></a>L0F5A:  DEFB    'C'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    ',' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4D">L0F4D</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0F5E"></a>L0F5E:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0F5F"></a>L0F5F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L0F61"></a>L0F61:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data
        DEFB    $01                     ; one
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F76">L0F76</a>                   ; allot

x0f66   DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08A5">L08A5</a>                   ; C!
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'ALLOT'</font></b> WORD
; ----------------
; <font color="#CC00FF">(n -- )</font>
; Encloses n bytes in the dictionary, without initializing them.

<a name="L0F6E"></a>L0F6E:  DEFM    "ALLO"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5E">L0F5E</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0F75"></a>L0F75:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0F76"></a>L0F76:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F78">L0F78</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L0F78"></a>L0F78:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        LD      HL,($3C37)              ; STKBOT
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F9E">L0F9E</a>                   ; routine MAKE ROOM
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------------------
; The <b><font color="#333388">'allot2'</font></b> Internal Word
; --------------------------
; Encloses 2 bytes in the dictionary, without initializing them.

<a name="L0F83"></a>L0F83:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b> - docolon

; ---

<a name="L0F85"></a>L0F85:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $02                     ; two bytes required
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F76">L0F76</a>                   ; allot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------------------------
; THE <b><font color="#333388">'DEFAULT MEMORY CHECK'</font></b> ROUTINE
; ----------------------------------
; called each cycle in slow mode to check free memory.

<a name="L0F8C"></a>L0F8C:  LD      HL,$001E                ; Allow a thirty byte overhead.

; ----------------------------------
; THE <b><font color="#333388">'CHECK FREE MEMORY'</font></b> SUBROUTINE
; ----------------------------------

<a name="L0F8F"></a>L0F8F:  PUSH    BC                      ; save bytes to check.

        ADD     HL,BC                   ;
        LD      BC,($3C3B)              ; SPARE
        ADD     HL,BC                   ; carry indicates error - past 65535

        POP     BC                      ; restore number of bytes
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F9C">L0F9C</a>                 ; forward with error

        SBC     HL,SP                   ; now check against the return stack
                                        ; (machine stack)
        RET     C                       ; return if value is less

<a name="L0F9C"></a>L0F9C:  RST     20H                     ; <b><font color="#FF0000">Error 1</font></b>
        DEFB    $01                     ; Not enough memory

; --------------------------
; THE <b><font color="#333388">'MAKE ROOM'</font></b> SUBROUTINE
; --------------------------

<a name="L0F9E"></a>L0F9E:  EX      DE,HL                   ; first new location to DE
        LD      HL,$0028                ; overhead 40 bytes.

<a name="L0FA2"></a>L0FA2:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F8F">L0F8F</a>                   ; check free memory.

; now increase the two data stack pointers.

        LD      HL,($3C37)              ; fetch value of STKBOT
        ADD     HL,BC                   ; add required room.
        LD      ($3C37),HL              ; update STKBOT.

        LD      HL,($3C3B)              ; fetch value of SPARE
        PUSH    HL                      ; take a copy of 'old' value
        ADD     HL,BC                   ; add required room.
        LD      ($3C3B),HL              ; update SPARE.

        EX      (SP),HL                 ; new SPARE value to stack,
                                        ; old SPARE value to HL.
        PUSH    HL                      ; push old SPARE value.
        AND     A                       ; clear carry.

        SBC     HL,DE                   ; get length of stack and 12
        LD      B,H                     ;
        LD      C,L                     ;
        POP     HL                      ; old spare
        POP     DE                      ; new spare
        RET     Z                       ; return if same.

; else new SPARE must be higher than old spare.

        DEC     HL                      ; point to end of data stack
        DEC     DE                      ; adjust destination.
        LDDR                            ; copy the Data Stack + gap upwards.

<a name="L0FC2"></a>L0FC2:  INC     HL                      ; point to first new location.

        RET                             ; return.

; -------------------
; THE <b><font color="#333388">'VARIABLE'</font></b> WORD
; -------------------
; VARIABLE name
; <font color="#CC00FF">(n -- )</font>
; Sets up a variable with the given name, and initializes its value to n.

<a name="L0FC4"></a>L0FC4:  DEFM    "VARIABL"               ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F75">L0F75</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0FCE"></a>L0FCE:  DEFB    $08                     ; <b><font color="#3030dd">'name length field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

<a name="L0FD1"></a>L0FD1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF0">L0FF0</a>                   ; push word DE
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -------------------
; THE <b><font color="#333388">'CONSTANT'</font></b> WORD
; -------------------
; CONSTANT name
; <font color="#CC00FF">(n -- )</font>
; Defines a constant with the given name and value n.

<a name="L0FD7"></a>L0FD7:  DEFM    "CONSTAN"               ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FCE">L0FCE</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L0FE1"></a>L0FE1:  DEFB    $08                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L0FE2"></a>L0FE2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

<a name="L0FE4"></a>L0FE4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF5">L0FF5</a>                   ; pad??
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---
; ???

x0fea   DEFB    $DC                     ;;
x0feb   DEFB    $FE                     ;;  0feb + fedc = 0Ec7 = CREATE

; -&gt;
<a name="L0FEC"></a>L0FEC:  JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF0">L0FF0</a>                   ; skip forward

x0fee   DEFB    $D5                     ;;
x0fef   DEFB    $FF                     ;;  0fef + ffd5 = 0fc4 = VARIABLE

; ---

<a name="L0FF0"></a>L0FF0:  RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

x0FF3   DEFB    $E3                     ;;
x0ff4   DEFB    $FF                     ;;  0ff4 + ffe3 = 0fd7 = CONSTANT

; --&gt; pad

<a name="L0FF5"></a>L0FF5:  EX      DE,HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)
        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------------
; THE <b><font color="#333388">'LITERAL'</font></b> WORD
; ------------------
; <font color="#CC00FF">(n -- )</font>
; Compiles the top of the stack into a word definition as a literal.
; Compiles integers. decimal 4102 = $1006. c.f. $1055

<a name="L0FFC"></a>L0FFC:  DEFM    "LITERA"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'L' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FE1">L0FE1</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1005"></a>L1005:  DEFB    $47                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1006"></a>L1006:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L1008"></a>L1008:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x100E:  DEFB    $02                     ;;
x100f   DEFB    $FF                     ;; 100f + ff02 = 0f11 nah!
x1010   DEFB    $FF                     ;;

; -----------------------------------
; The <b><font color="#333388">'Stack Next Word'</font></b> Internal Word
; -----------------------------------

<a name="L1011"></a>L1011:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1013">L1013</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1013"></a>L1013:  LD      B,$01                   ; counter - one word to push

<a name="L1015"></a>L1015:  POP     HL                      ; drop the 'Next Word' pointer.
        LD      E,(HL)                  ; low byte to E.
        INC     HL                      ; increment pointer.
        LD      D,(HL)                  ; high byte to D.

; -&gt; E B=1 (one byte op)

<a name="L1019"></a>L1019:  INC     HL                      ; increment the 'Next Word' pointer

<a name="L101A"></a>L101A:  PUSH    HL                      ; the 'Next Word' pointer goes to
                                        ; the Return Stack.
        RST     10H                     ; stack Data Word DE
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1015">L1015</a>                   ; loop back if more than one.

<a name="L101E"></a>L101E:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; ----------------
; THE <b><font color="#333388">'ASCII'</font></b> WORD
; ----------------
; Takes the next word from the input buffer, and yields the ASCII code
; of its first character. If compiling, then compiles this as a literal.
;
; e.g.      :STARS 0 DO ASCII * EMIT LOOP ;
; <font color="#CC00FF">(--ASCII code)</font>         (if interpreting)
; <font color="#CC00FF">(--)</font>                   (if compiling)

<a name="L1020"></a>L1020:  DEFM    "ASCI"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'I' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1005">L1005</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1027"></a>L1027:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1029"></a>L1029:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ----------------

<a name="L102A"></a>L102A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $20                     ; space delimiter
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05AB">L05AB</a>                   ; word  to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E09">L0E09</a>                   ; 1+
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0896">L0896</a>                   ; C@
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        BIT     6,(IX+$3E)              ; FLAGS
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L101E">L101E</a>                 ; back to a jp (iy)

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

<a name="L103E"></a>L103E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; (stk_data)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5F">L0F5F</a>                   ; c,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x1048   DEFB    $01                     ;; ?

x1049   DEFB    $D6                     ;; ?
x104a   DEFB    $FF                     ;; ?  104a + ffd6 = 1020 = ASCII

; ----------------------------
; The <b><font color="#333388">'stk-data'</font></b> Internal Word
; ----------------------------
; used succinctly to stack the following byte as a word.

<a name="L104B"></a>L104B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104D">L104D</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L104D"></a>L104D:  POP     HL                      ; retrieve the 'Next Word' pointer.

        LD      E,(HL)                  ; fetch the single byte from there.
        LD      D,$00                   ; set high order byte to zero.

        LD      B,$01                   ; set counter to 1.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1019">L1019</a>                   ; back to stack one word and
                                        ; put the incremented pointer back on
                                        ; the Return Stack.

; --------------------------
; The <b><font color="#333388">'stk_fp'</font></b> Internal Word
; --------------------------
; stack and enclose a floating point number - two words.

<a name="L1055"></a>L1055:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1064">L1064</a>                   ; stack two words.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit
; ---

x1061   DEFB    $04                     ;;
x1062   DEFB    $FF                     ;; 1062 + ff04 = 0f66 XX
x1063   DEFB    $FF                     ;;

; -----------------------------------
; The <b><font color="#333388">'STACK TWO WORDS'</font></b> Internal Word
; -----------------------------------

<a name="L1064"></a>L1064:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1066">L1066</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1066"></a>L1066:  LD      B,$02                   ; set counter to two

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1015">L1015</a>                   ; back to stack 2 words


; -----------------
; THE <b><font color="#333388">'DEFINER'</font></b> WORD
; -----------------
; Used with 'DOES&gt;' to define new defining words. i.e. words that themselves
; define new words.
; The format is
; DEFINER name
;       defining routine
; DOES&gt;
;       action routine
; ;
; name is the name of the new defining word; when executed it will set up
; the header of a new word and use its defining routine to set up the
; parameter field. When this new word in its turn is executed, its parameter
; field will be put on the stack and the action routine will be executed.

<a name="L106A"></a>L106A:  DEFM    "DEFINE"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1027">L1027</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1073"></a>L1073:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1074"></a>L1074:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

<a name="L1076"></a>L1076:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; create and enclose
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data

        DEFB    $0C                     ; 12                    marker byte

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L1081"></a>L1081:  DEFW    $FE34                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EB6">L0EB6</a>

; ---

x1083   DEFB    $E6                     ;;
x1084   DEFB    $FF                     ;; 1084 + ffe6 = 106a = DEFINER

; ---
<a name="L1085"></a>;; <b>create</b>e and fill
; ----
; used seven times as a code word.

L1085:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF0">L0FF0</a>                   ; push word DE (save addr nxt wrd on DS)

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0ED0">L0ED0</a>                   ; create
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E29">L0E29</a>                   ; 2-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !

<a name="L1094"></a>L1094:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E13">L0E13</a>                   ; 2+
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L109A">L109A</a>                   ; pop DE
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------
; pop word DE
; -----------
; branch to addr on stack???

<a name="L109A"></a>L109A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L109C">L109C</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L109C"></a>L109C:  RST     18H                     ; unstack Data Word DE

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; start new thread.

; ---------------
; THE <b><font color="#333388">'CALL'</font></b> WORD
; ---------------
; <font color="#CC00FF">(address -- )</font>
; Executes Z80 machine code at address on the stack. The code is terminated
; by a jp (iy)
; e.g. in hex
; DEFINER CODE DOES&gt; CALL ;
; CODE EI FB C, FD C, E9 C,
; The word EI will enable interrupts.

<a name="L10A0"></a>L10A0:  DEFM    "CAL"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'L' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1073">L1073</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L10A6"></a>L10A6:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L10A7"></a>L10A7:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10A9">L10A9</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L10A9"></a>L10A9:  RST     18H
        EX      DE,HL

        JP      (HL)

; ----------------
; THE <b><font color="#333388">'DOES&gt;'</font></b> WORD
; ----------------
; See DEFINER.

<a name="L10AC"></a>L10AC:  DEFM    "DOES"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&gt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10F4">L10F4</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L10B3"></a>L10B3:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L10B4"></a>L10B4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

<a name="L10B6"></a>L10B6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10E8">L10E8</a>                   ; exit

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check??

        DEFB    $0C                     ; 12

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10CD">L10CD</a>                   ;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data

        DEFB    $CD                     ; data                  call ?

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5F">L0F5F</a>                   ; C,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF0">L0FF0</a>                   ; (push word DE)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data

        DEFB    $0A                     ; ten                   marker byte.

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L10CD"></a>L10CD:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E29">L0E29</a>                   ; 2-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15B5">L15B5</a>                   ; namefield
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DE1">L0DE1</a>                   ; -
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x10e5   DEFB    $05                     ;;

x10e6   DEFB    $C5                     ;;
x10e7   DEFB    $FF                     ;; 10e7 + ffc5 = 10ac = DOES&gt;

; ---

<a name="L10E8"></a>L10E8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B8">L04B8</a>                   ; exit?

; -------------------
; THE <b><font color="#333388">'COMPILER'</font></b> WORD
; -------------------
; Used with 'RUNS&gt;' for defining new compiling words, i.e. words that are
; used within word definitions to give an immediate effect of compiling
; some information into the dictionary.
; (This is traditionally done with IMMEDIATE, but COMPILER...RUNS&gt; works
; better with EDIT etc.)

<a name="L10EA"></a>L10EA:  DEFM    "COMPILE"               ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'R' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10A6">L10A6</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L10F4"></a>L10F4:  DEFB    $08                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L10F5"></a>L10F5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; compile
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1160">L1160</a>                   ; immediate
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data

<a name="L10FF"></a>L10FF:  DEFB    $0B                     ; 11                    marker byte

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L1104"></a>L1104:  DEFW    $FDB1                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EB6">L0EB6</a>

; ---

x1106   DEFB    $E3                     ;;
x1107   DEFB    $FF                     ;; 1107 + ffe3 = 10ea = COMPILER

; ---------------------
; THE <b><font color="#333388">'COMPILE'</font></b> ROUTINE
; ---------------------
; Instead of executing code words as they are encountered, lay them down in
; the dictionary along with any parameters.

<a name="L1108"></a>L1108:  BIT     6,(IX+$3E)              ; test FLAGS - compiler mode ?
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1110">L1110</a>                ; skip error if so.

        RST     20H                     ; <b><font color="#FF0000">Error 4.</font></b>
        DEFB    $04                     ; Compiling word used in interpret mode.

<a name="L1110"></a>L1110:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0FF0">L0FF0</a>                   ; push word DE (then jp (iy))

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L111B"></a>L111B:  DEFW    $FF78                   ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1094">L1094</a> - definer code

; ----------------
; THE <b><font color="#333388">'RUNS&gt;'</font></b> WORD
; ----------------
; See COMPILER

<a name="L111D"></a>L111D:  DEFM    "RUNS"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '&gt;' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10B3">L10B3</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1124"></a>L1124:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1125"></a>L1125:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L1127"></a>L1127:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1140">L1140</a>                   ; vv
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $0B                     ; 11                    marker byte.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5F">L0F5F</a>                   ; c,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10CD">L10CD</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1142">L1142</a>
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data
        DEFB    $0A                     ; ten.                  marker byte.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x113d   DEFB    $05                     ;;

x113e   DEFB    $DE                     ;;
x113f   DEFB    $FF                     ;; 113f + ffde = 111d = RUNS&gt;

; ---

<a name="L1140"></a>L1140:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B8">L04B8</a>

<a name="L1142"></a>L1142:  POP     HL
        PUSH    DE
        EX      DE,HL

        RST     10H                     ; push word DE
        LD      B,D
        LD      C,E
        POP     DE
        PUSH    DE
        DEC     DE
        DEC     DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L159E">L159E</a>                   ;

        POP     DE
        PUSH    BC
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ;

; --------------------
; THE <b><font color="#333388">'IMMEDIATE'</font></b> WORD
; --------------------
; <font color="#CC00FF">(  --  )</font>
; The most recent word in the current vocabulary is made immediate, so that
; it will execute even in compile mode.

<a name="L1154"></a>L1154:  DEFM    "IMMEDIAT"              ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1124">L1124</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L115F"></a>L115F:  DEFB    $09                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1160"></a>L1160:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L1162"></a>L1162:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0480">L0480</a>                   ; current
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

<a name="L116A"></a>L116A:  RST     18H                     ; pop word DE
        EX      DE,HL
        SET     6,(HL)
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---------------------
; THE <b><font color="#333388">'VOCABULARY'</font></b> WORD
; ---------------------
; <font color="#CC00FF">(  --  )</font>
; Defines a new vocabulary with the given name.

<a name="L1170"></a>L1170:  DEFM    "VOCABULAR"             ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'Y' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L115F">L115F</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L117C"></a>L117C:  DEFB    $0A                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L117D"></a>L117D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; <b><font color="#3030dd">'code field'</font></b> - create and enclose

; ---

<a name="L117F"></a>L117F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11B5">L11B5</a>                   ; set context
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0480">L0480</a>                   ; current
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E13">L0E13</a>                   ; 2+
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0688">L0688</a>                   ; stk-zero
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F5F">L0F5F</a>                   ; C,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    $3C35                   ; (VOCLNK)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------------
; THE <b><font color="#333388">'DEFINITIONS'</font></b> WORD
; ----------------------
; <font color="#CC00FF">(  --  )</font>
; The CONTEXT vocabulary is made the CURRENT vocabulary as well.

<a name="L119D"></a>L119D:  DEFM    "DEFINITION"            ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'S' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L117C">L117C</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L11AA"></a>L11AA:  DEFB    $0B                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L11AB"></a>L11AB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11AD">L11AD</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L11AD"></a>L11AD:  LD      HL,($3C33)              ; CONTEXT
        LD      ($3C31),HL              ; CURRENT
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L11B5"></a>L11B5:  LD      ($3C33),DE              ; CONTEXT
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

; -------------
; THE <b><font color="#333388">'IF'</font></b> WORD
; -------------
; <font color="#CC00FF">(n -- )</font>
; Used in the form
; IF ... THEN
; or
; IF ... ELSE ... THEN
; In the first form, if n is non-zero then the words between IF and THEN
; are executed; otherwise they are skipped over.
; In the second form, if n is non-zero then the words between IF and ELSE
; are executed and those between ELSE and THEN are skipped over, while if
; n is zero then the words between IF and ELSE are skipped over and those
; between ELSE and THEN are executed.

<a name="L11BB"></a>L11BB:  DEFB    'I'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'F' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13E0">L13E0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L11BF"></a>L11BF:  DEFB    $42                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate word)

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ; ?branch
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $02                     ; 2 locations required for jump length
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'WHILE'</font></b> WORD
; ----------------
; <font color="#CC00FF">(n -- )</font>
; Used in BEGIN ... WHILE ... REPEAT. If n = 0 then skips over to just past
; REPEAT.

<a name="L11CD"></a>L11CD:  DEFM    "WHIL"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11BF">L11BF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L11D4"></a>L11D4:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L11D5"></a>L11D5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1288">L1288</a>                   ; ?branch

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $01                     ;  1
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data
        DEFB    $04                     ;  four
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'ELSE'</font></b> WORD
; ---------------
; <font color="#CC00FF">(  --  )</font>
; Used with IF and THEN.

<a name="L11E5"></a>L11E5:  DEFM    "ELS"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11D4">L11D4</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L11EB"></a>L11EB:  DEFB    $44                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L11EC"></a>L11EC:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1271">L1271</a>                   ; branch

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $02                     ; two
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1225">L1225</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E29">L0E29</a>                   ; 2-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk-data
        DEFB    $02                     ; two
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'THEN'</font></b> WORD
; ---------------
; Used with IF.

<a name="L1200"></a>L1200:  DEFM    "THE"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'N' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11EB">L11EB</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1206"></a>L1206:  DEFB    $44                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1207"></a>L1207:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12A4">L12A4</a>                   ; end?

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $02
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1225">L1225</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'BEGIN'</font></b> WORD
; ---------------
; <font color="#CC00FF">(  --  )</font>
; Used with either UNTIL or WHILE...REPEAT.

<a name="L1212"></a>L1212:  DEFM    "BEGI"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'N' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1206">L1206</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1219"></a>L1219:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L121A"></a>L121A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L129F">L129F</a>
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $01                     ; 1
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L1225"></a>L1225:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L086B">L086B</a>                   ; dup
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DE1">L0DE1</a>                   ; -
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L1237"></a>L1237:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0DE1">L0DE1</a>                   ; -
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F4E">L0F4E</a>                   ; ,
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; -----------------
; THE <b><font color="#333388">'REPEAT'</font></b> WORD
; -----------------
; <font color="#CC00FF">(  --  )</font>
; Used in construction BEGIN ... WHILE .. REPEAT.
; Causes a jump back to just after BEGIN.


<a name="L1243"></a>L1243:  DEFM    "REPEA"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1219">L1219</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L124B"></a>L124B:  DEFB    $46                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L124C"></a>L124C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L124E"></a>L124E   DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L1250"></a>L1250:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check_for
        DEFB    $04                     ; four
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1237">L1237</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1225">L1225</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'UNTIL'</font></b> WORD
; ----------------
; <font color="#CC00FF">(n -- )</font>
; Used in BEGIN ... UNTIL.
; Loops back to BEGIN if n = 0

<a name="L125B"></a>L125B:  DEFM    "UNTI"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'L' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L124B">L124B</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1262"></a>L1262:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1263"></a>L1263:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128D">L128D</a>                   ; ?branch
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check_for
        DEFB    $01                     ;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1237">L1237</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x126E   DEFB    $02                     ;;

x126F   DEFB    $75                     ;;
x1270   DEFB    $FF                     ;; 1270 + ff75 = 11e5 = ELSE

; ---


<a name="L1271"></a>L1271:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1278">L1278</a>                   ; ?

; ---
x1273   DEFB    $02                     ;;

x1274   DEFB    $CE                     ;;
x1275   DEFB    $FF                     ;; 1275 + ffce = 1243 = REPEAT

; --------------------------
; The <b><font color="#333388">'branch'</font></b> Internal Word
; --------------------------

<a name="L1276"></a>L1276:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1278">L1278</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1278"></a>L1278:  POP     HL                      ; drop next word pointer
        LD      E,(HL)                  ; read the 16-bit offset
        INC     HL                      ; that is
        LD      D,(HL)                  ; stored there.

<a name="L127C"></a>L127C:  ADD     HL,DE                   ; add to current address.

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BA">L04BA</a>                   ; jump back into address loop so that
                                        ; a new address gets stacked as IP.

; ---

x1280   DEFB    $02                     ;;

x1281   DEFB    $39                     ;;
x1282   DEFB    $FF                     ;; 1282 + ff39 = 11bb = IF

; ---

<a name="L1283"></a>L1283:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128F">L128F</a>                   ; from IF, convert, line, min, etc.

; ---

x1285   DEFB    $02                     ;;

x1286   DEFB    $46                     ;;
x1287   DEFB    $FF                     ;; 1287 + ff46 = 11cd = WHILE

; ---

<a name="L1288"></a>L1288:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128F">L128F</a>                   ; from WHILE

; ---

x128A   DEFB    $02                     ;;

x128B   DEFB    $CF                     ;;
x128C   DEFB    $FF                     ;; 128c + ffcf = 125b = UNTIL

; ---------------------------
; The <b><font color="#333388">'?branch'</font></b> Internal Word
; ---------------------------

<a name="L128D"></a>L128D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128F">L128F</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L128F"></a>L128F:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc

        LD      A,B                     ; test for
        OR      C                       ; zero

; -&gt; from +loop
<a name="L1294"></a>L1294:  JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1278">L1278</a>                 ; make the jump to "branch" if zero.

        POP     HL                      ; else drop the pointer.
        INC     HL                      ; step over.
        INC     HL                      ; the jump bytes
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BA">L04BA</a>                   ; jump back into address loop so that
                                        ; a new address gets stacked as IP.

; ---

x129C   DEFB    $00                     ;;
x129D   DEFB    $74                     ;;
x129E   DEFB    $FF                     ;; 129e + ff74 = 1212 = BEGIN

; ---

<a name="L129F"></a>L129F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

; ---

x12A1   DEFB    $00                     ;;
x12A2   DEFB    $5D                     ;;
x12A3   DEFB    $FF                     ;; 12a3 + ff5d = 1200 = THEN

; ---

<a name="L12A4"></a>L12A4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>

; -------------
; THE <b><font color="#333388">'DO'</font></b> WORD
; -------------
; <font color="#CC00FF">(limit, initial value -- )</font>
; Sets up a DO loop, initializing the loop counter to the initial value.
; The limit and loop counter are stored on the return stack.
; See LOOP and +LOOP.

<a name="L12A6"></a>L12A6:  DEFB    'D'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'O' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1262">L1262</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L12AA"></a>L12AA:  DEFB    $42                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L12AB"></a>L12AB:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1323">L1323</a>                   ; shuffle
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $03                     ; 3                     marker byte.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'LOOP'</font></b> WORD
; ---------------
; <font color="#CC00FF">(  --  )</font>
; Like +LOOP (below) but the number added onto the loop counter is 1.

<a name="L12B6"></a>L12B6:  DEFM    "LOO"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12AA">L12AA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L12BC"></a>L12BC:  DEFB    $44                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L12BD"></a>L12BD:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1332">L1332</a>                   ; shuffle more

<a name="L12C1"></a>L12C1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12D8">L12D8</a>                   ; check-for
        DEFB    $03                     ; 3                     marker byte
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1237">L1237</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'+LOOP'</font></b> WORD
; ----------------
; <font color="#CC00FF">(n -- )</font>
; Used with DO. Adds n to the loop counter, and loops back if the loop counter
; is now less than the limit (if n &gt;= 0) or greater than the limit (if n &lt; 0).

<a name="L12C8"></a>L12C8:  DEFM    "+LOO"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'P' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12BC">L12BC</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L12CF"></a>L12CF:  DEFB    $45                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L12D0"></a>L12D0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L12D2"></a>L12D2:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L133C">L133C</a>                   ; ?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch

<a name="L12D6"></a>L12D6:  DEFW    $FFEA                   ; back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12C1">L12C1</a>

; -----------------------------
; The <b><font color="#333388">'check-for'</font></b> Internal Word
; -----------------------------
; Checks for expected marker byte which indicates stack is balanced and that
; a previous mandatory word was present.

<a name="L12D8"></a>L12D8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12DA">L12DA</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L12DA"></a>L12DA:  RST     18H                     ; pop word DE
        POP     HL                      ;
        LD      A,(HL)                  ;
        INC     HL                      ;
        PUSH    HL                      ;
        SUB     E                       ;
        OR      D                       ;

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L132D">L132D</a>                 ; to next via jp (iy).

; else...

        RST     20H                     ; <b><font color="#FF0000">Error 5</font></b>
        DEFB    $05                     ; Word is not properly structured.

; ------------
; THE <b><font color="#333388">'I'</font></b> WORD
; ------------
; <font color="#CC00FF">( -- loop counter)</font>
; Copies the top of the return stack to the data stack. This will be either
; the loop counter for the innermost DO...LOOP, or the number most recently
; transferred by &gt;R.


<a name="L12E5"></a>L12E5:  DEFB    'I' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11AA">L11AA</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L12E8"></a>L12E8:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L12E9"></a>L12E9:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12EB">L12EB</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L12EB"></a>L12EB:  POP     BC                      ; pop return address
        POP     DE                      ; pop the loop counter to DE.
        PUSH    DE                      ; now restore the stack
        PUSH    BC                      ; exactly as it was.

        RST     10H                     ; push Data Word DE - inner loop counter

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------
; THE <b><font color="#333388">'I'</font></b>' WORD
; -------------
; <font color="#CC00FF">( -- limit)</font>
; Copies the second number down on the return stack to the data stack
; (so in a DO loop it copies  the limit of the loop).

<a name="L12F2"></a>L12F2:  DEFB    'I'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    $A7                     ; "'" + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12E8">L12E8</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L12F6"></a>L12F6:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L12F7"></a>L12F7:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12F9">L12F9</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L12F9"></a>L12F9:  LD      HL,$0004                ; two bytes per entry.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1307">L1307</a>                   ; forward to use the 'J' indexing
                                        ; routine

; ------------
; THE <b><font color="#333388">'J'</font></b> WORD
; ------------
; <font color="#CC00FF">( -- loop counter)</font>
; Copies the third entry on the return stack to the data stack.
; This will be either the loop counter for the second innermost DO loop
; or the number put on the return stack by the most recent &gt;R.

<a name="L12FE"></a>L12FE:  DEFB    'J' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12F6">L12F6</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1301"></a>L1301:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1302"></a>L1302:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1304">L1304</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1304"></a>L1304:  LD      HL,$0006                ; two bytes per entry

; -&gt; I' joins here with HL=4

<a name="L1307"></a>L1307:  ADD     HL,SP                   ; index the stack pointer.
        LD      E,(HL)                  ; low order byte to E
        INC     HL                      ; address high byte.
        LD      D,(HL)                  ; DE now holds a copy of the required
                                        ; entry from the Return Stack

        RST     10H                     ; stack Data Word DE

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ----------------
; THE <b><font color="#333388">'LEAVE'</font></b> WORD
; ----------------
; <font color="#CC00FF">(  --  )</font>
; Forces termination of a DO loop at the next LOOP or +LOOP by setting the
; loop counter equal to the limit.

<a name="L130E"></a>L130E:  DEFM    "LEAV"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1301">L1301</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1315"></a>L1315:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1316"></a>L1316:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1318">L1318</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1318"></a>L1318:  POP     BC                      ; pop return address to BC.
        POP     HL                      ; pop the loop counter.
        POP     HL                      ; now the limit.
        PUSH    HL                      ; push unaltered limit.
        PUSH    HL                      ; push counter - now limit.
        PUSH    BC                      ; restore return address.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---


x1320   DEFB    $00                     ;;
x1321   DEFB    $84                     ;;
x1322   DEFB    $FF                     ;; 1322 + ff84 = 12a6 = DO

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L1323"></a>L1323:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1325">L1325</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1325"></a>L1325:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L084E">L084E</a>                   ; stk_to_bc
        RST     18H                     ; pop word DE
        POP     HL
        PUSH    DE

<a name="L132B"></a>L132B:  PUSH    BC
        PUSH    HL

<a name="L132D"></a>L132D:  JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

x132F   DEFB    $02                     ;;
x1330   DEFB    $85                     ;;
x1331   DEFB    $FF                     ;; 1331 + ff85 = 12b6 = LOOP

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L1332"></a>L1332:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1334">L1334</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1334"></a>L1334:  LD      DE,$0001
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L133F">L133F</a>                   ; forward =&gt;

; ---

x1339   DEFB    $02
x133A   DEFB    $8D
x133B   DEFB    $FF

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------
; loop counter + n
; <font color="#9900FF">Note.</font> ADC HL,DE is used in preference to ADD HL,DE as affects P/O flag

<a name="L133C"></a>L133C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L133E">L133E</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L133E"></a>L133E:  RST     18H                     ; pop word DE - number to be added (n)
; =&gt;
<a name="L133F"></a>L133F:  POP     BC                      ; pop return address to BC.
        POP     HL                      ; loop counter to HL.
        AND     A                       ; clear carry.
        ADC     HL,DE                   ; add the number specified.
        LD      A,D                     ; save MSB of (n) in A.
        POP     DE                      ; now pop the limit to DE.
        SCF                             ; set carry.
        JP      PE,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1358">L1358</a>                ; jump forward with overflow.

        PUSH    DE                      ; push limit
        PUSH    HL                      ; push adjusted counter.
        RLCA                            ; now test sign of number (n)
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1350">L1350</a>                ;

        EX      DE,HL

<a name="L1350"></a>L1350:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0C99">L0C99</a>                   ;

        CCF

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1358">L1358</a>                ;

        POP     HL
        POP     HL

<a name="L1358"></a>L1358:  PUSH    BC
        SBC     A,A
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1294">L1294</a>                   ; jump to branch on zero.

; ------------
; THE <b><font color="#333388">'('</font></b> WORD
; ------------
; Starts a comment terminated by ')'

<a name="L135D"></a>L135D:  DEFB    '(' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13D4">L13D4</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1360"></a>L1360:  DEFB    $41                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1361"></a>L1361:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L1363"></a>L1363:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1379">L1379</a>                   ;
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data

        DEFB    $29                     ; character ')'         - delimiter

<a name="L1368"></a>L1368:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0460">L0460</a>                   ; here
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F83">L0F83</a>                   ; allot2
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L139F">L139F</a>                   ; find)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0885">L0885</a>                   ; swap
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

x1376   DEFB    $FF                     ;;
x1377   DEFB    $E5                     ;;
x1378   DEFB    $FF                     ;; 1378 + ffe5 = 135d = '('

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------

<a name="L1379"></a>L1379:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L137B">L137B</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L137B"></a>L137B:  POP     HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)

        INC     DE

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L127C">L127C</a>                   ;

; -------------
; THE <b><font color="#333388">'."'</font></b> WORD
; -------------
; <font color="#CC00FF">(  --  )</font>
; Prints the following string terminated by ".

<a name="L1383"></a>L1383:  DEFB    '.'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '"' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1360">L1360</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1387"></a>L1387:  DEFB    $42                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L1388"></a>L1388:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; <b><font color="#3030dd">'code field'</font></b> - compile

; ---

<a name="L138A"></a>L138A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1396">L1396</a>                   ; pr_embedded string.
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $22                     ; '"'                   - delimiter

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ; branch
<a name="L1391"></a>L1391:  DEFW    $FFD6                   ; back to 1368 (1392+$FFD6)
                                        ; same routine as for matching comments

; ---

x1393   DEFB    $FF                     ;;
x1394   DEFB    $EE                     ;;
x1395   DEFB    $FF                     ;; 1395 + ffee = 1383 = ."

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------
; print string embedded in Dictionary

<a name="L1396"></a>L1396:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1398">L1398</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L1398"></a>L1398:  POP     DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0979">L0979</a>                   ; pr_string1
        PUSH    DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -----------------------
; The <b><font color="#333388">'???'</font></b> Internal Word
; -----------------------
; enclose comment
; comments may be multiple
; e.g. : SV ( system) ( variables) CLS BEGIN 0 0 AT 15360 80 TYPE 0 UNTIL ;


<a name="L139F"></a>L139F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13A1">L13A1</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

; ---

<a name="L13A1"></a>L13A1:  RST     18H                     ; pop word DE
        PUSH    DE                      ; save delimiter.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05E1">L05E1</a>                   ; find the ')' delimiter

        LD      H,D
        LD      L,E
        ADD     HL,BC
        LD      A,(HL)
        POP     HL                      ; pop the delimiter.
        CP      L
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L13B8">L13B8</a>                 ; forward with a match.         =-&gt;

        EX      DE,HL                   ;
        RST     10H                     ; push word DE
        LD      DE,$0578                ; addr retype?

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1815">L1815</a>                   ; pr2

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13A1">L13A1</a>                   ; loop back

; ---
; =-&gt;

<a name="L13B8"></a>L13B8:  PUSH    DE
        PUSH    BC
        LD      HL,($3C37)              ; STKBOT

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F9E">L0F9E</a>                   ; routine MAKE ROOM

        POP     BC
        POP     DE
        PUSH    DE
        PUSH    BC
        EX      DE,HL
        LDIR                            ; copy comment to dictionary.
        POP     BC
        LD      D,B
        LD      E,C
        RST     10H                     ; push word DE
        POP     DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07DA">L07DA</a>                   ;

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">'['</font></b> WORD
; ------------
; <font color="#CC00FF">(  --  )</font>
; Enters interpret mode.

<a name="L13D1"></a>L13D1:  DEFB    '[' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12CF">L12CF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L13D4"></a>L13D4:  DEFB    $41                     ; <b><font color="#3030dd">'name length field'</font></b> (immediate mode)

<a name="L13D5"></a>L13D5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13D7">L13D7</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L13D7"></a>L13D7:  RES     6,(IX+$3E)              ; FLAGS
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ------------
; THE <b><font color="#333388">']'</font></b> WORD
; ------------
; <font color="#CC00FF">(  --  )</font>
; Enters compile mode.

<a name="L13DD"></a>L13DD:  DEFB    ']' + $80               ; <b><font color="#3030dd">'name field'</font></b>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1315">L1315</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L13E0"></a>L13E0:  DEFB    $01                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L13E1"></a>L13E1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13E3">L13E3</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L13E3"></a>L13E3:  SET     6,(IX+$3E)              ; FLAGS
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>


; ---------------
; THE <b><font color="#333388">'EXIT'</font></b> WORD
; ---------------
; <font color="#CC00FF">(  --  )</font>
; Exits immediately from the word in whose definition it is contained.
; Cannot be used between DO and LOOP or +LOOP, nor between &gt;R and R&gt;.

<a name="L13E9"></a>L13E9:  DEFM    "EXI"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1387">L1387</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L13EF"></a>L13EF:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L13F0"></a>L13F0:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B8">L04B8</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; -------------------
; THE <b><font color="#333388">'REDEFINE'</font></b> WORD
; -------------------
; REDEFINE name
; <font color="#CC00FF">(  --  )</font>
; Takes word 'name' and replaces it with the most recent word in the
; dictionary. Updates entire dictionary to take changes into account.
; Most commonly used as
;  EDIT name
;  REDEFINE name

<a name="L13F2"></a>L13F2:  DEFM    "REDEFIN"               ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13EF">L13EF</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L13FC"></a>L13FC:  DEFB    $08                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L13FD"></a>L13FD:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13FF">L13FF</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L13FF"></a>L13FF:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F2E">L0F2E</a>                   ; blank stack

        LD      HL,($3C31)              ; CURRENT

        LD      E,(HL)
        INC     HL
        LD      D,(HL)

        EX      DE,HL                   ; transfer value to HL
        INC     HL
        LD      ($2705),HL              ; store in pad

        PUSH    HL                      ; (*)

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15C0">L15C0</a>                   ; get 'name field' address

        LD      ($270D),HL              ; name field addr
        LD      ($2707),BC              ; parameter field addr
        LD      ($270B),DE              ; length field value

        LD      HL,($3C37)              ; STKBOT
        SBC     HL,DE
        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14DA">L14DA</a>                ; forward if not matched to Error 11.

        POP     DE                      ; (*)

        RST     10H                     ; push word DE

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

<a name="L1429"></a>L1429:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1610">L1610</a>                   ; prvcur
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L063D">L063D</a>                   ; find
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

; ---

<a name="L1425"></a>L1425:  RST     18H                     ; pop word DE
        LD      HL,$C3AF
        ADD     HL,DE
        JP      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14CF">L14CF</a>                ;

        EX      DE,HL
        LD      ($2703),HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15C0">L15C0</a>                   ; get 'name field' address

        LD      ($2701),HL

<a name="L1441"></a>L1441:  PUSH    HL
        LD      ($2709),DE
        LD      A,B
        OR      C
        LD      DE,($2707)
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1452">L1452</a>                 ;

        LD      A,D
        OR      E
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14CF">L14CF</a>                 ;

<a name="L1452"></a>L1452:  POP     HL
        LD      BC,($270D)
        SBC     HL,BC
        EX      DE,HL
        ADD     HL,DE
        LD      ($2707),HL
        LD      HL,($270B)
        ADD     HL,DE
        LD      BC,($2709)
        AND     A
        SBC     HL,BC
        LD      ($270B),HL
        LD      BC,$002E                ; 46d
        ADD     HL,BC
        BIT     7,H
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L147F">L147F</a>                ;

        LD      BC,($3C3B)              ; SPARE
        ADD     HL,BC
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14CF">L14CF</a>                 ;

        SBC     HL,SP
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14CF">L14CF</a>                ;

<a name="L147F"></a>L147F:  LD      HL,($2703)
        PUSH    HL
        DEC     HL
        DEC     HL
        LD      B,(HL)
        DEC     HL
        LD      C,(HL)
        LD      HL,($2705)
        PUSH    HL
        DEC     HL
        DEC     HL
        LD      (HL),B
        DEC     HL
        LD      (HL),C
        POP     HL
        ADD     HL,DE
        POP     BC
        AND     A
        SBC     HL,BC
        LD      ($2705),HL
        LD      DE,($2701)
        LD      HL,($2709)
        AND     A
        SBC     HL,DE
        LD      B,H
        LD      C,L
        PUSH    DE
        PUSH    BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L14DC">L14DC</a>                   ; RECLAIM

        LD      HL,($270B)
        POP     BC
        ADD     HL,BC
        LD      B,H
        LD      C,L
        POP     HL
        PUSH    BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F9E">L0F9E</a>                   ; routine MAKE ROOM

        EX      DE,HL                   ;
        LD      HL,($270D)              ;
        LD      BC,($270B)              ;
        ADD     HL,BC                   ;
        POP     BC                      ;
        PUSH    BC                      ;
        PUSH    HL                      ;

        LDIR                            ;

        POP     DE
        POP     BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L14DC">L14DC</a>                   ; RECLAIM
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L14F8">L14F8</a>                   ;

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L14CF"></a>L14CF:  LD      HL,($3C31)              ; CURRENT
        LD      DE,($2705)
        DEC     DE
        LD      (HL),E
        INC     HL
        LD      (HL),D

<a name="L14DA"></a>L14DA:  RST     20H                     ; <b><font color="#FF0000">Error 11</font></b>
        DEFB    $0B                     ; Error in REDEFINE or FORGET

; ---------------------------
; THE <b><font color="#333388">'RECLAIMING'</font></b> SUBROUTINE
; ---------------------------

<a name="L14DC"></a>L14DC:  LD      HL,($3C37)              ; fetch STKBOT
        AND     A                       ; clear carry flag
        SBC     HL,BC                   ; subtract number of bytes to reclaim.
        LD      ($3C37),HL              ; update STKBOT

        LD      HL,($3C3B)              ; fetch SPARE
        SBC     HL,BC                   ; subtract number of bytes to reclaim.
        LD      ($3C3B),HL              ; update SPARE

        SBC     HL,DE                   ; subtract
        RET     Z                       ; return if same address.

        PUSH    BC                      ;
        LD      B,H                     ;
        LD      C,L                     ;
        POP     HL                      ;
        ADD     HL,DE                   ;

        LDIR                            ;

        RET                             ;

; ---
;
; ---

<a name="L14F8"></a>L14F8:  LD      BC,$3C31                ; CURRENT

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;

        LD      BC,$3C40                ; addr. of "FORTH" in RAM.

<a name="L1504"></a>L1504:  LD      HL,($3C37)              ; STKBOT
        SCF                             ;
        SBC     HL,BC                   ;
        RET     C                       ;

<a name="L150B"></a>L150B:  LD      A,(BC)                  ;
        RLA                             ;
        INC     BC                      ;
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L150B">L150B</a>                ;

        INC     BC                      ;
        INC     BC                      ;
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;
        INC     BC                      ;
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;

<a name="L1519"></a>L1519:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15FB">L15FB</a>                   ; routine INDEXER

; -------------------------------------------------------

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; DE value
<a name="L151E"></a>L151E:  DEFB    $1C                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L153A">L153A</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; DE value
<a name="L1521"></a>L1521:  DEFB    $16                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1537">L1537</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; DE value
<a name="L1524"></a>L1524:  DEFB    $13                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1537">L1537</a>

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L11B5">L11B5</a>                   ; DE value
<a name="L1527"></a>L1527:  DEFB    $18                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L153F">L153F</a>

        DEFW    $0000                   ; zero end marker

; -------------------------------------------------------

<a name="L152A"></a>L152A:  LD      HL,$FFF9
        ADD     HL,BC

        LD      C,(HL)
        INC     HL
        LD      B,(HL)
        DEC     HL

        ADD     HL,BC

        LD      B,H
        LD      C,L
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1504">L1504</a>                   ;

; -------------------------------------------------------

<a name="L1537"></a>L1537:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;

; -&gt;

<a name="L153A"></a>L153A:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1548">L1548</a>                   ;
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1504">L1504</a>                   ;

; ---

<a name="L153F"></a>L153F:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;
        INC     BC                      ;
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1504">L1504</a>                   ;

; -------------------------------------------------------

; XXX?

<a name="L1548"></a>L1548:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1557">L1557</a>                   ;
        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                ;
        AND     A                       ;
        SBC     HL,DE                   ;
        RET     Z                       ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L159E">L159E</a>                   ;

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1548">L1548</a>                   ;

; ---
; often called twice
; ---


<a name="L1557"></a>L1557:  LD      A,(BC)                  ; lo byte
        LD      E,A                     ;
        INC     BC                      ;
        LD      A,(BC)                  ; hi byte
        LD      D,A                     ;
        DEC     BC                      ; BC now unchanged, DE contents

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1568">L1568</a>                   ; routine below. header?

        EX      DE,HL                   ; value to DE
        LD      A,E                     ;
        LD      (BC),A                  ; lo byte
        INC     BC                      ;
        LD      A,D                     ;
        LD      (BC),A                  ; hi byte
        INC     BC                      ;
        RET                             ; to next - BC+=2

; ---

<a name="L1568"></a>L1568:  LD      HL,($2701)              ; first bytes of pad.
        AND     A                       ;
        SBC     HL,DE                   ; subtract the DE value read from
                                        ; memory
        LD      H,D                     ;
        LD      L,E                     ; transfer that DE to HL as well

        RET     NC                      ; return if HL was higher than DE

        LD      HL,($2709)              ; tape header
        SBC     HL,DE
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1584">L1584</a>                ; forward if higher to

        LD      HL,($270D)
        SBC     HL,DE
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1592">L1592</a>                 ; forward if lower to

        LD      HL,($270B)              ;
        ADD     HL,DE
        RET                             ; return

; ---

<a name="L1584"></a>L1584:  LD      HL,($2703)
        SBC     HL,DE
        LD      HL,($2707)
        RET     C

        LD      HL,($2705)
        ADD     HL,DE
        RET

; ---

<a name="L1592"></a>L1592:  LD      HL,($2701)
        ADD     HL,DE
        LD      DE,($270D)
        AND     A
        SBC     HL,DE
        RET

; ---

<a name="L159E"></a>L159E:  DEC     DE
        LD      A,(DE)
        RLA
        RET     NC

<a name="L15A2"></a>L15A2:  DEC     DE
        DEC     DE
        LD      A,(DE)
        LD      L,A                     ; low byte
        LD      H,$00                   ; make high byte zero
        INC     A                       ; test offset for $FF.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L15B1">L15B1</a>                ; forward if not.

        LD      A,(BC)
        LD      L,A
        INC     BC
        LD      A,(BC)
        LD      H,A
        INC     BC

<a name="L15B1"></a>L15B1:  ADD     HL,BC

        LD      B,H
        LD      C,L
        RET

; ---
;
; ---


<a name="L15B5"></a>L15B5:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15B7">L15B7</a>

; ---

<a name="L15B7"></a>L15B7:  RST     18H                     ; pop word DE

        EX      DE,HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15E7">L15E7</a>                   ; WORDSTART1

        EX      DE,HL

        RST     10H                     ; push word DE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---
;
; ---

<a name="L15C0"></a>L15C0:  PUSH    HL
        LD      E,(HL)
        INC     HL
        LD      D,(HL)

<a name="L15C4"></a>L15C4:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15FB">L15FB</a>                   ; routine INDEXER

; -------------------------------------------------------

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>
<a name="L15C9"></a>L15C9:  DEFB    $0B                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15D4">L15D4</a> - find parameter field

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>
<a name="L15CC"></a>L15CC:  DEFB    $08                     ; to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15D4">L15D4</a> - find parameter field

        DEFW    $0000                   ; zero end_marker.

; -------------------------------------------------------

<a name="L15CF"></a>L15CF:  LD      BC,$0000                ; zero indicates no parameter field.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15DB">L15DB</a>                   ; forward to consider total length.

; -------------------------------------------------------

<a name="L15D4"></a>L15D4:  POP     HL                      ; retrieve the code field address
        PUSH    HL                      ; save it again

        INC     HL                      ; step past the
        INC     HL                      ; address word
        LD      C,(HL)                  ; and get following address
        INC     HL                      ; which if in RAM could be the
        LD      B,(HL)                  ; parameter field to              BC.

; -&gt;

<a name="L15DB"></a>L15DB:  POP     HL                      ; retrieve the code field address
        PUSH    HL                      ; and save it again

        DEC     HL                      ; the name length field
        DEC     HL                      ; link field high order byte
        DEC     HL                      ; link field low order byte
        DEC     HL                      ; possible length field high
        LD      D,(HL)                  ; save in D
        DEC     HL                      ; possible length field low
        LD      E,(HL)                  ; save in E
        ADD     HL,DE                   ; add this length
        EX      DE,HL                   ; and save result in              DE.

        POP     HL                      ; retrieve code field address

; -&gt;
; indexes the header information of a FORTH word

<a name="L15E7"></a>L15E7:  DEC     HL                      ; point to name length field

; =&gt;
<a name="L15E8"></a>L15E8:  LD      A,H                     ; fetch high order byte of the
                                        ; header address.
        CP      $3C                     ; compare to RAM location
        LD      A,(HL)                  ; fetch length byte.
        RES     6,A                     ; reset the immediate mode bit
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L15F2">L15F2</a>                 ; forward if definition is in ROM.

        ADD     A,$02                   ; else add extra for 'length field'

<a name="L15F2"></a>L15F2:  DEC     HL                      ; step past the
        DEC     HL                      ; link to previous word.

<a name="L15F4"></a>L15F4:  DEC     HL                      ; now address last letter on name.
        DEC     A                       ; decrement the length
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L15F4">L15F4</a>                ; loop back until at first letter  HL.

        RET                             ; return.

; -------
; INDEXER
; -------

; indexerloop

<a name="L15F9"></a>L15F9:  INC     HL                      ; step past the
        PUSH    HL                      ; offset byte.

; -&gt; Call Entry point

<a name="L15FB"></a>L15FB:  POP     HL                      ; drop return address - points to byte
                                        ; after the call.
        LD      A,(HL)                  ; read low-order byte
        INC     HL                      ; increment address once
        PUSH    HL                      ; push return address

        LD      H,(HL)                  ; read high-order byte.
        LD      L,A                     ; now HL holds the read word
        OR      H                       ; test for two zeros.
        RET     Z                       ; two zeros - return
                                        ; (ret addr is second NOP)

        SBC     HL,DE                   ; compare to value passed in DE

        POP     HL                      ; now increment the
        INC     HL                      ; return address on machine stack.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L15F9">L15F9</a>                ; loop back if read word is not
                                        ; equal to DE

        PUSH    DE                      ; else preserve DE

        LD      D,$00                   ; a 1 byte relative jump.
        LD      E,(HL)                  ; read one-byte offset.
        ADD     HL,DE                   ; add to read address.

        POP     DE                      ; restore DE

        JP      (HL)                    ; &gt;&gt;&gt;

; ---

<a name="L1610"></a>L1610:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E1F">L0E1F</a>                   ; 1-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0E29">L0E29</a>                   ; 2-
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0480">L0480</a>                   ; current
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08B3">L08B3</a>                   ; @
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------------------------
; THE <b><font color="#333388">'FIND WORD IN RAM'</font></b> SUBROUTINE
; ---------------------------------
; This subroutine is used by FORGET, EDIT and LIST.
; First use the standard FORTH word find to get address of word (in pad).
; If word does not exist then returned value will be zero.
; The lowest word in RAM is the FORTH word at <a href="http://www.jupiter-ace.co.uk/romlisting.html#L3C51">L3C51</a> so a check is made
; against this address.

<a name="L1620"></a>L1620:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L063D">L063D</a>                   ; find

<a name="L1625"></a>L1625:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        RST     18H                     ; pop word DE

        LD      HL,$C3AF                ; i.e $0000 - $3C51

        ADD     HL,DE                   ; add to test value.
        RET     C                       ; carry signals that word exists in RAM.
                                        ; return the address in DE.

; else generate an error code.

        RST     20H                     ; <b><font color="#FF0000">Error 13</font></b>
        DEFB    $0D                     ; Error word not found or is in ROM.

; -----------------
; THE <b><font color="#333388">'FORGET'</font></b> WORD
; -----------------
; FORGET name.
; Erases the word 'name' and all subsequently defined names from the dictionary.

<a name="L162F"></a>L162F:  DEFM    "FORGE"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L13FC">L13FC</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1637"></a>L1637:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1638"></a>L1638:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L163A">L163A</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L163A"></a>L163A:  LD      HL,($3C31)              ; CURRENT
        LD      DE,($3C33)              ; CONTEXT
        AND     A
        SBC     HL,DE

        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L14DA">L14DA</a>                ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1620">L1620</a>                   ; findramword

        LD      HL,$FFFB
        ADD     HL,DE
        LD      ($3C39),HL              ; SPARE
        SET     2,(IX+$3E)              ; FLAGS

        RST     20H                     ; Invoke error routine.
        DEFB    $FF                     ; No error

; ---------------
; THE <b><font color="#333388">'EDIT'</font></b> WORD
; ---------------
; EDIT name
; Lists word 'name' at bottom of the screen to be edited. Lists 18 lines at
; a time, then waits for editing until ENTER is pressed.
; A new version of the word is entered at the end of the dictionary.
; While editing, cursor up and cursor down are needed to move the cursor
; from one line to another. DELETE LINE deletes one line.

<a name="L1657"></a>L1657:  DEFM    "EDI"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1637">L1637</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L165D"></a>L165D:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L165E"></a>L165E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1660">L1660</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1660"></a>L1660:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1620">L1620</a>                   ; findramword

        SET     3,(IX+$3E)              ; update FLAGS output -&gt; input buffer
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1675">L1675</a>                   ; forward to list routine the difference
                                        ; being that the listing will go to the
                                        ; lower screen.

; ---------------
; THE <b><font color="#333388">'LIST'</font></b> WORD
; ---------------
; LIST name
; <font color="#CC00FF">(  --  )</font>
; Lists word 'name' on the screen. It must have been defined by :, DEFINER,
; or COMPILER. Lists about 18 lines at a time and waits for key depression
; (shifted space breaks).

<a name="L1669"></a>L1669:  DEFM    "LIS"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L165D">L165D</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L166F"></a>L166F:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1670"></a>L1670:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1672">L1672</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1672"></a>L1672:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1620">L1620</a>                   ; findramword

; edit path joins here but carriage returns are printed as zeros.

<a name="L1675"></a>L1675:  LD      A,$0D                   ; prepare a carriage return.
        RST     08H                     ; print_ch

        BIT     3,(IX+$3E)              ; test FLAGS output-&gt;input buffer?

        PUSH    DE

        CALL    NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L02D8">L02D8</a>                ; call if so to initialize buffer

        POP     BC                      ; LD DE,(BC)

        LD      A,(BC)
        LD      E,A
        INC     BC
        LD      A,(BC)
        LD      D,A
        DEC     BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15FB">L15FB</a>                   ; routine INDEXER

; -------------------------------------------------------

<a name="L168A"></a>L168A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; DE value
<a name="L168C"></a>L168C:  DEFB    $0B                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1697">L1697</a>

<a name="L168D"></a>L168D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1108">L1108</a>                   ; DE value
<a name="L168F"></a>L168F:  DEFB    $0D                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L169C">L169C</a>

<a name="L1690"></a>L1690:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1085">L1085</a>                   ; DE value
<a name="L1692"></a>L1692:  DEFB    $1F                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L16B1">L16B1</a>

        DEFW    $0000                   ; zero end-marker

; -------------------------------------------------------

<a name="L1695"></a>L1695:  RST     20H                     ; <b><font color="#FF0000">Error 14</font></b>
        DEFB    $0E                     ; Word unlistable.

; Only words defined by ':', 'DEFINER' or 'COMPILER' are listable.

; -------------------------------------------------------

; ':'
<a name="L1697"></a>L1697:  LD      HL,$0002
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L16B4">L16B4</a>                   ;
; ---

<a name="L169C"></a>L169C:  PUSH    DE
        LD      HL,$0002
        ADD     HL,BC
        LD      A,(HL)
        INC     HL
        LD      H,(HL)
        LD      L,A
        DEC     HL
        DEC     HL
        DEC     HL

        LD      L,(HL)
        LD      A,L
        RLCA
        SBC     A,A
        LD      H,A

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L180E">L180E</a>                   ; pr_int_hl?

        POP     DE

<a name="L16B1"></a>L16B1:  LD      HL,$0004


<a name="L16B4"></a>L16B4:  ADD     HL,BC
        PUSH    HL
        PUSH    BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17E4">L17E4</a>                   ;

        POP     DE
        POP     BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17E4">L17E4</a>                   ;

        LD      (IX+$14),$01            ; LISTWSx

<a name="L16C3"></a>L16C3:  LD      (IX+$16),$10            ; LISTWSx

<a name="L16C7"></a>L16C7:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1708">L1708</a>                   ; index_table

        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L16D2">L16D2</a>                 ;

        DEC     (IX+$16)                ; LISTWSx
        JP      P,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L16C7">L16C7</a>                 ;

<a name="L16D2"></a>L16D2:  BIT     3,(IX+$3E)              ; FLAGS
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L16E8">L16E8</a>                ; branch forward  =-&gt;

        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1702">L1702</a>                 ;

        LD      HL,$3C26                ; KEYCOD
        LD      (HL),$00                ;

<a name="L16DF"></a>L16DF:  LD      A,(HL)                  ;
        AND     A                       ;
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L16DF">L16DF</a>                 ; loop back while zero

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04E4">L04E4</a>                   ; check break

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L16C3">L16C3</a>                   ; loop back

; =-&gt;

<a name="L16E8"></a>L16E8:  PUSH    AF
        RES     3,(IX+$3E)              ; FLAGS
        PUSH    BC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0578">L0578</a>                   ; retype        - allow user to retype
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0506">L0506</a>                   ; line          - interpret buffer
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.


        SET     3,(IX+$3E)              ; FLAGS

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L02D8">L02D8</a>                   ;

        POP     BC
        POP     AF
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L16C3">L16C3</a>                ;

<a name="L1702"></a>L1702:  RES     3,(IX+$3E)              ; FLAGS
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------------------------------------------------

; called once

<a name="L1708"></a>L1708:  LD      A,($3C14)               ; LISTWS2
        LD      ($3C15),A               ; LISTWS3

        LD      (IX+$13),$05            ; LISTWS

<a name="L1712"></a>L1712:  LD      A,(BC)
        LD      E,A
        INC     BC
        LD      A,(BC)
        LD      D,A
        INC     BC

<a name="L1718"></a>L1718:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15FB">L15FB</a>                   ; routine INDEXER

; -------------------------------------------------------

<a name="L171B"></a>L171B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1283">L1283</a>                   ;
<a name="L171D"></a>L171D:  DEFB    $40                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L175D">L175D</a>

<a name="L171E"></a>L171E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1271">L1271</a>                   ;
<a name="L1720"></a>L1720:  DEFB    $44                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1764">L1764</a>

<a name="L1721"></a>L1721:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L12A4">L12A4</a>                   ;
<a name="L1723"></a>L1723:  DEFB    $48                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L176B">L176B</a>

<a name="L1724"></a>L1724:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L129F">L129F</a>                   ;
<a name="L1726"></a>L1726:  DEFB    $37                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L175D">L175D</a>

<a name="L1727"></a>L1727:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L128D">L128D</a>                   ;
<a name="L1729"></a>L1729:  DEFB    $42                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L176B">L176B</a>

<a name="L172A"></a>L172A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1288">L1288</a>                   ;
<a name="L172C"></a>L172C:  DEFB    $38                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1764">L1764</a>

<a name="L172D"></a>L172D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1276">L1276</a>                   ;
<a name="L172F"></a>L172F:  DEFB    $3C                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L176B">L176B</a>

<a name="L1730"></a>L1730:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1323">L1323</a>                   ;
<a name="L1732"></a>L1732:  DEFB    $2B                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L175D">L175D</a>

<a name="L1733"></a>L1733:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1332">L1332</a>                   ;
<a name="L1735"></a>L1735:  DEFB    $36                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L176B">L176B</a>

<a name="L1736"></a>L1736:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L133C">L133C</a>                   ;
<a name="L1738"></a>L1738:  DEFB    $33                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L176B">L176B</a>

<a name="L1739"></a>L1739:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L10E8">L10E8</a>                   ;
<a name="L173B"></a>L173B:  DEFB    $29                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1764">L1764</a>

<a name="L173C"></a>L173C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1140">L1140</a>                   ;
<a name="L173E"></a>L173E:  DEFB    $26                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1764">L1764</a>

<a name="L173F"></a>L173F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ;
<a name="L1741"></a>L1741:  DEFB    $3B                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L177C">L177C</a>

<a name="L1742"></a>L1742:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1064">L1064</a>                   ;
<a name="L1744"></a>L1744:  DEFB    $47                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L178B">L178B</a>

<a name="L1745"></a>L1745:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ;
<a name="L1747"></a>L1747:  DEFB    $51                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1798">L1798</a>

<a name="L1748"></a>L1748:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1379">L1379</a>                   ;
<a name="L174A"></a>L174A:  DEFB    $62                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17AC">L17AC</a>

<a name="L174B"></a>L174B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1396">L1396</a>                   ;
<a name="L174D"></a>L174D:  DEFB    $63                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17B0">L17B0</a>

<a name="L174E"></a>L174E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ;
<a name="L1750"></a>L1750:  DEFB    $54                     ; offset to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17A4">L17A4</a>

<a name="L1751"></a>L1751:  DEFW    $0000                   ; zero end-marker

; -------------------------------------------------------

; default action

<a name="L1753"></a>L1753:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17E1">L17E1</a>                   ;

<a name="L1756"></a>L1756:  DEC     (IX+$13)                ; LISTWS
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1712">L1712</a>                ;
        AND     A
        RET

; ---

<a name="L175D"></a>L175D:  LD      HL,($3C14)              ; LISTWS2
        LD      H,L
        INC     L
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1770">L1770</a>                   ;

; ---

<a name="L1764"></a>L1764:  LD      HL,($3C14)              ; LISTWS2
        LD      H,L
        DEC     H
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1770">L1770</a>                   ;

; ---

<a name="L176B"></a>L176B:  LD      HL,($3C14)              ; LISTWS2
        DEC     L
        LD      H,L

<a name="L1770"></a>L1770:  LD      ($3C14),HL              ; LISTWS2
        LD      (IX+$13),$01            ; LISTWS
        DEC     (IX+$16)                ; LISTWSx
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1753">L1753</a>                   ;

; ---

<a name="L177C"></a>L177C:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17DA">L17DA</a>                   ;

        RST     10H                     ; push word DE
        LD      DE,$09B3                ; '.' addr

<a name="L1783"></a>L1783:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17C1">L17C1</a>                   ; routine INDENT
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1815">L1815</a>                   ; pr2

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1756">L1756</a>                   ;

; ---

<a name="L178B"></a>L178B:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17DA">L17DA</a>                   ;
        RST     10H                     ; push word DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17DA">L17DA</a>                   ;
        RST     10H                     ; push word DE
        LD      DE,$0AAF                ; 'F.' addr
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1783">L1783</a>                   ;

; ---

<a name="L1798"></a>L1798:  LD      A,(BC)
        PUSH    AF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17E1">L17E1</a>                   ;

        POP     AF
        RST     08H                     ; print_ch

        LD      A,$20                   ; a space character
        RST     08H                     ; print_ch

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1756">L1756</a>                   ;

; ---

<a name="L17A4"></a>L17A4:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1808">L1808</a>                   ; pr_inline

        DEFB    $0D                     ; newline
        DEFB    ';'                     ; ;
        DEFB    $8D                     ; inverted newline

        SCF                             ;
        RET                             ;

; ---

<a name="L17AC"></a>L17AC:  LD      A,$29                   ; character ')' - end of comment.
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17B2">L17B2</a>                   ;

<a name="L17B0"></a>L17B0:  LD      A,$22                   ; character '"' - quote

<a name="L17B2"></a>L17B2:  PUSH    AF
        PUSH    BC
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17E1">L17E1</a>                   ;
        POP     DE
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0979">L0979</a>                   ; pr_string1
        LD      B,D
        LD      C,E
        POP     AF

        RST     08H                     ; print_ch

        AND     A
        RET

; -------------------------------------------------------

<a name="L17C1"></a>L17C1:  LD      A,($3C15)               ; LISTWS3
        AND     A
        RET     M

        PUSH    BC                      ; preserve BC
        LD      B,A                     ; transfer count to B

        LD      A,$0D                   ; carriage return.
        RST     08H                     ; print_ch

        INC     B                       ; test indentation.
        DEC     B                       ;
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L17D4">L17D4</a>                 ;

<a name="L17CF"></a>L17CF:  LD      A,$20                   ; a space character
        RST     08H                     ; print_ch

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17CF">L17CF</a>                   ;

<a name="L17D4"></a>L17D4:  LD      (IX+$15),$FF            ; LISTWS3

        POP     BC                      ; restore BC
        RET                             ; return.

; ---

<a name="L17DA"></a>L17DA:  LD      A,(BC)
        LD      E,A
        INC     BC
        LD      A,(BC)
        LD      D,A
<a name="L17DF"></a>L17DF:  INC     BC
        RET

; ---

<a name="L17E1"></a>L17E1:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17C1">L17C1</a>                   ; routine INDENT

<a name="L17E4"></a>L17E4:  EX      DE,HL
        DEC     HL
        LD      A,(HL)
        BIT     7,A
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L17F0">L17F0</a>                ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15E8">L15E8</a>                   ; routine WORDSTART

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17FB">L17FB</a>                   ;

; ---

<a name="L17F0"></a>L17F0:  EX      DE,HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L15A2">L15A2</a>                   ;

        INC     DE
        LD      A,(DE)
        LD      L,A
        INC     DE
        LD      A,(DE)
        LD      H,A
        ADD     HL,DE

; pr_string_sp

<a name="L17FB"></a>L17FB:  LD      A,(HL)
        AND     $7F
        RST     08H                     ; print_ch
        BIT     7,(HL)
        INC     HL
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L17FB">L17FB</a>                 ;

        LD      A,$20
        RST     08H                     ; print_ch
        RET

; ---------------------------------------
; THE <b><font color="#333388">'INLINE PRINT STRING SPACE'</font></b> ROUTINE
; ---------------------------------------
;

<a name="L1808"></a>L1808:  EX      (SP),HL
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L17FB">L17FB</a>                   ; pr_string_sp
        EX      (SP),HL
        RET

; ---------------------------
; THE <b><font color="#333388">'PRINT INTEGER'</font></b> ROUTINE
; ---------------------------
; in HL

; -&gt; called twice
<a name="L180E"></a>L180E:  LD      DE,$09B3                ; '.' addr
        PUSH    DE                      ; but save it as we need DE?

        EX      DE,HL                   ; transfer HL to DE.
        RST     10H                     ; push word DE, was HL, on Data Stack.
        POP     DE                      ; restore <a href="http://www.jupiter-ace.co.uk/romlisting.html#L09B3">L09B3</a> again

; -&gt; called twice.
<a name="L1815"></a>L1815:  PUSH    BC                      ; preserve BC.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BF">L04BF</a>                   ; executes '.' word

; the '.' exits so expects another word here


<a name="L1819"></a>L1819:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L181B">L181B</a>

<a name="L181B"></a>L181B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L181D">L181D</a>

<a name="L181D"></a>L181D   POP     BC                      ;
        POP     BC                      ; restore BC.

        RET                             ; return.

; ---------------------------------
; THE <b><font color="#333388">'CASSETTE INTERFACE'</font></b> ROUTINES
; ---------------------------------

; ---
; tape???
; ---

<a name="L1820"></a>L1820:  PUSH    IY

        PUSH    HL
        POP     IY

        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1892">L1892</a>
        PUSH    HL

        LD      HL,$E000
        BIT     7,C
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1832">L1832</a>                 ;
        LD      H,$FC
<a name="L1832"></a>L1832:  INC     DE
        DEC     IY
        DI
        XOR     A

<a name="L1837"></a>L1837:  LD      B,$97

<a name="L1839"></a>L1839:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1839">L1839</a>                   ;
        OUT     ($FE),A
        XOR     $08
        INC     L
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1843">L1843</a>                ;
        INC     H
<a name="L1843"></a>L1843:  JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1837">L1837</a>                ;
        LD      B,$2B
<a name="L1847"></a>L1847:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1847">L1847</a>                   ;
        OUT     ($FE),A
        LD      L,C
        LD      BC,$3B08
<a name="L184F"></a>L184F:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L184F">L184F</a>                   ;
        LD      A,C
        OUT     ($FE),A
        LD      B,$38
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L188A">L188A</a>                   ;

<a name="L1859"></a>L1859:  LD      A,C
        BIT     7,B

<a name="L185C"></a>L185C:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L185C">L185C</a>                   ;

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1864">L1864</a>                ;

        LD      B,$3D
<a name="L1862"></a>L1862:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1862">L1862</a>                   ;

<a name="L1864"></a>L1864:  OUT     ($FE),A
        LD      B,$3A
        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1859">L1859</a>                ;
        DEC     B
        XOR     A
<a name="L186D"></a>L186D:  RL      L
        JP      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L185C">L185C</a>                ;
        DEC     DE
        INC     IY
        LD      B,$2E

        LD      A,$7F
        IN      A,($FE)
        RRA
        RET     NC

        LD      A,D
        CP      $FF
        RET     NC

        OR      E
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L188F">L188F</a>                 ;

        LD      L,(IY+$00)
<a name="L1887"></a>L1887:  LD      A,H
        XOR     L
        LD      H,A
<a name="L188A"></a>L188A:  XOR     A
        SCF
        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L186D">L186D</a>                   ; JUMP back

; ---

<a name="L188F"></a>L188F:  LD      L,H
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1887">L1887</a>                   ;

<a name="L1892"></a>L1892:  POP     IY                      ; restore the original IY value so that
                                        ; words can be used gain.

        EX      AF,AF'                  ;;
        LD      B,$3B                   ;

<a name="L1897"></a>L1897:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1897">L1897</a>                   ; self-loop for delay.

        XOR     A
        OUT     ($FE),A

        LD      A,$7F                   ; read the port $7FFE
        IN      A,($FE)                 ; keyrows SPACE to V.
        RRA
        EI                              ; Enable Interrupts.

        JP      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L04F0">L04F0</a>                ; jump if SPACE pressed to Error 3
                                        ; 'BREAK pressed'.

        EX      AF,AF'                  ;;
        RET                             ; return.

; ---
; READ BYTES FROM TAPE
; ---

<a name="L18A7"></a>L18A7:  DI
        PUSH    IY
        PUSH    HL
        POP     IY
        LD      HL,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1892">L1892</a>
        PUSH    HL
        LD      H,C
        EX      AF,AF'                  ; save carry
        XOR     A
        LD      C,A

<a name="L18B5"></a>L18B5:  RET     NZ

<a name="L18B6"></a>L18B6:  LD      L,$00
<a name="L18B8"></a>L18B8:  LD      B,$B8

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1911">L1911</a>                   ;

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18B5">L18B5</a>                ;

        LD      A,$DF
        CP      B
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18B6">L18B6</a>                ;

        INC     L
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18B8">L18B8</a>                ;

<a name="L18C7"></a>L18C7:  LD      B,$CF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1915">L1915</a>                   ;

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18B5">L18B5</a>                ;

        LD      A,B
        CP      $D8
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18C7">L18C7</a>                ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1915">L1915</a>                   ;
        RET     NC

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18FC">L18FC</a>                   ;
        RET     NC

        CCF
        RET     NZ

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18F0">L18F0</a>                   ;

; ---

<a name="L18DF"></a>L18DF:  EX      AF,AF'
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18E7">L18E7</a>                ;
        LD      (IY+$00),L
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18EC">L18EC</a>                   ;

; ---

<a name="L18E7"></a>L18E7:  LD      A,(IY+$00)
        XOR     L
        RET     NZ

<a name="L18EC"></a>L18EC:  INC     IY
        DEC     DE
        EX      AF,AF'

<a name="L18F0"></a>L18F0:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18FC">L18FC</a>                   ;

        RET     NC

        LD      A,D
        OR      E
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18DF">L18DF</a>                ;

        LD      A,H
        CP      $01
<a name="L18FB"></a>L18FB:  RET

; ---

<a name="L18FC"></a>L18FC:  LD      L,$01
<a name="L18FE"></a>L18FE:  LD      B,$C7

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1911">L1911</a>                   ;

        RET     NC

        LD      A,$E2
        CP      B
        RL      L
        JP      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L18FE">L18FE</a>                ;

        LD      A,H
        XOR     L
        LD      H,A
        SCF
        RET

; ---

<a name="L1911"></a>L1911:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1915">L1915</a>                   ;
        RET     NC

<a name="L1915"></a>L1915:  LD      A,$14
<a name="L1917"></a>L1917:  DEC     A

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1917">L1917</a>                ;

        AND     A

<a name="L191B"></a>L191B:  INC     B
        RET     Z

        LD      A,$7F
        IN      A,($FE)
        RRA
        RET     NC

        XOR     C
        AND     $10
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L191B">L191B</a>                 ;

        LD      A,C
        CPL
        LD      C,A
        SCF
        RET

; ---------------
; THE <b><font color="#333388">'SAVE'</font></b> WORD
; ---------------
; SAVE name.
; Saves entire dictionary in RAM on a dictionary type cassette file with the
; given name. Makes a noise on the internal loudspeaker.

<a name="L192D"></a>L192D:  DEFM    "SAV"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L166F">L166F</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1933"></a>L1933:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1934"></a>L1934:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A10">L1A10</a>                   ; word to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A4F">L1A4F</a>                   ;  prep some sort of header?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ----------------
; THE <b><font color="#333388">'BSAVE'</font></b> WORD
; ----------------
; BSAVE name
; <font color="#CC00FF">(m, n -- )</font>
; Save n bytes to bytes type cassette file 'name' starting at
; address m.
;

<a name="L193C"></a>L193C:  DEFM    "BSAV"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1933">L1933</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1943"></a>L1943:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1944"></a>L1944:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L1946"></a>L1946:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A3D">L1A3D</a>                   ; prep_header
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A4F">L1A4F</a>                   ; prep some sort of header?
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit


; ----------------
; THE <b><font color="#333388">'BLOAD'</font></b> WORD
; ----------------
; BLOAD name
; <font color="#CC00FF">(m, n -- )</font>
; Load at most n bytes of bytes type cassette file 'name' starting at
; address m. ERROR 10 if the file has more than m bytes.
;
<a name="L194C"></a>L194C:  DEFM    "BLOA"                  ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1943">L1943</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1953"></a>L1953:  DEFB    $05                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1954"></a>L1954:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A3D">L1A3D</a>                   ; prep_header
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A74">L1A74</a>                   ; ld-bytes??
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB8">L1AB8</a>                   ; tapeFF
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; -----------------
; THE <b><font color="#333388">'VERIFY'</font></b> WORD
; -----------------
; VERIFY name
; <font color="#CC00FF">(  --  )</font>
; Verifies dictionary on tape against dictionary in RAM.

<a name="L195E"></a>L195E:  DEFM    "VERIF"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'Y' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1953">L1953</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1966"></a>L1966:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1967"></a>L1967:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L1969"></a>L1969:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A10">L1A10</a>                   ; word to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1271">L1271</a>                   ; branch
<a name="L196D"></a>L196D:  DEFW    $000F                   ; 15 bytes forward to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L197D">L197D</a>


; ------------------
; THE <b><font color="#333388">'BVERIFY'</font></b> WORD
; ------------------
; BVERIFY name
; <font color="#CC00FF">(m, n -- )</font>
; Verify at most n bytes of bytes type cassette file 'name' against
; RAM starting at address m. ERROR 10 if the file has more than m bytes.
; For BLOAD and BVERIFY, if m = 0, then starts at the address the bytes
; were saved from. If n = 0, then doesn't care about the length.
;

<a name="L196F"></a>L196F:  DEFM    "BVERIF"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'Y' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1966">L1966</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1978"></a>L1978:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1979"></a>L1979:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L197B"></a>L197B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A3D">L1A3D</a>                   ; prep_header

; -&gt;

<a name="L197D"></a>L197D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A74">L1A74</a>                   ; ld_bytes
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1ABE">L1ABE</a>                   ; tape00
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---------------
; THE <b><font color="#333388">'LOAD'</font></b> WORD
; ---------------
; LOAD name
; <font color="#CC00FF">(  --  )</font>
; Searches for a dictionary cassette file 'name' and loads it in, adding it
; to end of old dictionary. Writes to the screen all files found on tape.
; For best results turn the tone control on the tape recorder right down
; (as bass as possible) and the volume control to about three-quarters
; maximum.

<a name="L1983"></a>L1983:  DEFM    "LOA"                   ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'D' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1978">L1978</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1989"></a>L1989:  DEFB    $04                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L198A"></a>L198A:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L198C"></a>L198C:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A10">L1A10</a>                   ; word to pad

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        LD      HL,($3C37)              ; STKBOT
        LD      ($230E),HL
        EX      DE,HL
        LD      HL,$FFCC
        ADD     HL,SP
        AND     A
        SBC     HL,DE
        LD      ($230C),HL

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B9">L04B9</a>                   ; forth

<a name="L19A4"></a>L19A4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A74">L1A74</a>                   ; ld_bytes
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB8">L1AB8</a>                   ; tapeFF
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        LD      BC,($3C37)              ; STKBOT
        LD      HL,$3C50
        LD      ($2701),HL
        INC     HL
        LD      ($2709),HL
        LD      HL,($2325)
        ADD     HL,BC
        LD      ($3C37),HL              ; STKBOT
        LD      HL,$C3AF
        ADD     HL,BC
        LD      ($270B),HL
        LD      DE,($2329)
        ADD     HL,DE
        LD      DE,($3C4C)
        LD      ($3C4C),HL
        PUSH    BC
        PUSH    DE


<a name="L19D4"></a>L19D4:  LD      ($270D),SP
        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1504">L1504</a>                   ;
        POP     BC
        POP     HL
<a name="L19DD"></a>L19DD:  BIT     7,(HL)
        INC     HL
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L19DD">L19DD</a>                 ;
        INC     HL
        INC     HL
        LD      (HL),C
        INC     HL
        LD      (HL),B
        LD      HL,($3C37)              ; STKBOT
        LD      BC,$000C                ; allow twelve bytes for underflow.
        ADD     HL,BC
        LD      ($3C3B),HL              ; SPARE
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L19F3"></a>L19F3:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L104B">L104B</a>                   ; stk_data
        DEFB    $20                     ; a space delimiter
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L05AB">L05AB</a>                   ; word          (to pad)
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

; ---

<a name="L19FC"></a>L19FC:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0F2E">L0F2E</a>                   ; blank stack

<a name="L19FF"></a>L19FF:  RST     18H                     ; pop word DE

        LD      A,$20                   ;
        LD      (DE),A                  ;
        LD      DE,$270C                ;
        LD      HL,$27FF                ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L07FA">L07FA</a>                   ; routine SPACE_FILL

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---


<a name="L1A0E"></a>L1A0E:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18FB">L18FB</a>                   ; location of RET instruction.

; ---

<a name="L1A10"></a>L1A10:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L19F3">L19F3</a>                   ; word to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        XOR     A                       ;
        LD      ($2301),A               ;
        LD      HL,$3C51                ;
        LD      ($230E),HL              ;
        EX      DE,HL                   ;
        LD      HL,($3C37)              ; STKBOT
        AND     A                       ;
        SBC     HL,DE
        LD      ($230C),HL
        LD      HL,($3C4C)
        LD      ($2310),HL
        LD      HL,$3C31                ; CURRENT
        LD      DE,$2312
        LD      BC,$0008                ;

        LDIR                            ;

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---


<a name="L1A3D"></a>L1A3D:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L19F3">L19F3</a>                   ; word to pad
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    $230C                   ; header location
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !     store int at address
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1011">L1011</a>                   ; stack next word
        DEFW    $230E                   ; header location
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L08C1">L08C1</a>                   ; !     store int at address
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04B6">L04B6</a>                   ; exit

; ---

<a name="L1A4F"></a>L1A4F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A51">L1A51</a>

<a name="L1A51"></a>L1A51:  LD      A,($2302)               ; length of word in pad
        AND     A
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB6">L1AB6</a>                 ; forward if null.

        LD      HL,($230C)
        LD      A,H
        OR      L
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB6">L1AB6</a>                 ;

        PUSH    HL
        LD      DE,$0019                ;
        LD      HL,$2301                ; pad using ROM priority
        LD      C,D                     ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1820">L1820</a>                   ;

        POP     DE
        LD      HL,($230E)              ;
        LD      C,$FF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1820">L1820</a>                   ;

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---
; ld_bytes
; ---

<a name="L1A74"></a>L1A74:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A76">L1A76</a>

<a name="L1A76"></a>L1A76:  LD      DE,$0019
        LD      HL,$231A
        LD      C,D

        SCF

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18A7">L18A7</a>                   ;

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A76">L1A76</a>                ; loop back until read

        LD      DE,$231A
        LD      A,(DE)
        AND     A
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A95">L1A95</a>                ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1808">L1808</a>                   ; pr_inline

; ---

<a name="L1A8D"></a>L1A8D:  DEFB    $0D                     ; newline
        DEFM    "Dict"
        DEFB    ':' + $80               ;

<a name="L1A93"></a>L1A93:  JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A9F">L1A9F</a>                   ;

; ---

<a name="L1A95"></a>L1A95:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1808">L1808</a>                   ; pr_inline

<a name="L1A98"></a>L1A98:  DEFB    $0D                     ; newline

        DEFM    "Bytes"
        DEFB    ':' + $80               ;

; ---

<a name="L1A9F"></a>L1A9F:  LD      HL,$2301
        LD      BC,$0B0B
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AA9">L1AA9</a>                   ;

; ---

<a name="L1AA7"></a>L1AA7:  LD      A,(DE)
        RST     08H                     ; print_ch

<a name="L1AA9"></a>L1AA9:  LD      A,(DE)
        CP      (HL)
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AAE">L1AAE</a>                ;
        DEC     C

<a name="L1AAE"></a>L1AAE:  INC     HL
        INC     DE
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AA7">L1AA7</a>                   ;

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A76">L1A76</a>                ;
        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L1AB6"></a>L1AB6:  RST     20H                     ; <b><font color="#FF0000">Error 10</font></b>
        DEFB    $0A                     ; Tape error

; ---
;
; ---

<a name="L1AB8"></a>L1AB8:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1ABA">L1ABA</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

<a name="L1ABA"></a>L1ABA:  LD      B,$FF
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AD0">L1AD0</a>                   ; forward to +-&gt;

; ---
;
; ---

<a name="L1ABE"></a>L1ABE:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AC0">L1AC0</a>                   ; <b><font color="#3030dd">headerless 'code field'</font></b>

<a name="L1AC0"></a>L1AC0:  LD      HL,$2312
        LD      DE,$232B
        LD      B,$08

<a name="L1AC8"></a>L1AC8:  LD      A,(DE)
        INC     DE
        CP      (HL)
        INC     HL
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB6">L1AB6</a>                ; back to tape error

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AC8">L1AC8</a>                   ; back for all 8

; common code - B is $00 from above or $FF from previous.

<a name="L1AD0"></a>L1AD0:  LD      HL,($230C)
        LD      DE,($2325)
        LD      A,H
        OR      L
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1ADF">L1ADF</a>                 ; skip if zero

        SBC     HL,DE
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB6">L1AB6</a>                 ; back to tape error

<a name="L1ADF"></a>L1ADF:  LD      HL,($230E)
        LD      A,H
        OR      L
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AE9">L1AE9</a>                ; skip if zero
        LD      HL,($2327)

<a name="L1AE9"></a>L1AE9:  LD      C,$FF
        RR      B

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L18A7">L18A7</a>                   ;

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AB6">L1AB6</a>                ; back to report tape error

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ==========================================================
; THE <b><font color="#333388">'FLOATING POINT ARITHMETIC'</font></b> ROUTINES
; ==========================================================

; ---------------------
; THE <b><font color="#333388">'PREP_FP'</font></b> ROUTINE
; ---------------------
; <font color="#CC00FF">( f1, f2 -- m1, m2 )</font>
; -&gt; from add/mult/div
; Entered with two floating point numbers on the stack.
; The exponents are stored in the first two bytes of FP_WS and the third byte
; is loaded with the manipulated result sign.
; the two exponent locations on the Data Stack are blanked leaving just the
; binary coded mantissas.

; Begin by clearing the first part of the workspace.

<a name="L1AF4"></a>L1AF4:  LD      BC,$3C0F                ; byte 15 of the 19 bytes at FP_WS

        XOR     A                       ; clear accumulator.

<a name="L1AF8"></a>L1AF8:  LD      (BC),A                  ; clear the workspace.
        DEC     C                       ; decrement low byte of address.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AF8">L1AF8</a>                ; and back until at $3C00

;

        LD      HL,($3C3B)              ; fetch end of data stack+1 from SPARE.
        LD      DE,$FFFC                ; prepare  -4

        DEC     HL                      ; point to last byte of stack.
        LD      C,(HL)                  ; sign/exponent of (f2) to C.
        LD      (HL),A                  ; replace with zero to take overflow.

        ADD     HL,DE                   ; subtract four from address

; update system variable SPARE - this could be deferred.

        INC     HL                      ; point to location after (f1).
        LD      ($3C3B),HL              ; update system variable SPARE
        DEC     HL                      ; point to exponent of (f1)

        LD      B,(HL)                  ; sign/exponent of (f1) to B.
        LD      (HL),A                  ; replace with zero.

; At this stage we have the sign/exponent of (f1) in B and the sign/exponent
; of (f2) in C. The next section places the sign bit of (f1) in but 7 of A
; and the sign bit of (f2) in bit 6 of A. The other bits are of no importance.

        LD      A,C                     ; transfer C to A.
        RRCA                            ; rotate sign bit to bit 6.
        XOR     B                       ; XOR B
        AND     $7F                     ; mask off bits to restore
        XOR     B                       ; bit 6 as it was, bit 7 of B to A.

<a name="L1B13"></a>L1B13   LD      ($3C02),A               ; FP_WS_02             see <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C2F">L1C2F</a>

        RES     7,B                     ; make both numbers
        RES     7,C                     ; positive

        LD      ($3C00),BC              ; store the exponents at start of FP_WS

        INC     HL                      ; point to (f2) again.
        EX      DE,HL                   ; transfer f2 pointer to DE, HL now -4
        ADD     HL,DE                   ; subtract four to point HL at (f1)
        RET                             ; return.

; On exit, HL -&gt; (f1), DE -&gt; (f2), B = exponent of (f1), C = exponent of (f2).

; -----------------------------
; THE <b><font color="#333388">'SHIFT_ADDEND'</font></b> SUBROUTINE
; -----------------------------

<a name="L1B22"></a>L1B22:  LD      A,$09
        CP      B
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B28">L1B28</a>                ;

        LD      B,A                     ; set shift counter to nine. i.e clear.

<a name="L1B28"></a>L1B28:  LD      C,$04                   ; four bytes
        INC     HL
        INC     HL
        INC     HL                      ; point to highest byte

        XOR     A                       ; prepare to start with a blank nibble.

<a name="L1B2E"></a>L1B2E:  RRD                             ; A=0000 XXXX --&gt; 7654-&gt;3210 =(HL)
                                        ;          \_____&lt;-______/

        DEC     HL                      ; point to next lower byte on Data Stack
        DEC     C                       ; decrement the byte counter.
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B2E">L1B2E</a>                ; loop for all 4 bytes = 1 nibble shift

        INC     HL                      ; set pointer to start of number again
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B28">L1B28</a>                   ; decrement the shift counter and loop.

        ADD     A,$FB                   ; add minus five to last nibble lost
                                        ; will set the carry flag if 5 or more.

        PUSH    HL                      ;; preserve pointer to start of addend.

<a name="L1B3A"></a>L1B3A:  LD      A,(HL)                  ; fetch the pair of BCD nibbles.

        ADC     A,B                     ; increment if carry set (B = 0)
        DAA                             ; Decimal Adjust Accumulator
                                        ; ($99 becomes $00 with carry set).

        LD      (HL),A                  ; put nibbles back.
        INC     HL                      ; point to next significant pair of
                                        ; binary coded decimal digits.
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B3A">L1B3A</a>                 ; and ripple any rounding through.

        POP     HL                      ;; retrieve the pointer to start.
        RET                             ; return.

; ---------------------------
; THE <b><font color="#333388">'BCD NEGATE'</font></b> SUBROUTINE
; ---------------------------
; Negates the four byte, 8 nibble, binary coded decimal on the Data Stack.
; For example -123.456
; is prepared as $00 $12 $34 $56
; and negated as $99 $87 $65 $34

<a name="L1B43"></a>L1B43:  PUSH    BC                      ; preserve the two
        PUSH    HL                      ; main registers used.

        LD      B,$04                   ; set byte counter to four.
        AND     A                       ; clear carry.

<a name="L1B48"></a>L1B48:  LD      A,$00                   ; set to zero without disturbing carry.

        SBC     A,(HL)                  ; subtract pair of digits
        DAA                             ; Decimal Adjust Accumulator
                                        ; adjusts as if from 100 setting carry

        LD      (HL),A                  ; place adjusted decimals back.

        INC     HL                      ; next location on Data Stack.

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B48">L1B48</a>                   ; loop for all 4 bytes.

        POP     HL                      ; restore the
        POP     BC                      ; saved registers.

        RET                             ; return.

; ------------------------------
; THE <b><font color="#333388">'BCD OPERATION'</font></b> SUBROUTINE
; ------------------------------
; This versatile routine performs the binary coded decimal addition of
; two floating point values with C = 1.
; The second entry point is used in multiplication.

; -&gt;
<a name="L1B53"></a>L1B53:  LD      C,$01                   ; signal the operation is addition.

; -&gt; (with c!=0)
<a name="L1B55"></a>L1B55:  PUSH    HL                      ; preserve the
        PUSH    DE                      ; three main
        PUSH    BC                      ; registers.

        LD      A,C                     ; treat C as a binary coded decimal.
        AND     $0F                     ; isolate the right-hand nibble.
        LD      B,A                     ; transfer R.H. nibble to B

        XOR     C                       ; A now has L.H. nibble.
        LD      C,A                     ; place in C.

; this next magical routine converts the two BCD digits to binary.
; imagine we started with ninety-nine so C = 1001 0000  and B = 0000 1001

        RRCA                            ;    0100 1000
        RRCA                            ;    0010 0100
        ADD     A,C                     ;    1011 0100
        RRCA                            ;    0101 1010
        ADD     A,B                     ;    0110 0011  = 99 binary

        LD      C,A                     ;    binary multiplier in C

; note that for simple addition C is unchanged and still contains 1.

        LD      B,$04                   ; four bytes to consider
        XOR     A                       ; clear accumulator ensuring no initial
                                        ; carry is fed into the loop.

; loop

<a name="L1B67"></a>L1B67:  PUSH    BC                      ; push the counters.
        PUSH    DE                      ; push the (f2) pointer

        PUSH    HL                      ; push the (f1) pointer.

        ADD     A,(HL)                  ; add any running carry to (f1) cell.

        DAA                             ; Decimal Adjust Accumulator
                                        ; possibly setting carry.

        LD      L,A                     ; result to L
        LD      A,(DE)                  ; fetch (f2) cell value.
        LD      H,$00                   ; set high bytes H and D to
        LD      D,H                     ; zero without disturbing carry

        RL      H                       ; now pick up any carry in H.

        AND     A                       ; test (f2) cell value.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B91">L1B91</a>                 ; skip forward to just store the carry
                                        ; result if the addend value is zero.

        LD      E,A                     ; else DE now holds cell value.

<a name="L1B77"></a>L1B77:  SRL     C                       ; shift counter C   0-&gt;76543210-&gt;C

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B83">L1B83</a>                ; skip addition if no carry.

; else perform HL=HL+DE in BCD.

        LD      A,L                     ; fetch low byte of (f1) cell.
        ADD     A,E                     ; add to low byte of (f2) cell.
        DAA                             ; DAA.
        LD      L,A                     ; result in L and carry.

        LD      A,H                     ; fetch high byte possibly 1 from carry
        ADC     A,D                     ; add in any carry from above (D=0)
        DAA                             ; comes into play with multiplication.
        LD      H,A                     ; result to H.

<a name="L1B83"></a>L1B83:  INC     C                       ; test the counter for zero.
        DEC     C                       ; (will be if addition)
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B91">L1B91</a>                 ; forward when zero -&gt;

; else is BCD multiplication - double the DE value.

        LD      A,E                     ;
        ADD     A,A                     ;
        DAA                             ;
        LD      E,A                     ;

        LD      A,D                     ;
        ADC     A,A                     ;
        DAA                             ;
        LD      D,A                     ;

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B77">L1B77</a>                   ; back to continue multiplying by C.

; ---

; -&gt;
<a name="L1B91"></a>L1B91:  EX      DE,HL                   ; transfer result to DE.

        POP     HL                      ; pop (f1) cell pointer
        LD      (HL),E                  ; insert result.
        LD      A,D                     ; transfer any carry to A
        POP     DE                      ; pop the (f2) pointer
        POP     BC                      ; pop the counter, and initial C value.

        INC     DE                      ; increment (f2) cell pointer.
        INC     HL                      ; increment (f1) cell pointer.

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B67">L1B67</a>                   ; loop back for all 4 bytes.

        POP     BC                      ; restore the
        POP     DE                      ; three main
        POP     HL                      ; registers.

        RET                             ; return.

; -------------
; THE <b><font color="#333388">'F-'</font></b> WORD
; -------------
; <font color="#CC00FF">( f1, f2 -- f1-f2 )</font>
; Subtracts top two floating point numbers.
;
; just flip the sign and then do floating point addition.

<a name="L1B9F"></a>L1B9F:  DEFB    'F'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '-' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1989">L1989</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1BA3"></a>L1BA3:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1BA4"></a>L1BA4:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0EC3">L0EC3</a>                   ; <b><font color="#3030dd">'code field'</font></b> - docolon

; ---

<a name="L1BA6"></a>L1BA6:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D0F">L1D0F</a>                   ; fnegate
        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1A0E">L1A0E</a>                   ; end-forth.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BB3">L1BB3</a>                   ; forward to floating point addition.

; -------------
; THE <b><font color="#333388">'F+'</font></b> WORD
; -------------
; <font color="#CC00FF">( f1, f2 -- f1+f2 )</font>
; Adds top two floating point numbers.

<a name="L1BAC"></a>L1BAC:  DEFB    'F'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '+' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BA3">L1BA3</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1BB0"></a>L1BB0:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1BB1"></a>L1BB1:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BB3">L1BB3</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1BB3"></a>L1BB3:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AF4">L1AF4</a>                   ; PREP_FP

        LD      A,C                     ; take exponent of second number (f2).
        SUB     B                       ; subtract exponent of first (f1).
        PUSH    AF                      ; save result flags.

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BC1">L1BC1</a>                ; forward if second number &gt;= first.

        EX      DE,HL                   ; else swap the pointers.
        NEG                             ; negate negative result.
        LD      (IX+$00),B              ; place B in FP_WS_0  (was C).

<a name="L1BC1"></a>L1BC1:  LD      B,A                     ; put positive subtraction result in B.

        CALL    NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B22">L1B22</a>                ; routine SHIFT_ADDEND aligns digits if
                                        ; exponents are not equal.

        POP     AF                      ; retrieve subtraction result flags.
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BC9">L1BC9</a>                ; forward is second number was &gt;= first.

        EX      DE,HL                   ; else switch the pointers back.

<a name="L1BC9"></a>L1BC9:  LD      B,$02                   ; two floating point numbers to consider

        LD      C,(IX+$02)              ; FP_WS_02

<a name="L1BCE"></a>L1BCE:  RL      C                       ; test sign bit first bit 7 then bit 6.

        CALL    C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B43">L1B43</a>                 ; routine BCD neg if carry

        EX      DE,HL                   ; switch number pointers.

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BCE">L1BCE</a>                   ; decrement counter and loop if second
                                        ; number still to do.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B53">L1B53</a>                   ; the BCD ADDITION routine.

; The routine preserves main registers so HL-&gt;(f1), DE-&gt;(f2) and B is zero.

        DEC     DE                      ; point to highest byte of result which
                                        ; could be $99 if one negative number
                                        ; involved or $98 if two negatives.

        LD      A,(DE)                  ; fetch the result sign byte.
        ADD     A,$68                   ; add $68 causing carry if negative.
        RR      B                       ; pick up carry in bit 7 of B, which
                                        ; was zero so zero flag now set if none.

        LD      (IX+$02),B              ; place result sign in  FP_WS_02

        CALL    NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B43">L1B43</a>                ; routine BCD_NEGATE if negative result.

; if the

<a name="L1BE5"></a>L1BE5:  LD      A,(DE)                  ;
        AND     A                       ;

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C02">L1C02</a>                ;

; else A is zero.

        DEC     (IX+$00)                ; decrement the result exponent FP_WS_00
        DEC     (IX+$00)                ; as two nibbles will be moved at a time

        PUSH    DE                      ; save pointer to 4th byte

        LD      H,D                     ; make HL
        LD      L,E                     ; equal to DE
        DEC     HL                      ; minus one.

        LD      BC,$03FF                ; counter for three bytes. The $FF
                                        ; value ensures B is not affected by
                                        ; the LDD instruction. Also A is 0.

<a name="L1BF6"></a>L1BF6:  OR      (HL)                    ; (detects if the three bytes are zero)

        LDD                             ; copy HL contents one location higher
                                        ; to that addressed by DE. Also dec bc.

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BF6">L1BF6</a>                   ; repeat for all 3 bytes

        EX      DE,HL                   ; make HL address lowest location
        LD      (HL),B                  ; and insert a zero into vacated byte.

        POP     DE                      ; restore the pointer to the 4th byte.

        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BE5">L1BE5</a>                ; jump back to the end test if something
                                        ; was being shifted through.

; else all four bytes are zero - i.e. the result of the addition is zero.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

; The branch was to here, from the end test above, when the 4th byte had been
; filled.
; Before joining common code, ensure that the initial block move will be
; ineffective.

<a name="L1C02"></a>L1C02:  LD      D,H                     ; make DE the same as HL - the source
        LD      E,L                     ; and the destination are the same.

; -&gt; common code from mult and above.

<a name="L1C04"></a>L1C04:  PUSH    DE                      ; save start location.

        LD      BC,$0004                ; 4 bytes to consider.
        LDIR                            ; block move sets DE to one past dest.

        POP     HL                      ; restore start of source.

        DEC     DE                      ; DE now addresses 4th byte.

<a name="L1C0C"></a>L1C0C:  LD      A,(DE)                  ; load the 4th byte to accumulator.
        AND     A                       ; test for zero.

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C21">L1C21</a>                 ; skip forward if so.

        CP      $10                     ; test if one or two nibbles populated
                                        ; setting carry for a single nibble.

        SBC     A,A                     ; $00 for two nibbles, $FF for one.
        INC     A                       ; $01                  $00
        INC     A                       ; $02 for two nibbles, $01 for one :-)

        LD      B,A                     ; nibble count to B.
        ADD     A,(IX+$00)              ; add count to FP_WS_00 the result
        LD      ($3C00),A               ; exponent and place back in FP_WS_00.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B22">L1B22</a>                   ; routine 'shift_addend' moves all the
                                        ; nibbles to the right.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C0C">L1C0C</a>                   ; back to pick up byte and then to
                                        ; next routine.

; ---

; now test for a result that is too large or too small.
; <font color="#9900FF">Note.</font> these results may have arisen from multiplication or addition.

<a name="L1C21"></a>L1C21:  LD      A,($3C00)               ; fetch result exponent from FP_WS_00

        DEC     A                       ; decrement?
        CP      $BF                     ; compare lower limit
        INC     A                       ; increment?

        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C3D">L1C3D</a>                ; forward if less to ZERO_RSLT

        CP      $80                     ; compare upper limit
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C3B">L1C3B</a>                ; forward to Error 8 - Overflow

        LD      B,A                     ; save unsigned exponent in B.

; now combine result sign and the exponent.
; for addition then FP_WS_02 contains either $80 or $00 and most of what
; follows does not apply.
; for multiplication then bit 7 is sign of (f1) bit 6 is sign of (f2).

<a name="L1C2F"></a>L1C2F   LD      A,($3C02)               ; FP_WS_02           see <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B13">L1B13</a>

        LD      C,A                     ; save a copy in C
        RLA                             ; rotate bit 6 to 7
        XOR     C                       ; XOR bit 7 - minus * minus = a plus.
        AND     $80                     ; only interested in bit 7.
        XOR     B                       ; combine with exponent.
        LD      (DE),A                  ; and place in sign/exp on Data Stack.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; ---

<a name="L1C3B"></a>L1C3B:  RST     20H                     ; <b><font color="#FF0000">Error 8.</font></b>
        DEFB    $08                     ; Overflow in floating-point arithmetic.

; ------------------------------------
; THE <b><font color="#333388">'ZERO RESULT'</font></b> TERMINATING BRANCH
; ------------------------------------

<a name="L1C3D"></a>L1C3D:  LD      BC,$0400                ; count 4 bytes, fill byte is zero.

<a name="L1C40"></a>L1C40:  LD      (HL),C                  ; insert a zero.
        INC     HL                      ; next location.
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C40">L1C40</a>                   ; repeat for all 4 bytes.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>




; -------------
; THE <b><font color="#333388">'F*'</font></b> WORD
; -------------
; <font color="#CC00FF">(f1, f2 -- f1*f2)</font>
; Multiplies top two floating point numbers and leaves result on the stack.

<a name="L1C46"></a>L1C46:  DEFB    'F'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '*' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1BB0">L1BB0</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1C4A"></a>L1C4A:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1C4B"></a>L1C4B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C4D">L1C4D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1C4D"></a>L1C4D:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AF4">L1AF4</a>                   ; routine PREP_FP prepares the two
                                        ; numbers on the Data Stack placing the
                                        ; exponents and signs in FP_WS.

        XOR     A                       ; set accumulator to zero.
        CP      B                       ; compare to exponent of (f1).
        SBC     A,A                     ; $00 if zero or $FF
        AND     C                       ; combine with exponent of (f2).

        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C3D">L1C3D</a>                 ; back if zero to exit via ZERO_RSLT.

        PUSH    HL                      ; save pointer to first number - result.

        LD      BC,$3C02                ; set BC to location before free
                                        ; workspace set to zero by PREP_FP.

        PUSH    BC                      ; push onto machine stack.

        LD      B,$03                   ; count three bytes - six nibbles.

<a name="L1C5D"></a>L1C5D:  LD      C,(HL)                  ; fetch BCD pair to C
        INC     HL                      ; address more significant pair.

        EX      (SP),HL                 ; Data Stack pointer to machine stack,
                                        ; workspace pointer to HL.
        INC     HL                      ; increment workspace pointer.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B55">L1B55</a>                   ; routine BCD_OP multiplies C by each
                                        ; of the 4 bytes of (f2) laying the
                                        ; result down in workspace at HL

        EX      (SP),HL                 ; swap in multiplier pointer to HL,
                                        ; workspace pointer to machine stack.

        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C5D">L1C5D</a>                   ; repeat for all three bytes.

        LD      BC,($3C00)              ; fetch raw exponents from FP_WS_00/01
        LD      A,B                     ; add the exponents
        ADD     A,C                     ; together.

        SUB     $42                     ; adjust for sign

        LD      ($3C00),A               ; put the result back in FP_WS_00.

        POP     HL                      ; pop workspace pointer to HL.
        POP     DE                      ; pop result pointer to DE.

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C04">L1C04</a>                   ; back to common code to copy the 4
                                        ; bytes from the workspace to the
                                        ; Data Stack and then set exponent
                                        ; and sign.

; -------------
; THE <b><font color="#333388">'F/'</font></b> WORD
; -------------
; <font color="#CC00FF">( f1, f2 -- f1/f2 )</font>
; Divides two floating point numbers.

<a name="L1C76"></a>L1C76:  DEFB    'F'                     ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    '/' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C4A">L1C4A</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1C7A"></a>L1C7A:  DEFB    $02                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1C7B"></a>L1C7B:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C7D">L1C7D</a>                   ; <b><font color="#3030dd">'code field'</font></b>

;---

<a name="L1C7D"></a>L1C7D:  CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1AF4">L1AF4</a>                   ; routine PREP_FP prepares the two
                                        ; numbers (f1) and (f2) placing the
                                        ; raw exponents in the first two
                                        ; locations of workspace, the signs in
                                        ; the next location and clearing the
                                        ; sixteen remaining locations.
                                        ; This must be the one that uses them
                                        ; all.

        XOR     A                       ; set accumulator to zero.
        CP      B                       ; compare to exponent of dividend (f1).
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C3D">L1C3D</a>                 ; forward if zero to ZERO_RSLT.

        CP      C                       ; compare to exponent of divisor (f2).
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C3B">L1C3B</a>                 ; back if zero to Error 8 - Overflow.
                                        ; division by zero.

; HL points to first number on stack, DE to second.

        INC     DE                      ;
        INC     DE                      ;
        LD      A,(DE)                  ; get first two digits to A
        DEC     DE                      ;
        DEC     DE                      ; back to first

        ADD     A,$01                   ; add one (e.g. 99 would give 9A)
        DAA                             ; adjust  (e.g. $9A would be $00 carry)
        EX      AF,AF'                  ; save the flags
        EX      DE,HL                   ; HL now points to divisor

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B43">L1B43</a>                   ; routine BCD negate the divisor

        EX      DE,HL                   ; point back again.
        PUSH    HL                      ; save pointer to first - the result.

        LD      DE,$3C10                ; destination FP_WS_10
        LD      BC,$0004                ; four bytes

        LDIR                            ; copy to end of FP_WS
                                        ; (+ one byte of list_ws)

        EX      DE,HL                   ; HL points to last cell plus one.
        DEC     HL                      ; Now points to last byte copied.

        LD      B,$05                   ; count 5.

; loop

<a name="L1CA2"></a>L1CA2:  PUSH    DE                      ;
        LD      A,(HL)                  ;
        DEC     HL                      ;
        LD      E,(HL)                  ;

        EX      AF,AF'                  ;
        LD      C,A                     ;
        EX      AF,AF'                  ;

        INC     C                       ;
        DEC     C                       ;
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CB0">L1CB0</a>                ;

        LD      E,A                     ;
        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CCB">L1CCB</a>                   ;

; ---

<a name="L1CB0"></a>L1CB0:  PUSH    BC                      ;
        LD      B,$02                   ;

<a name="L1CB3"></a>L1CB3:  LD      D,$10                   ;

<a name="L1CB5"></a>L1CB5:  SLA     E                       ;
        RLA                             ;
        RL      D                       ;
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CB5">L1CB5</a>                ;

        INC     D                       ;

<a name="L1CBD"></a>L1CBD:  SUB     C                       ;
        DAA                             ;
        INC     E                       ;
        JR      NC,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CBD">L1CBD</a>                ;

        DEC     D                       ;
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CBD">L1CBD</a>                ;

        ADD     A,C                     ;
        DAA                             ;
        DEC     E                       ;
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CB3">L1CB3</a>                   ;

        POP     BC                      ;

<a name="L1CCB"></a>L1CCB:  LD      C,E                     ;
        POP     DE                      ;
        INC     C                       ;
        DEC     C                       ;
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CE8">L1CE8</a>                 ;

        PUSH    HL                      ;
        DEC     HL                      ;
        DEC     HL                      ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B55">L1B55</a>                   ; bcd_op mult

        PUSH    DE                      ;

        LD      DE,$FFFB                ; -4
        ADD     HL,DE                   ;

        LD      DE,$3C03                ; FP_WS_03
        LD      A,C                     ;
        LD      (DE),A                  ;

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1B53">L1B53</a>                   ; bcd_op add

        POP     DE                      ;
        POP     HL                      ;
        INC     HL                      ;
        INC     B                       ;

<a name="L1CE8"></a>L1CE8:  DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CA2">L1CA2</a>                   ;

        LD      HL,($3C00)              ; FP_WS
        LD      A,H                     ;
        SUB     L                       ;
        ADD     A,$40                   ;

        LD      HL,$3C08                ; FP_WS
        LD      B,A                     ;
        LD      A,($3C0B)               ;
        AND     A                       ;
        JR      NZ,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1CFE">L1CFE</a>                ;

        DEC     B                       ;
        DEC     B                       ;
        DEC     HL                      ;

<a name="L1CFE"></a>L1CFE:  LD      (IX+$00),B              ;

        POP     DE                      ;

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C04">L1C04</a>                   ; back to common code to copy the 4
                                        ; bytes from the workspace to the
                                        ; Data Stack and then set exponent
                                        ; and sign.

; ------------------
; THE <b><font color="#333388">'FNEGATE'</font></b> WORD
; ------------------
; <font color="#CC00FF">( f -- -f )</font>
; Floating point negation.
; Toggle the sign bit unless the number is zero (four zero bytes).

<a name="L1D05"></a>L1D05:  DEFM    "FNEGAT"                ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'E' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1C7A">L1C7A</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1D0E"></a>L1D0E:  DEFB    $07                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1D0F"></a>L1D0F:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D11">L1D11</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1D11"></a>L1D11:  RST     18H                     ; pop word from data stack to DE.

        LD      A,D                     ; exponent byte to A.
        AND     A                       ; test for zero.
        JR      Z,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D18">L1D18</a>                 ; forward if so to leave undisturbed.

        XOR     $80                     ; else toggle the sign bit

<a name="L1D18"></a>L1D18:  LD      D,A                     ; exponent byte to D.
        RST     10H                     ; push word DE on data stack.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; --------------
; THE <b><font color="#333388">'INT'</font></b> WORD
; --------------
; <font color="#CC00FF">(f -- n)</font>
; Converts signed floating point number to signed single length integer.
; Truncates towards zero.
; Result in range -32768 to 32767

<a name="L1D1C"></a>L1D1C:  DEFM    "IN"                    ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' + $80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D0E">L1D0E</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1D21"></a>L1D21:  DEFB    $03                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1D22"></a>L1D22:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D24">L1D24</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1D24"></a>L1D24:  LD      HL,($3C3B)              ; fetch value from SPARE.
        DEC     HL                      ; now points to end of data stack.

        LD      DE,$0000                ; initialize 16-bit result.

<a name="L1D2B"></a>L1D2B:  LD      A,(HL)                  ; fetch the exponent byte.

        RLCA                            ; double exponent moving sign bit to 0.

        CP      $82                     ; compare exponent to plus 1.
        JR      C,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D45">L1D45</a>                 ; forward if number is smaller than 1
                                        ; to return the result DE.

; else the number is &gt;= 1.0

        XOR     A                       ; clear accumulator.
        DEC     HL                      ; point to the first pair of BCD digits.

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0732">L0732</a>                   ; call shift_fp

        INC     HL                      ; point to exponent.

        EX      DE,HL                   ; pointer to DE, integer to HL.

; before adding in the nibble from the mantissa, multiply any previous result
; by ten.

        LD      B,H                     ; make a copy of HL in BC.
        LD      C,L                     ;

        ADD     HL,HL                   ; * 2
        ADD     HL,HL                   ; * 4
        ADD     HL,BC                   ; * 5
        ADD     HL,HL                   ; * 10

        LD      C,A                     ; leftmost nibble from mantissa to C.
        LD      B,$00                   ; prepare to add just the nibble.
        ADD     HL,BC                   ; add into the result.
        EX      DE,HL                   ; switch back to DE

        JR      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D2B">L1D2B</a>                   ; back to loop.

; ---

<a name="L1D45"></a>L1D45:  DEC     HL                      ; skip redundant components of Floating
        DEC     HL                      ; Point number addressing the
                                        ; lower two bytes on the data stack.
        LD      (HL),D                  ; insert high-order byte first.
        DEC     HL                      ; point to location beneath.
        LD      (HL),E                  ; insert low-order byte.

        LD      DE,<a href="http://www.jupiter-ace.co.uk/romlisting.html#L0D94">L0D94</a>                ; 'pos' addr.

        JP      <a href="http://www.jupiter-ace.co.uk/romlisting.html#L04BF">L04BF</a>                   ; exit via 'pos' routine.

; -----------------
; THE <b><font color="#333388">'UFLOAT'</font></b> WORD
; -----------------
; <font color="#CC00FF">(un -- f)</font>
; Converts unsigned single length integer to floating point.
; e.g. 65535 16 bit number converted to  32-bit float 8-bit sign/exponent
; 6-nibble BCD mantissa.    $45  6 5 5 3 5 0

<a name="L1D50"></a>L1D50:  DEFM    "UFLOA"                 ; <b><font color="#3030dd">'name field'</font></b>
        DEFB    'T' +$80

        DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D21">L1D21</a>                   ; <b><font color="#3030dd">'link field'</font></b>

<a name="L1D58"></a>L1D58:  DEFB    $06                     ; <b><font color="#3030dd">'name length field'</font></b>

<a name="L1D59"></a>L1D59:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D5B">L1D5B</a>                   ; <b><font color="#3030dd">'code field'</font></b>

; ---

<a name="L1D5B"></a>L1D5B:  RST     18H                     ; pop word off stack to DE
        EX      DE,HL                   ; now HL

        LD      BC,$1000                ; count 16 bits, set C to zero.
        LD      D,C
        LD      E,C                     ; initialize DE to zero.

<a name="L1D62"></a>L1D62:  ADD     HL,HL                   ; double

        LD      A,E                     ;
        ADC     A,A                     ; add carry to low byte
        DAA                             ; adjust
        LD      E,A                     ;

        LD      A,D                     ;
        ADC     A,A                     ; add carry to high byte
        DAA                             ; adjust
        LD      D,A                     ;

        RL      C                       ; pick up overflow
        DJNZ    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D62">L1D62</a>                   ; loop  back for 16 bits

        RST     10H                     ; DE to Data stack.

        LD      D,$46                   ; exponent byte   +6
        LD      E,C                     ; low byte

        RST     10H                     ; higher word of float to stack.

        DEC     HL                      ; point to
        DEC     HL                      ; lower on stack

        CALL    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L0740">L0740</a>                   ; normalize routine.

        JP      (IY)                    ; to <b><font color="#3399CC">'next'.</font></b>

; -------------------
; THE <b><font color="#333388">'CHARACTER SET'</font></b>
; -------------------
; The 96 ASCII character bitmaps are copied to RAM during initialization and
; the 8x8 characters can afterwards be redefined by the user.
; Some ROM space is saved by supplying the blank top line of most characters
; and in case of the middle range (capitals with no descenders) the bottom
; line as well. Only the final copyright symbol is held in ROM as an 8x8
; character.


; $20 - <b>Character: ' '          </b>CHR$(32)

<a name="L&lt;B&gt;1"></a>L<b>1</b>D7B:  DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000

; $21 - <b>Character: '!'          </b>CHR$(33)

        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $22 - <b>Character: '"'          </b>CHR$(34)

        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000

; $23 - <b>Character: '#'          </b>CHR$(35)

        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %00000000

; $24 - <b>Character: '$'          </b>CHR$(36)

        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>0<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000

; $25 - <b>Character: '%'          </b>CHR$(37)

        DEFB    %0<b>1</b><b>1</b>000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b>00<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00<b>1</b><b>1</b>0
        DEFB    %0<b>1</b>000<b>1</b><b>1</b>0
        DEFB    %00000000

; $26 - <b>Character: '&amp;'          </b>CHR$(38)

        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>0<b>1</b>0<b>1</b>0
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b>0<b>1</b>0
        DEFB    %00000000

; $27 - <b>Character: '''          </b>CHR$(39)

        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000

; $28 - <b>Character: '('          </b>CHR$(40)

        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00000<b>1</b>00
        DEFB    %00000000

; $29 - <b>Character: ')'          </b>CHR$(42)

        DEFB    %00<b>1</b>00000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00000
        DEFB    %00000000

; $2A - <b>Character: '*'          </b>CHR$(42)

        DEFB    %00000000
        DEFB    %000<b>1</b>0<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0<b>1</b>00
        DEFB    %00000000

; $2B - <b>Character: '+'          </b>CHR$(43)

        DEFB    %00000000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00000000

; $2C - <b>Character: ','          </b>CHR$(44)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000

; $2D - <b>Character: '-'          </b>CHR$(45)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000

; $2E - <b>Character: '.'          </b>CHR$(46)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %00000000

; $2F - <b>Character: '/'          </b>CHR$(47)

        DEFB    %00000000
        DEFB    %000000<b>1</b>0
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00000
        DEFB    %00000000

; $30 - <b>Character: '0'          </b>CHR$(48)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b><b>1</b>0
        DEFB    %0<b>1</b>00<b>1</b>0<b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b>00<b>1</b>0
        DEFB    %0<b>1</b><b>1</b>000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $31 - <b>Character: '1'          </b>CHR$(49)

        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $32 - <b>Character: '2'          </b>CHR$(50)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %000000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $33 - <b>Character: '3'          </b>CHR$(51)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %000000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $34 - <b>Character: '4'          </b>CHR$(52)

        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %0<b>1</b>00<b>1</b>000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %00000000

; $35 - <b>Character: '5'          </b>CHR$(53)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %000000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $36 - <b>Character: '6'          </b>CHR$(54)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $37 - <b>Character: '7'          </b>CHR$(55)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %000000<b>1</b>0
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $38 - <b>Character: '8'          </b>CHR$(56)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $39 - <b>Character: '9'          </b>CHR$(57)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %000000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $3A - <b>Character: ':'          </b>CHR$(58)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $3B - <b>Character: ';'          </b>CHR$(59)

        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00000

; $3C - <b>Character: '&lt;'          </b>CHR$(60)

        DEFB    %00000000
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b>000
        DEFB    %00000<b>1</b>00
        DEFB    %00000000

; $3D - <b>Character: '='          </b>CHR$(61)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000
        DEFB    %00000000

; $3E - <b>Character: '&gt;'          </b>CHR$(62)

        DEFB    %00000000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b>000
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $3F - <b>Character: '?'          </b>CHR$(63)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %00000000
        DEFB    %0000<b>1</b>000

; $40 - <b>Character: '@'          </b>CHR$(64)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>00<b>1</b>0<b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $41 - <b>Character: 'A'          </b>CHR$(65)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0

; $42 - <b>Character: 'B'          </b>CHR$(66)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00

; $43 - <b>Character: 'C'          </b>CHR$(67)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $44 - <b>Character: 'D'          </b>CHR$(68)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000

; $45 - <b>Character: 'E'          </b>CHR$(69)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0

; $46 - <b>Character: 'F'          </b>CHR$(70)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000

; $47 - <b>Character: 'G'          </b>CHR$(71)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>00<b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $48 - <b>Character: 'H'          </b>CHR$(72)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0

; $49 - <b>Character: 'I'          </b>CHR$(73)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0

; $4A - <b>Character: 'J'          </b>CHR$(74)

        DEFB    %000000<b>1</b>0
        DEFB    %000000<b>1</b>0
        DEFB    %000000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $4B - <b>Character: 'K'          </b>CHR$(75)

        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>00<b>1</b>000
        DEFB    %0<b>1</b><b>1</b><b>1</b>0000
        DEFB    %0<b>1</b>00<b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0

; $4C - <b>Character: 'L'          </b>CHR$(76)

        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0

; $4D - <b>Character: 'M'          </b>CHR$(77)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b>00<b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b><b>1</b>0<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0

; $4E - <b>Character: 'N'          </b>CHR$(78)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b>000<b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b>00<b>1</b>0
        DEFB    %0<b>1</b>00<b>1</b>0<b>1</b>0
        DEFB    %0<b>1</b>000<b>1</b><b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0

; $4F - <b>Character: 'O'          </b>CHR$(79)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $50 - <b>Character: 'P'          </b>CHR$(80)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000

; $51 - <b>Character: 'Q'          </b>CHR$(81)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b>00<b>1</b>0
        DEFB    %0<b>1</b>00<b>1</b>0<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $52 - <b>Character: 'R'          </b>CHR$(82)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0

; $53 - <b>Character: 'S'          </b>CHR$(83)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %000000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00

; $54 - <b>Character: 'T'          </b>CHR$(84)

        DEFB    %<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000

; $55 - <b>Character: 'U'          </b>CHR$(85)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0

; $56 - <b>Character: 'V'          </b>CHR$(86)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %000<b>1</b><b>1</b>000

; $57 - <b>Character: 'W'          </b>CHR$(87)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %0<b>1</b>0<b>1</b><b>1</b>0<b>1</b>0
        DEFB    %00<b>1</b>00<b>1</b>00

; $58 - <b>Character: 'X'          </b>CHR$(88)

        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0

; $59 - <b>Character: 'Y'          </b>CHR$(89)

        DEFB    %<b>1</b>00000<b>1</b>0
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000

; $5A - <b>Character: 'Z'          </b>CHR$(90)

        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000<b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0

; $5B - <b>Character: '['          </b>CHR$(91)

        DEFB    %0000<b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b><b>1</b><b>1</b>0

; $5C - <b>Character: '\'          </b>CHR$(92)

        DEFB    %00000000
        DEFB    %0<b>1</b>000000
        DEFB    %00<b>1</b>00000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b>000
        DEFB    %00000<b>1</b>00

; $5D - <b>Character: ']'          </b>CHR$(93)

        DEFB    %0<b>1</b><b>1</b><b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %0<b>1</b><b>1</b><b>1</b>0000

; $5E - <b>Character: '^'          </b>CHR$(94)

        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000

; $5F - <b>Character: '_'          </b>CHR$(95)

        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>

; $60 - <b>Character:  £           </b>CHR$(96)

        DEFB    %000<b>1</b><b>1</b><b>1</b>00
        DEFB    %00<b>1</b>000<b>1</b>0
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $61 - <b>Character: 'a'          </b>CHR$(97)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %00000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $62 - <b>Character: 'b'          </b>CHR$(98)

        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00<b>1</b>000<b>1</b>0
        DEFB    %00<b>1</b>000<b>1</b>0
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $63 - <b>Character: 'c'          </b>CHR$(99)

        DEFB    %00000000
        DEFB    %000<b>1</b><b>1</b><b>1</b>00
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %000<b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $64 - <b>Character: 'd'          </b>CHR$(100)

        DEFB    %00000<b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $65 - <b>Character: 'e'          </b>CHR$(101)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $66 - <b>Character: 'f'          </b>CHR$(102)

        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b><b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $67 - <b>Character: 'g'          </b>CHR$(103)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b>000

; $68 - <b>Character: 'h'          </b>CHR$(104)

        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00000000

; $69 - <b>Character: 'i'          </b>CHR$(105)

        DEFB    %000<b>1</b>0000
        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %00000000

; $6A - <b>Character: 'j'          </b>CHR$(106)

        DEFB    %00000<b>1</b>00
        DEFB    %00000000
        DEFB    %00000<b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %000<b>1</b><b>1</b>000

; $6B - <b>Character: 'k'          </b>CHR$(107)

        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %00<b>1</b><b>1</b>0000
        DEFB    %00<b>1</b><b>1</b>0000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %00<b>1</b>00<b>1</b>00
        DEFB    %00000000

; $6C - <b>Character: 'l'          </b>CHR$(108)

        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %00000000

; $6D - <b>Character: 'm'          </b>CHR$(109)

        DEFB    %00000000
        DEFB    %0<b>1</b><b>1</b>0<b>1</b>000
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %00000000

; $6E - <b>Character: 'n'          </b>CHR$(110)

        DEFB    %00000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00000000

; $6F - <b>Character: 'o'          </b>CHR$(111)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %00000000

; $70 - <b>Character: 'p'          </b>CHR$(112)

        DEFB    %00000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000000
        DEFB    %0<b>1</b>000000

; $71 - <b>Character: 'q'          </b>CHR$(113)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00000<b>1</b><b>1</b>0

; $72 - <b>Character: 'r'          </b>CHR$(114)

        DEFB    %00000000
        DEFB    %000<b>1</b><b>1</b><b>1</b>00
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %00<b>1</b>00000
        DEFB    %00000000

; $73 - <b>Character: 's'          </b>CHR$(115)

        DEFB    %00000000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %0<b>1</b>000000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %00000<b>1</b>00
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b>000
        DEFB    %00000000

; $74 - <b>Character: 't'          </b>CHR$(116)

        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b><b>1</b><b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %00000000

; $75 - <b>Character: 'u'          </b>CHR$(117)

        DEFB    %00000000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $76 - <b>Character: 'v'          </b>CHR$(118)

        DEFB    %00000000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00000000

; $77 - <b>Character: 'w'          </b>CHR$(119)

        DEFB    %00000000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %0<b>1</b>0<b>1</b>0<b>1</b>00
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %00000000

; $78 - <b>Character: 'x'          </b>CHR$(120)

        DEFB    %00000000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>0<b>1</b>000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00000000

; $79 - <b>Character: 'y'          </b>CHR$(121)

        DEFB    %00000000
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %0<b>1</b>000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000<b>1</b>00
        DEFB    %00<b>1</b><b>1</b><b>1</b>000

; $7A - <b>Character: 'z'          </b>CHR$(122)

        DEFB    %00000000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0000<b>1</b>000
        DEFB    %000<b>1</b>0000
        DEFB    %00<b>1</b>00000
        DEFB    %0<b>1</b><b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %00000000

; $7B - <b>Character: '{'          </b>CHR$(123)

        DEFB    %0000<b>1</b><b>1</b><b>1</b>0
        DEFB    %0000<b>1</b>000
        DEFB    %00<b>1</b><b>1</b>0000
        DEFB    %00<b>1</b><b>1</b>0000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b><b>1</b><b>1</b>0
        DEFB    %00000000

; $7C - <b>Character: '|'          </b>CHR$(124)

        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %0000<b>1</b>000
        DEFB    %00000000

; $7D - <b>Character: '}'          </b>CHR$(125)

        DEFB    %0<b>1</b><b>1</b><b>1</b>0000
        DEFB    %000<b>1</b>0000
        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %0000<b>1</b><b>1</b>00
        DEFB    %000<b>1</b>0000
        DEFB    %0<b>1</b><b>1</b><b>1</b>0000
        DEFB    %00000000

; $7E - <b>Character: '~'          </b>CHR$(126)

        DEFB    %00<b>1</b><b>1</b>00<b>1</b>0
        DEFB    %0<b>1</b>00<b>1</b><b>1</b>00
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000
        DEFB    %00000000

; $7F - <b>Character:  ©           </b>CHR$(127)

        DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00
        DEFB    %0<b>1</b>0000<b>1</b>0
        DEFB    %<b>1</b>00<b>1</b><b>1</b>00<b>1</b>
        DEFB    %<b>1</b>0<b>1</b>0000<b>1</b>
        DEFB    %<b>1</b>0<b>1</b>0000<b>1</b>
        DEFB    %<b>1</b>00<b>1</b><b>1</b>00<b>1</b>
        DEFB    %0<b>1</b>0000<b>1</b>0
<a name="L1"></a>L<b>1</b>
         FFB:  DEFB    %00<b>1</b><b>1</b><b>1</b><b>1</b>00


; ---------------
; THE <b><font color="#333388">'SPARE'</font></b> ROM
; ---------------

<a name="L1FFC"></a>L1FFC:  DEFB    $FF                     ; unused

; ----------
; THE <b><font color="#333388">'LINK'</font></b>
; ----------

; The FORTH word copied to RAM links back to <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1FFF">L1FFF</a>

<a name="L1FFD"></a>L1FFD:  DEFW    <a href="http://www.jupiter-ace.co.uk/romlisting.html#L1D58">L1D58</a>                   ; pointer to prev - UFLOAT
<a name="L1FFF"></a>L1FFF:  DEFB    $00                     ; length of dummy word zero


.END

; -----------
;
; -----------
; ----------------------
; THE <b><font color="#333388">'SYSTEM VARIABLES'</font></b>
; ----------------------
; "Here is a list of system variables. We have given them all names, but that
; is just for ease of reference. The Ace will not recognize these names,
; except for a few, like <b>'BASE'</b>, that are FORTH words. I've written these
; FORTH words in bold type in the usual way."
;
;
; FP_WS         $3C00 (15360)   19 bytes used as work space for floating point
;                               arithmetic.
;
; LISTWS        $3C13 (15379)   5 bytes used as workspace by <b>'LIST'</b> and <b>'EDIT'</b>.
;
; RAMTOP        $3C18 (15384)   2 bytes - the first address past the last
;                               address in RAM.
;
; HLD           $3C1A (15386)   2 bytes. The address of the latest character
;                               held in the pad by formatted output.
;                               (<b>'#'</b>, <b>'HOLD'</b> and so on).
;
; SCRPOS        $3C1C (15388)   2 bytes. The address of the place in video RAM
;                               where the next character is to be printed
;                               (i.e. the <i>'print position'</i>).
;
; INSCRN        $3C1E (15390)   2 bytes. The address of the start of the
;                               current <i>'logical line'</i> in the input buffer.
;
; CURSOR        $3C20 (15392)   2 bytes. The address of the cursor in the
;                               input buffer.
;
; ENDBUF        $3C22 (15394)   2 bytes. The address of the end of the current
;                               logical line in the input buffer.
;
; L_HALF        $3C24 (15396)   2 bytes. The address of the start of the the
;                               input buffer. The input buffer itself is stored
;                               in the video RAM, where you see it.
;
; KEYCOD        $3C26 (15398)   1 byte. The ASCII code of the last key pressed.
;
; KEYCNT        $3C27 (15399)   1 byte. Used by the routine that reads the
;                               keyboard.
;
; STATIN        $3C28 (15400)   1 byte. Used by the routine that reads the
;                               keyboard.
;
; EXWRCH        $3C29 (15401)   2 bytes. This is normally 0 but it can be
;                               changed to allow printing to be sent to some
;                               device other than the screen.
;
; FRAMES        $3C2B (15403)   4 bytes. These four bytes form a double length
;                               integer that counts the time since the Ace was
;                               switched on in 50ths of a second.
;
; XCOORD        $3C2F (15407)   1 byte. The x-coordinate last used by <b>'PLOT'</b>.
;
; YCOORD        $3C30 (15408)   1 byte. The y-coordinate last used by <b>'PLOT'</b>.
;
; CURRENT       $3C31 (15409)   2 bytes. The parameter field address for the
;                               vocabulary word of the current vocabulary.
;
; CONTEXT       $3C33 (15411)   2 bytes. The parameter field address for the
;                               vocabulary word of the context vocabulary.
;
; VOCLNK        $3C35 (15413)   2 bytes. The address of the fourth byte in the
;                               parameter field - the vocabulary linkage - of
;                               the vocabulary word of the most recently
;                               defined vocabulary.
;
; STKBOT        $3C37 (15415)   2 bytes. The address of the next byte into
;                               which anything will be enclosed in the
;                               dictionary, i.e. one byte past the present end
;                               of the dictionary.
;                               <b>'HERE'</b> is equivalent to 15415 @.
;
; DICT          $3C39 (15417)   2 bytes. The address of the length field in the
;                               newest word in the dictionary. If that length
;                               field is correctly filled in then DICT may
;                               be 0.
;
; SPARE         $3C3B (15419)   2 bytes. The address of the first byte past the
;                               top of the stack.
;
; ERR_NO        $3C3D (15421)   1 byte. This is usually 255, meaning "no error".
;                               If <b>'ABORT'</b> is used, and ERR_NO is between 0 and
;                               127, then "ERROR" will be printed out, followed
;                               by the error number ERR_NO.
;
; FLAGS         $3C3E (15422)   1 byte. Shows the state of various parts of the
;                               system, each bit showing whether something
;                               particular is happening or not. Some of these
;                               may be useful.
;
;                               Bit 2, when 1, shows that there is an incomplete
;                               definition at the end of the dictionary.
;
;                               Bit 3, when 1, shows that output is to fed into
;                               the input buffer.
;
;                               Bit 4, when 1, shows that the Ace is in
;                               invisible mode.
;
;                               Bit 6, when 1, shows that the Ace is in compile
;                               mode.
;
; BASE          $3C3F (15423)   1 byte. The system number base.
;
;
;
; -----------------------------------------------------------------------------
;                                    ---------
;                                   -------------------------------------------
; ------------                     --------------------------------------------
; ACE KEYBOARD                    ---------
; ------------                   ---------
;
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;|   ! | |   @ | |   # | |   $ | |   % | |   &amp; | |   ' | |   ( | |   ) | |   _ |
;| 1 []| | 2 []| | 3 []| | 4 []| | 5 []| | 6 []| | 7 []| | 8   | | 9   | | 0 []|
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
; DELETE   CAPS            INV    &lt;=        ^       v        =&gt;  GRAPHIC  DELETE
;  LINE    LOCK           VIDEO
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;|     | |     | |     | |   &lt; | |   &gt; | |   [ | |   ] | |   © | |   ; | |   " |
;| Q   | | W   | | E   | | R   | | T   | | Y   | | U   | | I   | | O   | | P   |
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;|   ~ | |   | | |   \ | |   { | |   } | |   ^ | |   - | |   + | |   = | |     |
;| A   | | S   | | D   | | F   | | G   | | H   | | J   | | K   | | L   | |ENTER|
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;|     | |   : | |   £ | |   ? | |   / | |   * | |   , | |   . | | SYM | |     |
;|SHIFT| | Z   | | X   | | C   | | V   | | B   | | N   | | M   | |SHIFT| |SPACE|
;+-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
;
;
;                     [] mosaic graphic          £  currency symbol
;
; -----------------------------------------------------------------------------
</pre>





			</td>
		</tr>
	</tbody></table>



 <div class="line"></div>
 </div>
 </div>





</body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>